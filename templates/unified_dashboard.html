{% extends "base_layout.html" %}

{% block title %}Dashboard - Hybrid Trading Intelligence{% endblock %}
{% block page_title %}Trading Dashboard{% endblock %}
{% block page_subtitle %}Live portfolio monitoring and hybrid signal overview{% endblock %}
{% block extra_css %}
<style>
/* Dashboard-specific styles */
.portfolio-summary {
    background: linear-gradient(135deg, var(--accent-blue), var(--primary-dark));
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    border: 2px solid var(--border-color);
}

.summary-stat {
    text-align: center;
    padding: 15px;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 5px 0;
}

.stat-label {
    color: #adb5bd;
    font-size: 0.9rem;
    font-weight: 500;
}

.holdings-table {
    background: var(--primary-dark);
    border-radius: 10px;
    overflow: hidden;
}
</style>
{% endblock %}

{% block content %}

    <style>
    /* Enhanced responsive table styling and toast improvements */
    .table-v02 thead th { 
        background-color: var(--v02-head-bg, #343a40); 
        color:#fff; 
        position:sticky; 
        top:0; 
        z-index:1; 
    }
    .table-v02 tbody td.text-end, .table-v02 thead th.text-end { text-align:right; }
    .table-v02 tbody td.text-center, .table-v02 thead th.text-center { text-align:center; }
    .table-v02 tbody tr:nth-child(even){ background-color:#f8f9fa; }
    .table-v02 tbody tr:hover{ background-color:#e9ecef; }

    /* Mobile responsive table improvements */
    @media (max-width: 768px) {
      .table-responsive { 
        overflow-x:auto; 
        -webkit-overflow-scrolling:touch; 
      }
      .table-v02 thead { display:none; }
      .table-v02 tr { 
        display:block; 
        border:1px solid #e9ecef; 
        border-radius:.25rem; 
        margin-bottom:.75rem; 
      }
      .table-v02 td { 
        display:flex; 
        justify-content:space-between; 
        gap:.75rem; 
        padding:.5rem .75rem; 
      }
      .table-v02 td::before { 
        content: attr(data-label); 
        font-weight:600; 
        color:#6c757d; 
      }
    }

    /* Enhanced toast notifications */
    .toast-container { 
        position:fixed; 
        top:1rem; 
        right:1rem; 
        z-index:1080; 
    }
    .toast-message { 
        opacity:0; 
        transform:translateY(-10px); 
        transition:all .3s ease; 
        background:rgba(0,0,0,.85); 
        color:#fff; 
        padding:.75rem 1rem; 
        border-radius:.375rem; 
        margin-bottom:.5rem; 
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
        max-width: 350px;
        word-wrap: break-word;
    }
    .toast-message.show { 
        opacity:1; 
        transform:none; 
    }
    .toast-message.error { 
        background:rgba(220,53,69,.9); 
    }
    .toast-message.success { 
        background:rgba(25,135,84,.9); 
    }
    .toast-message.info { 
        background:rgba(13,110,253,.9); 
    }
    </style>

    <!-- Navigation Bar with Mobile Toggle -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#overview">
                <span class="icon icon-chart me-2"></span>Crypto Trading Dashboard
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="icon icon-menu"></span>
            </button>

            <div id="mainNav" class="collapse navbar-collapse">
                <div class="navbar-nav me-auto nav-pills-container d-flex">
                    <a class="nav-link active" href="#overview">
                        <span class="icon icon-dashboard me-1"></span>Overview
                    </a>
                    <a class="nav-link" href="#holdings">Holdings</a>
                    <a class="nav-link" href="#trades">Trades</a>
                </div>

                <div class="navbar-nav ms-auto">
                    <div id="status-badge" class="status-badge me-3" data-testid="status-okx">
                        <span class="dot dot-grey"></span>
                        <span class="label">Checking…</span>
                    </div>
                    <a class="btn btn-outline-primary btn-sm me-2" href="/system-test" target="_blank" rel="noopener">
                        <i class="fas fa-vial me-1"></i>System Test
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Control Bar -->
    <div class="control-bar border-bottom">
        <div class="container-fluid d-flex flex-wrap align-items-center gap-2 py-2">
            <div class="d-flex align-items-center gap-2">
                <label class="small muted mb-0">Currency</label>
                <select id="currency-selector" class="form-select form-select-sm">
                    <option value="USD" selected>USD</option>
                    <option value="AUD">AUD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>

            <div class="ms-auto d-flex flex-wrap gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btn-ato-export" aria-label="Export ATO tax data" title="Export your trading data for Australian Tax Office reporting">
                    <span class="icon icon-file me-1" aria-hidden="true"></span>ATO Export
                </button>
                <button class="btn btn-outline-warning btn-sm" id="btn-take-profit" aria-label="Execute take profit strategy" title="Automatically sell all positions with 2%+ profit and reinvest proceeds">
                    <span class="icon icon-dollar me-1" aria-hidden="true"></span>Take Profit
                </button>
                <button class="btn btn-success btn-sm" id="btn-buy" aria-label="Show buy order dialog" title="Place a manual buy order for any cryptocurrency">
                    <span class="icon icon-up me-1" aria-hidden="true"></span>Buy
                </button>
                <button class="btn btn-danger btn-sm" id="btn-sell" aria-label="Show sell order dialog" title="Place a manual sell order for any of your holdings">
                    <span class="icon icon-down me-1" aria-hidden="true"></span>Sell
                </button>
                <button class="btn btn-warning btn-sm" id="btn-bot-toggle" aria-label="Toggle trading bot" title="Start or stop the automated trading bot">
                    <span class="icon icon-robot me-1" aria-hidden="true"></span><span id="bot-status-top">START BOT</span>
                </button>
                <span id="trading-status" class="badge bg-secondary ms-2" aria-live="polite">
                    <span class="icon icon-circle me-1" aria-hidden="true"></span>Inactive
                </span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="container-fluid py-3">
        
        <!-- SECTION 1: OVERVIEW DASHBOARD -->
        <section id="overview" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><span class="icon icon-wallet me-2"></span>OKX Portfolio Overview</h2>
                <div class="d-flex align-items-center gap-2">
                    <span id="okx-account-level" class="badge bg-info">Standard</span>
                    <span class="badge bg-success" id="okx-connection-badge">
                        <span class="icon icon-wifi me-1"></span>
                        <span id="overview-connection">Connected</span>
                    </span>
                    <small class="text-muted">
                        Last Update: <span id="overview-last-update" aria-live="polite">—</span>
                    </small>
                </div>
            </div>

            <!-- Modern KPI Stat Strip -->
            <div class="stat-strip" id="top-kpis">
              <div class="kpi" id="kpi-equity" data-tone="primary">
                <div class="kpi__label">Equity</div>
                <div class="kpi__value" id="crypto-current-value" data-kpi-value>—</div>
                <div class="kpi__delta flat" data-kpi-delta>0.0%</div>
                <!-- tiny inline sparkline (optional) -->
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,12 20,10 40,14 60,9 80,13 100,8" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-upnl">
                <div class="kpi__label">Unrealised P&L</div>
                <div class="kpi__value" id="crypto-total-pnl" data-kpi-value>—</div>
                <div class="kpi__delta flat" id="crypto-pnl-percent" data-kpi-delta>0.0%</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,14 20,12 40,10 60,11 80,9 100,12" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-exposure">
                <div class="kpi__label">Holdings Count</div>
                <div class="kpi__value" id="crypto-total-count" data-kpi-value>—</div>
                <div class="kpi__delta flat" data-kpi-delta>Assets</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,16 20,15 40,14 60,15 80,16 100,15" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-cash">
                <div class="kpi__label">USDT (Tradable Balance)</div>
                <div class="kpi__value" data-kpi-value>—</div>
                <div class="kpi__delta flat" data-kpi-delta>0.0%</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,8 20,9 40,8 60,9 80,8 100,9" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>
            </div>


        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 2: OPEN POSITIONS -->
        <section id="holdings" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-coins me-2"></span>Open Positions</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="positions-last-update" aria-live="polite">—</span> | 
                        <span class="icon icon-timer me-1"></span>
                        Next refresh: <span id="positions-next-refresh" aria-live="polite">—</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table-v02 table-v02--compact" id="holdings-table" style="--v02-head-bg:#6c7ae0; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th class="table-sortable" data-sort="symbol" style="min-width: 60px;" title="Cryptocurrency ticker symbol">
                                        ASSET <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="balance" style="min-width: 70px;" title="Total quantity of tokens/coins held">
                                        QTY HELD <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="value" style="min-width: 60px;" title="Average price paid per token/coin">
                                        ENTRY PRICE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price" style="min-width: 70px;" title="Current live market price from OKX">
                                        CURRENT PRICE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="market_value" style="min-width: 80px;" title="Current total value at market price">
                                        POSITION VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_dollar" style="min-width: 60px;" title="Unrealized profit/loss in USD">
                                        UNREALIZED $ <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_percent" style="min-width: 60px;" title="Unrealized profit/loss as percentage">
                                        GAIN/LOSS % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="text-center" style="min-width: 60px;" title="Trading actions and position management">
                                        ACTIONS
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="holdings-tbody">
                                <tr>
                                    <td class="text-center py-3 text-muted" colspan="8">
                                        <span class="icon icon-refresh me-2"></span>Loading positions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 3: RECENT TRADES -->
        <section id="trades" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-history me-2"></span>Recent Trades</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="trades-last-update" aria-live="polite">—</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table-v02 table-v02--compact" id="trades-table" style="--v02-head-bg:#6c7ae0; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th style="min-width: 60px;">DATE</th>
                                    <th style="min-width: 50px;">ASSET</th>
                                    <th style="min-width: 50px;">SIDE</th>
                                    <th class="text-end" style="min-width: 70px;">QUANTITY</th>
                                    <th class="text-end" style="min-width: 70px;">PRICE</th>
                                    <th class="text-end" style="min-width: 80px;">VALUE</th>
                                    <th class="text-end" style="min-width: 50px;">FEE</th>
                                </tr>
                            </thead>
                            <tbody id="trades-tbody">
                                <tr>
                                    <td class="text-center py-3 text-muted" colspan="7">
                                        <span class="icon icon-refresh me-2"></span>Loading trades...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
/**
 * Pure orchestrator - no rendering, only API coordination and app_legacy.js handoff
 */
(function () {
  // --- Admin token handling ---
  let adminToken = localStorage.getItem('admin-token') || null;
  function getAdminToken() {
    if (!adminToken) {
      adminToken = prompt('Please enter admin token for bot control:');
      if (adminToken) localStorage.setItem('admin-token', adminToken);
    }
    return adminToken;
  }
  function clearAdminToken() {
    adminToken = null;
    localStorage.removeItem('admin-token');
  }

  // --- Initialize: orchestration only ---
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Minimal orchestrator initialized');
    
    // Trigger data loads (app_legacy.js will handle rendering)
    triggerDataRefresh();
    
    // Set up bot controls
    setupBotControls();
  });

  // --- Pure orchestration functions (no rendering) ---
  function triggerDataRefresh() {
    // Just trigger the data loads - let app_legacy.js do all rendering
    if (window.TradingApp) {
      console.log('🔄 Handing off to TradingApp for data refresh');
      if (window.TradingApp.refreshAllData) {
        window.TradingApp.refreshAllData();
      }
    } else {
      // Fallback: basic API calls without rendering
      fetch('/api/portfolio-overview?currency=USD').catch(() => {});
      fetch('/api/crypto-portfolio?currency=USD').catch(() => {});
      fetch('/api/comprehensive-trades').catch(() => {});
    }
  }

  function setupBotControls() {
    // Bot control handlers
    document.querySelectorAll('[id^="btn-bot"]').forEach(btn => {
      btn.addEventListener('click', async function() {
        const token = getAdminToken();
        if (!token) return;
        
        try {
          const response = await fetch('/api/bot/status', {
            method: 'POST',
            headers: { 'X-Admin-Token': token }
          });
          const result = await response.json();
          
          if (result.success && window.TradingApp && window.TradingApp.updateBotStatus) {
            window.TradingApp.updateBotStatus(result.status);
          }
        } catch (error) {
          console.error('Bot status check failed:', error);
        }
      });
    });
  }

  // --- Global utilities for app_legacy.js ---
  window.adminTokenManager = { getAdminToken, clearAdminToken };
  
  // Coin metadata helper (uses correct endpoint)
  window.getCoinMetadata = async function(symbol) {
    try {
      const response = await fetch(`/api/coin-metadata/${symbol}`);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error(`Coin metadata failed for ${symbol}:`, error);
    }
    return null;
  };

  // Sell position action (orchestration only)
  window.sellPosition = function(symbol) {
    if (!confirm(`Sell all ${symbol}?`)) return;
    
    if (window.TradingApp && window.TradingApp.sellPosition) {
      window.TradingApp.sellPosition(symbol);
    } else {
      console.log(`Sell ${symbol} triggered - no handler available`);
    }
  };

  console.log('🎯 Page orchestrator ready');
})();
    </script>

{% endblock %}