{% extends "base_layout.html" %}

{% block title %}Dashboard - Hybrid Trading Intelligence{% endblock %}
{% block page_title %}Trading Dashboard{% endblock %}
{% block page_subtitle %}Live portfolio monitoring and hybrid signal overview{% endblock %}
{% block extra_css %}
<style>
/* Dashboard-specific styles */
.portfolio-summary {
    background: linear-gradient(135deg, var(--accent-blue), var(--primary-dark));
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    border: 2px solid var(--border-color);
}

.summary-stat {
    text-align: center;
    padding: 15px;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 5px 0;
}

.stat-label {
    color: #adb5bd;
    font-size: 0.9rem;
    font-weight: 500;
}

.holdings-table {
    background: var(--primary-dark);
    border-radius: 10px;
    overflow: hidden;
}
</style>
{% endblock %}

{% block content %}

    <style>
    /* Enhanced responsive table styling and toast improvements */
    .table-v02 thead th { 
        background-color: var(--v02-head-bg, #343a40); 
        color:#fff; 
        position:sticky; 
        top:0; 
        z-index:1; 
    }
    .table-v02 tbody td.text-end, .table-v02 thead th.text-end { text-align:right; }
    .table-v02 tbody td.text-center, .table-v02 thead th.text-center { text-align:center; }
    .table-v02 tbody tr:nth-child(even){ background-color:#f8f9fa; }
    .table-v02 tbody tr:hover{ background-color:#e9ecef; }

    /* Mobile responsive table improvements */
    @media (max-width: 768px) {
      .table-responsive { 
        overflow-x:auto; 
        -webkit-overflow-scrolling:touch; 
      }
      .table-v02 thead { display:none; }
      .table-v02 tr { 
        display:block; 
        border:1px solid #e9ecef; 
        border-radius:.25rem; 
        margin-bottom:.75rem; 
      }
      .table-v02 td { 
        display:flex; 
        justify-content:space-between; 
        gap:.75rem; 
        padding:.5rem .75rem; 
      }
      .table-v02 td::before { 
        content: attr(data-label); 
        font-weight:600; 
        color:#6c757d; 
      }
    }

    /* Enhanced toast notifications */
    .toast-container { 
        position:fixed; 
        top:1rem; 
        right:1rem; 
        z-index:1080; 
    }
    .toast-message { 
        opacity:0; 
        transform:translateY(-10px); 
        transition:all .3s ease; 
        background:rgba(0,0,0,.85); 
        color:#fff; 
        padding:.75rem 1rem; 
        border-radius:.375rem; 
        margin-bottom:.5rem; 
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
        max-width: 350px;
        word-wrap: break-word;
    }
    .toast-message.show { 
        opacity:1; 
        transform:none; 
    }
    .toast-message.error { 
        background:rgba(220,53,69,.9); 
    }
    .toast-message.success { 
        background:rgba(25,135,84,.9); 
    }
    .toast-message.info { 
        background:rgba(13,110,253,.9); 
    }
    </style>
</head>
<body class="theme-min">
    <!-- Navigation Bar with Mobile Toggle -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#overview">
                <span class="icon icon-chart me-2"></span>Crypto Trading Dashboard
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="icon icon-menu"></span>
            </button>

            <div id="mainNav" class="collapse navbar-collapse">
                <div class="navbar-nav me-auto nav-pills-container d-flex">
                    <a class="nav-link active" href="#overview">
                        <span class="icon icon-dashboard me-1"></span>Overview
                    </a>
                    <a class="nav-link" href="#holdings">Holdings</a>
                    <a class="nav-link" href="#trades">Trades</a>
                </div>

                <div class="navbar-nav ms-auto">
                    <div id="status-badge" class="status-badge me-3" data-testid="status-okx">
                        <span class="dot dot-grey"></span>
                        <span class="label">Checking‚Ä¶</span>
                    </div>
                    <a class="btn btn-outline-primary btn-sm me-2" href="/system-test" target="_blank" rel="noopener">
                        <i class="fas fa-vial me-1"></i>System Test
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Control Bar -->
    <div class="control-bar border-bottom">
        <div class="container-fluid d-flex flex-wrap align-items-center gap-2 py-2">
            <div class="d-flex align-items-center gap-2">
                <label class="small muted mb-0">Currency</label>
                <select id="currency-selector" class="form-select form-select-sm">
                    <option value="USD" selected>USD</option>
                    <option value="AUD">AUD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>

            <div class="ms-auto d-flex flex-wrap gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btn-ato-export" aria-label="Export ATO tax data" title="Export your trading data for Australian Tax Office reporting">
                    <span class="icon icon-file me-1" aria-hidden="true"></span>ATO Export
                </button>
                <button class="btn btn-outline-warning btn-sm" id="btn-take-profit" aria-label="Execute take profit strategy" title="Automatically sell all positions with 2%+ profit and reinvest proceeds">
                    <span class="icon icon-dollar me-1" aria-hidden="true"></span>Take Profit
                </button>
                <button class="btn btn-success btn-sm" id="btn-buy" aria-label="Show buy order dialog" title="Place a manual buy order for any cryptocurrency">
                    <span class="icon icon-up me-1" aria-hidden="true"></span>Buy
                </button>
                <button class="btn btn-danger btn-sm" id="btn-sell" aria-label="Show sell order dialog" title="Place a manual sell order for any of your holdings">
                    <span class="icon icon-down me-1" aria-hidden="true"></span>Sell
                </button>
                <button class="btn btn-warning btn-sm" id="btn-bot-toggle" aria-label="Toggle trading bot" title="Start or stop the automated trading bot">
                    <span class="icon icon-robot me-1" aria-hidden="true"></span><span id="bot-status-top">START BOT</span>
                </button>
                <span id="trading-status" class="badge bg-secondary ms-2" aria-live="polite">
                    <span class="icon icon-circle me-1" aria-hidden="true"></span>Inactive
                </span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="container-fluid py-3">
        
        <!-- SECTION 1: OVERVIEW DASHBOARD -->
        <section id="overview" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><span class="icon icon-wallet me-2"></span>OKX Portfolio Overview</h2>
                <div class="d-flex align-items-center gap-2">
                    <span id="okx-account-level" class="badge bg-info">Standard</span>
                    <span class="badge bg-success" id="okx-connection-badge">
                        <span class="icon icon-wifi me-1"></span>
                        <span id="overview-connection">Connected</span>
                    </span>
                    <small class="text-muted">
                        Last Update: <span id="overview-last-update" aria-live="polite">‚Äî</span>
                    </small>
                </div>
            </div>

            <!-- Modern KPI Stat Strip -->
            <div class="stat-strip" id="top-kpis">
              <div class="kpi" id="kpi-equity" data-tone="primary">
                <div class="kpi__label">Equity</div>
                <div class="kpi__value" id="crypto-current-value" data-kpi-value>‚Äî</div>
                <div class="kpi__delta flat" data-kpi-delta>0.0%</div>
                <!-- tiny inline sparkline (optional) -->
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,12 20,10 40,14 60,9 80,13 100,8" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-upnl">
                <div class="kpi__label">Unrealised P&L</div>
                <div class="kpi__value" id="crypto-total-pnl" data-kpi-value>‚Äî</div>
                <div class="kpi__delta flat" id="crypto-pnl-percent" data-kpi-delta>0.0%</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,14 20,12 40,10 60,11 80,9 100,12" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-exposure">
                <div class="kpi__label">Holdings Count</div>
                <div class="kpi__value" id="crypto-total-count" data-kpi-value>‚Äî</div>
                <div class="kpi__delta flat" data-kpi-delta>Assets</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,16 20,15 40,14 60,15 80,16 100,15" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>

              <div class="kpi" id="kpi-cash">
                <div class="kpi__label">USDT (Tradable Balance)</div>
                <div class="kpi__value" data-kpi-value>‚Äî</div>
                <div class="kpi__delta flat" data-kpi-delta>0.0%</div>
                <svg class="kpi__spark" viewBox="0 0 100 24" preserveAspectRatio="none" aria-hidden="true">
                  <polyline points="0,8 20,9 40,8 60,9 80,8 100,9" fill="none" stroke="currentColor" stroke-width="2" opacity=".6"/>
                </svg>
              </div>
            </div>


        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 2: OPEN POSITIONS -->
        <section id="holdings" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-coins me-2"></span>Open Positions</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="positions-last-update" aria-live="polite">‚Äî</span> | 
                        <span class="icon icon-timer me-1"></span>
                        Next refresh: <span id="positions-next-refresh" aria-live="polite">‚Äî</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table-v02 table-v02--compact" id="holdings-table" style="--v02-head-bg:#6c7ae0; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th class="table-sortable" data-sort="symbol" style="min-width: 60px;" title="Cryptocurrency ticker symbol">
                                        ASSET <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="balance" style="min-width: 70px;" title="Total quantity of tokens/coins held">
                                        QTY HELD <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="value" style="min-width: 60px;" title="Average price paid per token/coin">
                                        ENTRY PRICE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price" style="min-width: 70px;" title="Current live market price from OKX">
                                        CURRENT PRICE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="market_value" style="min-width: 80px;" title="Current total value at market price">
                                        VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_dollar" style="min-width: 60px;" title="Unrealized profit/loss in USD">
                                        UNREALIZED $ <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_percent" style="min-width: 60px;" title="Unrealized profit/loss as percentage">
                                        GAIN/LOSS % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_value" style="min-width: 80px;" title="Expected value at Enhanced Bollinger Bands target (Bollinger Upper Band ‚Üí 4% ‚Üí 6% safety net)">
                                        TARGET VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_pnl_dollar" style="min-width: 70px;" title="Expected profit using Enhanced Bollinger Bands strategy targets">
                                        TARGET PROFIT $ <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_pnl_percent" style="min-width: 70px;" title="Target profit percentage (Bollinger Bands ‚Üí 4% strategy ‚Üí 6% safety)">
                                        TARGET PROFIT % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="position_status" style="min-width: 60px;" title="Position Status: MANAGED (actively managed by bot), LONG (holding position), FLAT (no position)">
                                        STATUS <span class="icon icon-sort text-muted"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="holdings-tbody">
                                <tr>
                                    <td colspan="11" class="text-center py-4">
                                        <div class="card" style="border: 1px solid #e5e7eb; max-width: 500px; margin: 0 auto;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-chart-line me-2 text-primary"></i>Open Positions Progress
                                                    </h6>
                                                    <small class="text-muted" id="holdings-progress-status">Loading...</small>
                                                </div>
                                                <div class="progress mb-2" style="height: 12px;">
                                                    <div id="holdings-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                        <span id="holdings-progress-text">0%</span>
                                                    </div>
                                                </div>
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Current Step</small>
                                                        <span id="holdings-current-step" class="fw-bold text-primary">Initializing...</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Processed</small>
                                                        <span id="holdings-processed-count" class="fw-bold text-success">0</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Elapsed</small>
                                                        <span id="holdings-elapsed-time" class="fw-bold text-info">0s</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 3: AVAILABLE POSITIONS -->
        <section id="available-positions" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-wallet me-2"></span>Available Positions</h3>
                    <div class="d-flex align-items-center">
                        <div class="meta me-3">
                            <span class="icon icon-clock me-1"></span>
                            Last updated: <span id="available-last-update" aria-live="polite">‚Äî</span> | 
                            <span class="icon icon-timer me-1"></span>
                            Next refresh: <span id="available-next-refresh" aria-live="polite">‚Äî</span>
                        </div>
                        <button id="recalculate-btn" class="btn btn-outline-primary btn-sm" 
                                onclick="recalculatePositions()" 
                                title="Force recalculation of all positions with fresh market data">
                            <i class="fas fa-calculator me-1"></i>Recalculate
                        </button>
                    </div>
                    <!-- Filter Row -->
                    <div class="row mt-3 align-items-center">
                        <div class="col-md-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="position-filter" 
                                       class="form-control" 
                                       placeholder="Search symbol..."
                                       onkeyup="filterAvailablePositions()">
                                <button class="btn btn-outline-secondary" 
                                        id="clear-filter-btn" 
                                        onclick="clearPositionFilter()" 
                                        style="display: none;"
                                        title="Clear filter">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select id="balance-filter" class="form-select form-select-sm" onchange="filterAvailablePositions()">
                                <option value="">All Positions</option>
                                <option value="with-balance">With Balance Only</option>
                                <option value="zero-balance">Zero Balance Only</option>
                                <option value="buyback-candidates">üí∞ Buy-Back Candidates (Under $100)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="bot-criteria-filter" class="form-select form-select-sm" onchange="filterAvailablePositions()">
                                <option value="">All Criteria</option>
                                <optgroup label="ML-Enhanced Analysis">
                                    <option value="ml-excellent">üéØ ML Excellent (80%+)</option>
                                    <option value="ml-strong">üöÄ ML Strong (65-79%)</option>
                                    <option value="ml-good">üìà ML Good (55-64%)</option>
                                    <option value="ml-weak">‚ö° ML Weak (40-54%)</option>
                                    <option value="ml-avoid">‚ùå ML Avoid (<40%)</option>
                                </optgroup>
                                <optgroup label="ML Trading Signals">
                                    <option value="ml-buy-signal">üìä ML BUY Signal</option>
                                    <option value="ml-wait-signal">‚è∏Ô∏è ML WAIT Signal</option>
                                    <option value="ml-monitoring">üëÅÔ∏è ML Monitoring</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">
                                Showing <span id="filtered-count">0</span> of <span id="total-count">0</span> positions
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table-v02 table-v02--compact" id="available-table" style="--v02-head-bg:#1f9d55;">
                            <thead>
                                <tr>
                                    <th class="table-sortable" data-sort="symbol" onclick="sortAvailableTable(0)">
                                        Symbol <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="current_balance" onclick="sortAvailableTable(1)">
                                        Balance <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="current_price" onclick="sortAvailableTable(2)">
                                        Price <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_buy_price" onclick="sortAvailableTable(3)"
                                        title="Target Buy Price: Calculated using tier-based discounting from current market price. Prices lock for 24 hours to prevent constant recalculation and ensure executable orders.">
                                        <i class="fas fa-crosshairs me-1 text-success"></i>Target <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price_difference" onclick="sortAvailableTable(4)"
                                        title="Price Difference: Shows how far current price is from target buy price. Negative values (green) mean price is below target = good buy opportunity.">
                                        <i class="fas fa-percentage me-1 text-info"></i>Diff % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="entry_confidence.score" onclick="sortAvailableTable(5)"
                                        title="ML-Enhanced Confidence: Advanced AI-powered analysis combining 6-factor technical indicators with machine learning predictions. Score ranges 0-100% with ML enhancement boost. 85%+ = BOT WILL BUY, 75-84% = STRONG BUY SETUP, 65-74% = GOOD ENTRY, 55-64% = FAIR OPPORTUNITY.">
                                        <i class="fas fa-brain me-1 text-warning"></i>ML Confidence <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="entry_confidence.timing_signal" onclick="sortAvailableTable(6)"
                                        title="AI-Enhanced Timing: Combines 6-factor technical analysis with ML prediction models. BUY = AI confirms favorable setup, WAIT = mixed signals, AVOID = AI suggests poor timing. Uses RSI, Bollinger, volume, momentum, volatility analysis + ML profitability prediction.">
                                        <i class="fas fa-robot me-1 text-primary"></i>AI Timing <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="entry_confidence.risk_level" onclick="sortAvailableTable(7)"
                                        title="Risk Assessment: Estimated risk level for this entry. LOW = stable/safer entry, MODERATE = balanced risk/reward, HIGH = volatile/riskier entry. Consider your risk tolerance.">
                                        <i class="fas fa-shield-alt me-1 text-danger"></i>Risk <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="buy_signal" onclick="sortAvailableTable(8)"
                                        title="ML-Enhanced Bot Decision: Advanced AI-powered buy criteria combining traditional technical analysis with machine learning predictions. BOT WILL BUY = ML+Technical consensus, STRONG BUY SETUP = High ML confidence, GOOD ENTRY = Favorable ML prediction, MONITORING = Under ML evaluation.">
                                        <i class="fas fa-brain me-1 text-success"></i>ML Bot Decision <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="text-center">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="available-tbody">
                                <tr>
                                    <td colspan="10" class="text-center py-4">
                                        <div class="card" style="border: 1px solid #e5e7eb; max-width: 500px; margin: 0 auto;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-wallet me-2 text-primary"></i>Available Positions Progress
                                                    </h6>
                                                    <small class="text-muted" id="available-progress-status">Loading...</small>
                                                </div>
                                                <div class="progress mb-2" style="height: 12px;">
                                                    <div id="available-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                        <span id="available-progress-text">0%</span>
                                                    </div>
                                                </div>
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Current Step</small>
                                                        <span id="available-current-step" class="fw-bold text-primary">Initializing...</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Processed</small>
                                                        <span id="available-processed-count" class="fw-bold text-success">0</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Elapsed</small>
                                                        <span id="available-elapsed-time" class="fw-bold text-info">0s</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: TRADE HISTORY -->
        <section id="trades" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-history me-2"></span>Trade History</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="trades-last-updated">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                <select id="trades-days-filter" class="form-select">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-list"></i></span>
                                <select id="trades-limit-filter" class="form-select">
                                    <option value="50">Show 50</option>
                                    <option value="100" selected>Show 100</option>
                                    <option value="250">Show 250</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="refresh-trades" class="btn btn-outline-primary">
                                <i class="fas fa-sync"></i> Refresh Trades
                            </button>
                        </div>
                    </div>
                    
                    <!-- Trade Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary mb-1">Total Trades</h5>
                                    <h3 id="trades-total-count" class="mb-0">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-info mb-1">Total Volume</h5>
                                    <h3 id="trades-total-volume" class="mb-0">$-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-warning mb-1">Total Fees</h5>
                                    <h3 id="trades-total-fees" class="mb-0">$-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-secondary mb-1">Data Source</h5>
                                    <h6 id="trades-data-source" class="mb-0 text-muted">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-v02 table-hover">
                            <thead>
                                <tr>
                                    <th class="table-sortable" data-sort="timestamp">Date <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable" data-sort="symbol_clean">Symbol <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable text-center" data-sort="side">Side <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable text-end" data-sort="fillSz">Amount <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable text-end" data-sort="fillPx">Price <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable text-end" data-sort="trade_value_usd">Value <span class="icon icon-sort text-muted"></span></th>
                                    <th class="table-sortable text-end" data-sort="net_pnl">P&L <span class="icon icon-sort text-muted"></span></th>
                                    <th class="text-center">Source</th>
                                </tr>
                            </thead>
                            <tbody id="trades-tbody">
                                <tr id="trades-loading-row">
                                    <td colspan="8" class="py-3">
                                        <div class="bg-light rounded p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-chart-line me-2 text-primary"></i>Trade History Progress
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted" id="trades-progress-status">Loading...</small>
                                                </div>
                                            </div>
                                            <div class="row text-center mb-2 small text-muted">
                                                <div class="col-4 text-start">
                                                    <span>Current Step:</span><br>
                                                    <span class="text-primary fw-bold" id="trades-current-step">Initializing...</span>
                                                </div>
                                                <div class="col-4">
                                                    <span>Processed</span><br>
                                                    <span class="fw-bold" id="trades-processed">0</span>
                                                </div>
                                                <div class="col-4 text-end">
                                                    <span>Elapsed</span><br>
                                                    <span class="fw-bold" id="trades-elapsed">0s</span>
                                                </div>
                                            </div>
                                            <div class="progress mb-2" style="height: 12px;">
                                                <div id="trades-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <span id="trades-progress-text">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>


    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-3 mt-5">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><small><strong>System Status & Info</strong></small></p>
                    <p class="mb-1 text-xs">
                        <span class="icon icon-server me-1"></span>
                        App Run Time: <span id="footer-system-uptime">0s</span> |
                        <span class="icon icon-exchange me-1"></span>
                        OKX: <span id="footer-okx-status">Connected</span> |
                        <span class="icon icon-code me-1"></span>
                        Version: {{ version|default('dev') }}
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-1"><small><strong>Legal & Risk Notice</strong></small></p>
                    <p class="mb-0 text-xs">
                        <strong>Disclaimer:</strong> High-risk trading platform for informational purposes.
                    </p>
                </div>
            </div>
        </div>
    </footer>

<!-- Bootstrap (load first) -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<!-- Bootstrap (load first) -->
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Cache-busted custom JS (main renderer owns table updates) -->
<script defer src="{{ url_for('static', filename='app_legacy.js') }}?v={{ cache_version|default(0) }}"></script>
<script defer src="{{ url_for('static', filename='filter_positions.js') }}?v={{ cache_version|default(0) }}"></script>

<script>
/**
 * Minimal page orchestrator.
 * Why: Prevents conflicts with app_legacy.js renderers while wiring the new API routes.
 */

(function () {
  // --- Admin token handling (unchanged) ---
  let adminToken = localStorage.getItem('admin-token') || null;
  function getAdminToken() {
    if (!adminToken) {
      adminToken = prompt('Please enter admin token for bot control:');
      if (adminToken) localStorage.setItem('admin-token', adminToken);
    }
    return adminToken;
  }
  function clearAdminToken() {
    adminToken = null;
    localStorage.removeItem('admin-token');
  }

  // --- Small helpers ---
  const qs  = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
  const setText = (sel, val) => { const el = qs(sel); if (el) el.textContent = val; };

  async function fetchJSON(url, opts = {}) {
    const res = await fetch(url, { cache: 'no-store', ...opts });
    if (!res.ok) throw new Error(`${url} -> ${res.status}`);
    return res.json();
  }

  // --- New API endpoints (server-backed) ---
  // overview numbers (currency, totals, pnl, timings)
  async function loadOverview() {
    try {
      const data = await fetchJSON('/api/portfolio-overview'); // live overview
      const ov = data?.overview || {};
      setText('#overview-last-update', ov.last_update || new Date().toLocaleTimeString());
      // Ex: populate some obvious counters if present
      setText('#total-assets',       ov.total_assets ?? '0');
      setText('#profitable-assets',  ov.profitable_positions ?? '0');
      setText('#losing-assets',      ov.losing_positions ?? '0');
      // let app_legacy.js own complex DOM rendering; this only preps basic stats
    } catch (e) {
      console.warn('loadOverview failed', e);
    }
  }

  // holdings & available positions (OKX live)
  async function loadPortfolio() {
    try {
      // Respect currency selector if present
      const sel = qs('#currency-selector');
      const currency = sel ? sel.value : 'USD';
      const url = `/api/crypto-portfolio?currency=${encodeURIComponent(currency)}`;
      const data = await fetchJSON(url);
      // hand off to app_legacy.js if available
      if (window.tradingApp?.updateCryptoPortfolioDOM) {
        window.tradingApp.updateCryptoPortfolioDOM(data);
      }
      // timing labels
      setText('#positions-last-update', new Date().toLocaleTimeString());
      setText('#available-last-update', new Date().toLocaleTimeString());
    } catch (e) {
      console.warn('loadPortfolio failed', e);
    }
  }

  // trade fills (prefer comprehensive, fallback to trade-history)
  async function loadTrades() {
    const tryEndpoints = ['/api/comprehensive-trades', '/api/trade-history?timeframe=7d&limit=100'];
    let payload = null, used = null;
    for (const ep of tryEndpoints) {
      try {
        payload = await fetchJSON(ep);
        used = ep;
        break;
      } catch (e) { /* try next */ }
    }
    if (!payload) {
      console.warn('No trades from either endpoint');
      return;
    }
    // hand off to app_legacy.js
    if (window.tradingApp?.updateTradesDOM) {
      window.tradingApp.updateTradesDOM(payload);
    }
    setText('#trades-last-updated', new Date().toLocaleTimeString());
    console.log('Trades loaded via', used);
  }

  // coin icon/color (call per visible row; example utility for app_legacy.js)
  window.getCoinMeta = async function(symbol) {
    try {
      return await fetchJSON(`/api/coin-metadata/${encodeURIComponent(symbol)}`);
    } catch {
      return { icon: 'fa-solid fa-coins', name: symbol, color: 'hsl(210,60%,50%)', type: 'font', source: 'fallback' };
    }
  };

  // currency switching -> hard refresh portfolio
  function initCurrencyChange() {
    const sel = qs('#currency-selector');
    if (!sel) return;
    sel.addEventListener('change', () => {
      localStorage.removeItem('portfolioData'); // clear any client cache
      loadPortfolio();
    });
  }

  // bot toggle (kept ‚Äì uses /api/bot/status + /api/bot/start/stop)
  async function toggleBot() {
    const btn = qs('#bot-status-top');
    if (!btn) return;
    const old = btn.textContent;
    try {
      const st = await fetchJSON('/api/bot/status');
      const running = !!st.running;
      btn.textContent = running ? 'START BOT' : 'STOP BOT';
      const endpoint = running ? '/api/bot/stop' : '/api/bot/start';
      const headers = { 'Content-Type': 'application/json' };
      const token = getAdminToken();
      if (token) headers['X-Admin-Token'] = token;

      const body = running ? null : JSON.stringify({ mode: 'live', strategy: 'enhanced_bollinger' });
      const res = await fetch(endpoint, { method: 'POST', headers, body });
      if (res.status === 401) {
        clearAdminToken();
        btn.textContent = old;
        alert('Invalid admin token.');
      }
    } catch (e) {
      btn.textContent = old;
      console.warn('toggleBot failed', e);
    }
  }
  window.toggleBot = toggleBot;

  // Init: only orchestrate; renderers live in app_legacy.js
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM ready, Bootstrap:', !!window.bootstrap, 'Chart.js:', !!window.Chart);
    initCurrencyChange();
    loadOverview();
    loadPortfolio();
    loadTrades();

    // periodic refresh (align with server refresh hints, default every 6s)
    setInterval(loadOverview, 6000);
    setInterval(loadPortfolio, 6000);
    setInterval(loadTrades,    15000);
  });
})();
</script>

{% endblock %}