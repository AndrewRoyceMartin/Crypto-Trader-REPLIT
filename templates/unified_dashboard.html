<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard - Unified View</title>
    
    <!-- Performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- FontAwesome (optional) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- System fonts for reliability -->
    <style>
        :root {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        

        .kpi-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            height: 100%;
            position: relative;
            min-height: 120px;
            transition: all 0.3s ease;
        }
        .kpi-card .label { font-size: 12px; color: #6c757d; }
        .kpi-card .value { font-size: 20px; font-weight: 600; margin-top: 2px; }
        .kpi-card .change-indicator { font-size: 12px; margin-top: 4px; }
        
        /* View Toggle Button */
        .view-toggle-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .view-toggle-btn:hover {
            background: rgba(0,0,0,0.2);
            color: #000;
        }
        
        /* Different Card View Styles */
        .kpi-card.view-text { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
        .kpi-card.view-graph { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
        .kpi-card.view-detailed { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); }
        .kpi-card.view-compact { background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); }
        
        /* Content visibility for different views */
        .kpi-card .view-content { display: none; }
        .kpi-card .view-content.active { display: block; }
        
        /* Graph view specific styles */
        .view-graph .mini-chart-container {
            height: 60px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Detailed view styles */
        .view-detailed .detailed-stats {
            font-size: 10px;
            margin-top: 8px;
        }
        .view-detailed .detailed-stats .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        
        /* Compact view styles */
        .view-compact .compact-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }
        .view-compact .compact-value {
            font-size: 16px;
            font-weight: 600;
        }

        .card--hover { border: 1px solid #e9ecef; border-radius: 8px; }
        .card--hover:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.06); transition: box-shadow .2s ease; }
        .card-header { background: #fff; border-bottom: 1px solid #e9ecef; display:flex; justify-content: space-between; align-items:center; }
        .card-header .meta { color:#6c757d; font-size: 12px; }

        .table-sm th, .table-sm td { white-space: nowrap; }
        .table-sortable { cursor: pointer; user-select: none; }
        .muted { color: #6c757d; }

        .control-bar { position: sticky; top: 56px; background: #fff; z-index: 1010; }
        .text-xs { font-size: 12px; }
    </style>
    
    <!-- Minimal CSS (preload for performance) -->
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}" as="style">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Color scheme and theme -->
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#111315">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body class="theme-min">
    <!-- Navigation Bar with Mobile Toggle -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#overview">
                <span class="icon icon-chart me-2"></span>Crypto Trading Dashboard
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="icon icon-menu"></span>
            </button>

            <div id="mainNav" class="collapse navbar-collapse">
                <div class="navbar-nav me-auto nav-pills-container d-flex">
                    <a class="nav-link active" href="#overview">
                        <span class="icon icon-dashboard me-1"></span>Overview
                    </a>
                    <a class="nav-link" href="#holdings">Holdings</a>
                    <a class="nav-link" href="#trades">Trades</a>
                </div>

                <div class="navbar-nav ms-auto">
                    <a class="btn btn-outline-secondary btn-sm me-2" href="{{ url_for('test_sync_data') }}" target="_blank" rel="noopener">Sync Test</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Control Bar -->
    <div class="control-bar border-bottom">
        <div class="container-fluid d-flex flex-wrap align-items-center gap-2 py-2">
            <div class="d-flex align-items-center gap-2">
                <label class="small muted mb-0">Currency</label>
                <select id="currency-selector" class="form-select form-select-sm">
                    <option value="USD" selected>USD</option>
                    <option value="AUD">AUD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>

            <div class="ms-auto d-flex flex-wrap gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btn-ato-export" aria-label="Export ATO tax data" title="Export your trading data for Australian Tax Office reporting">
                    <span class="icon icon-file me-1" aria-hidden="true"></span>ATO Export
                </button>
                <button class="btn btn-outline-warning btn-sm" id="btn-take-profit" aria-label="Execute take profit strategy" title="Automatically sell all positions with 2%+ profit and reinvest proceeds">
                    <span class="icon icon-dollar me-1" aria-hidden="true"></span>Take Profit
                </button>
                <button class="btn btn-success btn-sm" id="btn-buy" aria-label="Show buy order dialog" title="Place a manual buy order for any cryptocurrency">
                    <span class="icon icon-up me-1" aria-hidden="true"></span>Buy
                </button>
                <button class="btn btn-danger btn-sm" id="btn-sell" aria-label="Show sell order dialog" title="Place a manual sell order for any of your holdings">
                    <span class="icon icon-down me-1" aria-hidden="true"></span>Sell
                </button>
                <button class="btn btn-warning btn-sm" id="btn-bot-toggle" aria-label="Toggle trading bot" title="Start or stop the automated trading bot">
                    <span class="icon icon-robot me-1" aria-hidden="true"></span><span id="bot-status-top">START BOT</span>
                </button>
                <span id="trading-status" class="badge bg-secondary ms-2" aria-live="polite">
                    <span class="icon icon-circle me-1" aria-hidden="true"></span>Inactive
                </span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="container-fluid py-3">
        
        <!-- SECTION 1: OVERVIEW DASHBOARD -->
        <section id="overview" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><span class="icon icon-wallet me-2"></span>OKX Portfolio Overview</h2>
                <div class="d-flex align-items-center gap-2">
                    <span id="okx-account-level" class="badge bg-info">Standard</span>
                    <span class="badge bg-success" id="okx-connection-badge">
                        <span class="icon icon-wifi me-1"></span>
                        <span id="overview-connection">Connected</span>
                    </span>
                    <small class="text-muted">
                        Last Update: <span id="overview-last-update">—</span>
                    </small>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row text-center mb-4 g-2">
                <div class="col-6 col-md-2">
                    <div class="portfolio-card kpi-card view-text" data-card="portfolio-graph">
                        <button class="view-toggle-btn" onclick="toggleCardView('portfolio-graph')" title="Switch view">
                            <i class="fa-solid fa-chart-area"></i>
                        </button>
                        
                        <!-- Graph View -->
                        <div class="view-content view-text-content active">
                            <div class="title">
                                <span><i class="fa-solid fa-chart-area"></i></span>
                                <div class="title-text">Portfolio Timeline</div>
                                <div class="percent" id="portfolio-growth-percent">0%</div>
                            </div>
                            <div class="data">
                                <div class="mini-chart-container" style="height: 80px; margin: 0.5rem 0;">
                                    <canvas id="portfolio-timeline-chart" width="280" height="80"></canvas>
                                </div>
                                <div id="portfolio-current-value" class="value" style="font-size: 1.5rem; margin-top: 0.5rem;">$0.00</div>
                            </div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="title">
                                <span><i class="fa-solid fa-chart-line"></i></span>
                                <div class="title-text">Portfolio Details</div>
                                <div class="percent" id="portfolio-detail-percent">0%</div>
                            </div>
                            <div class="data">
                                <div id="portfolio-detailed-value" class="value">$0.00</div>
                                <div class="detailed-stats">
                                    <div class="stat-item"><span>7d Change:</span><span id="portfolio-7d">0%</span></div>
                                    <div class="stat-item"><span>30d Change:</span><span id="portfolio-30d">0%</span></div>
                                    <div class="stat-item"><span>All Time:</span><span id="portfolio-all-time">0%</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="portfolio-compact-value">$0.00</div>
                                <i class="fa-solid fa-chart-area text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="portfolio-card kpi-card view-text" data-card="estimated-total">
                        <button class="view-toggle-btn" onclick="toggleCardView('estimated-total')" title="Switch view">
                            <i class="fa-solid fa-chart-line"></i>
                        </button>
                        
                        <!-- Text View -->
                        <div class="view-content view-text-content active">
                            <div class="title">
                                <span><i class="fa-solid fa-chart-pie"></i></span>
                                <div class="title-text">Portfolio Value</div>
                                <div class="percent" id="portfolio-percent">0%</div>
                            </div>
                            <div class="data">
                                <div id="okx-estimated-total" class="value">$0.00</div>
                                <div class="range">
                                    <div class="fill" id="portfolio-fill" style="width: 65%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div class="view-content view-graph-content">
                            <div class="label">Portfolio Growth</div>
                            <div class="mini-chart-container">
                                <canvas id="portfolio-growth-chart" width="100" height="50"></canvas>
                            </div>
                            <div id="okx-estimated-total-graph" class="value small">$0.00</div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="label">Portfolio Breakdown</div>
                            <div id="okx-estimated-total-detailed" class="value">$0.00</div>
                            <div class="detailed-stats">
                                <div class="stat-item"><span>Crypto:</span><span id="portfolio-crypto">$0.00</span></div>
                                <div class="stat-item"><span>Fiat:</span><span id="portfolio-fiat">$0.00</span></div>
                                <div class="stat-item"><span>Profit/Loss:</span><span id="portfolio-pnl">$0.00</span></div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="okx-estimated-total-compact">$0.00</div>
                                <i class="fa-solid fa-chart-pie text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="portfolio-card kpi-card view-text" data-card="day-pnl">
                        <button class="view-toggle-btn" onclick="toggleCardView('day-pnl')" title="Switch view">
                            <i class="fa-solid fa-trending-up"></i>
                        </button>
                        
                        <!-- Text View -->
                        <div class="view-content view-text-content active">
                            <div class="title">
                                <span><i class="fa-solid fa-chart-line"></i></span>
                                <div class="title-text">24h P&L</div>
                                <div class="percent" id="day-pnl-percent">0%</div>
                            </div>
                            <div class="data">
                                <div id="okx-day-pnl" class="value">$0.00</div>
                                <div class="range">
                                    <div class="fill" id="day-pnl-fill" style="width: 30%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div class="view-content view-graph-content">
                            <div class="label">Daily P&L Trend</div>
                            <div class="mini-chart-container">
                                <canvas id="daily-pnl-chart" width="100" height="50"></canvas>
                            </div>
                            <div id="okx-day-pnl-graph" class="value small">$0.00</div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="label">P&L Analysis</div>
                            <div id="okx-day-pnl-detailed" class="value">$0.00</div>
                            <div class="detailed-stats">
                                <div class="stat-item"><span>Realized:</span><span id="pnl-realized">$0.00</span></div>
                                <div class="stat-item"><span>Unrealized:</span><span id="pnl-unrealized">$0.00</span></div>
                                <div class="stat-item"><span>Best Asset:</span><span id="pnl-best">—</span></div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="okx-day-pnl-compact">$0.00</div>
                                <i class="fa-solid fa-arrow-trend-up text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="portfolio-card kpi-card view-text" data-card="best-performer">
                        <button class="view-toggle-btn" onclick="toggleCardView('best-performer')" title="Switch view">
                            <i class="fa-solid fa-trophy"></i>
                        </button>
                        
                        <!-- Text View -->
                        <div class="view-content view-text-content active">
                            <div class="title">
                                <span><i class="fa-solid fa-trophy"></i></span>
                                <div class="title-text">Best Performer</div>
                                <div class="percent" id="best-gain-percent">0%</div>
                            </div>
                            <div class="data">
                                <div id="okx-best-performer" class="value">—</div>
                                <div class="range">
                                    <div class="fill" id="best-performer-fill" style="width: 90%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div class="view-content view-graph-content">
                            <div class="label">Performance Chart</div>
                            <div class="mini-chart-container">
                                <canvas id="best-performer-chart" width="100" height="50"></canvas>
                            </div>
                            <div id="okx-best-performer-graph" class="value small">—</div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="label">Top Performers</div>
                            <div id="okx-best-performer-detailed" class="value">—</div>
                            <div class="detailed-stats">
                                <div class="stat-item"><span>1st:</span><span id="top-1st">—</span></div>
                                <div class="stat-item"><span>2nd:</span><span id="top-2nd">—</span></div>
                                <div class="stat-item"><span>3rd:</span><span id="top-3rd">—</span></div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="okx-best-performer-compact">—</div>
                                <i class="fa-solid fa-star text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="portfolio-card kpi-card view-text" data-card="active-positions">
                        <button class="view-toggle-btn" onclick="toggleCardView('active-positions')" title="Switch view">
                            <i class="fa-solid fa-coins"></i>
                        </button>
                        
                        <!-- Text View -->
                        <div class="view-content view-text-content active">
                            <div class="title">
                                <span><i class="fa-solid fa-coins"></i></span>
                                <div class="title-text">Active Positions</div>
                                <div class="percent" id="positions-percent">100%</div>
                            </div>
                            <div class="data">
                                <div id="okx-active-positions" class="value">0</div>
                                <div class="range">
                                    <div class="fill" id="positions-fill" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div class="view-content view-graph-content">
                            <div class="label">Position Distribution</div>
                            <div class="mini-chart-container">
                                <canvas id="active-positions-chart" width="100" height="50"></canvas>
                            </div>
                            <div id="okx-active-positions-graph" class="value small">0</div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="label">Position Breakdown</div>
                            <div id="okx-active-positions-detailed" class="value">0</div>
                            <div class="detailed-stats">
                                <div class="stat-item"><span>Crypto:</span><span id="positions-crypto">0</span></div>
                                <div class="stat-item"><span>Fiat:</span><span id="positions-fiat">0</span></div>
                                <div class="stat-item"><span>Total Value:</span><span id="positions-value">$0.00</span></div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="okx-active-positions-compact">0</div>
                                <i class="fa-solid fa-layer-group text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card view-text" data-card="position-status">
                        <button class="view-toggle-btn" onclick="toggleCardView('position-status')" title="Switch view">
                            <i class="fa-solid fa-chart-simple"></i>
                        </button>
                        
                        <!-- Text View -->
                        <div class="view-content view-text-content active">
                            <div class="label">
                                <span class="icon icon-positions me-1"></span>Position Status
                            </div>
                            <div id="position-summary" class="value">—</div>
                            <div id="position-breakdown" class="change-indicator">
                                <span id="profitable-count" class="text-success">0 profitable</span> · 
                                <span id="losing-count" class="text-danger">0 losing</span>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div class="view-content view-graph-content">
                            <div class="label">Profit/Loss Chart</div>
                            <div class="mini-chart-container">
                                <canvas id="position-status-chart" width="100" height="50"></canvas>
                            </div>
                            <div id="position-summary-graph" class="value small">—</div>
                        </div>
                        
                        <!-- Detailed View -->
                        <div class="view-content view-detailed-content">
                            <div class="label">Status Details</div>
                            <div id="position-summary-detailed" class="value">—</div>
                            <div class="detailed-stats">
                                <div class="stat-item"><span>Profitable:</span><span id="profitable-detailed">0</span></div>
                                <div class="stat-item"><span>Break Even:</span><span id="breakeven-count">0</span></div>
                                <div class="stat-item"><span>Losing:</span><span id="losing-detailed">0</span></div>
                            </div>
                        </div>
                        
                        <!-- Compact View -->
                        <div class="view-content view-compact-content">
                            <div class="compact-layout">
                                <div class="compact-value" id="position-summary-compact">—</div>
                                <i class="fa-solid fa-scale-balanced text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 2: OPEN POSITIONS -->
        <section id="holdings" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-coins me-2"></span>Open Positions</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="positions-last-update">—</span> | 
                        <span class="icon icon-timer me-1"></span>
                        Next refresh: <span id="positions-next-refresh" aria-live="polite">—</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="holdings-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="table-sortable" data-sort="symbol">
                                        SYMBOL <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="balance">
                                        BALANCE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="value">
                                        VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="cost_basis">
                                        COST BASIS <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price">
                                        PRICE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="market_value">
                                        MARKET VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_dollar">
                                        P&L $ <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl_percent">
                                        P&L % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_value">
                                        TARGET VALUE <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_pnl_dollar">
                                        TARGET P&L $ <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_pnl_percent">
                                        TARGET P&L % <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="days">
                                        DAYS <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="text-center">
                                        ACTIONS
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="holdings-tbody">
                                <tr>
                                    <td colspan="13" class="text-center py-3 text-muted">
                                        <span class="icon icon-refresh me-2"></span>Loading positions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 3: AVAILABLE POSITIONS -->
        <section id="available-positions" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-wallet me-2"></span>Available Positions</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="available-last-update">—</span> | 
                        <span class="icon icon-timer me-1"></span>
                        Next refresh: <span id="available-next-refresh" aria-live="polite">—</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="available-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="table-sortable" data-sort="symbol">
                                        Symbol <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="current_price">
                                        Current Price <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="target_buy_price">
                                        Target Buy <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price_difference">
                                        Difference <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable" data-sort="buy_signal">
                                        Signal <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-center" data-sort="entry_confidence.timing_signal">
                                        Timing <span class="icon icon-sort text-muted"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="available-tbody">
                                <tr>
                                    <td colspan="6" class="text-center py-3 text-muted">
                                        <span class="icon icon-refresh me-2"></span>Loading available positions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 4: RECENT TRADES -->
        <section id="trades" class="mb-5">
            <div class="card card--hover">
                <div class="card-header">
                    <h3 class="mb-0"><span class="icon icon-exchange me-2"></span>Recent Trades</h3>
                    <div class="meta">
                        <span class="icon icon-clock me-1"></span>
                        Last 7 days
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="trades-table">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th class="table-sortable" data-sort="timestamp">
                                        Date <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable" data-sort="symbol">
                                        Symbol <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable" data-sort="side">
                                        Side <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="quantity">
                                        Quantity <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="price">
                                        Price <span class="icon icon-sort text-muted"></span>
                                    </th>
                                    <th class="table-sortable text-end" data-sort="pnl">
                                        P&L <span class="icon icon-sort text-muted"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="trades-tbody">
                                <tr>
                                    <td colspan="6" class="text-center py-3 text-muted">
                                        <span class="icon icon-refresh me-2"></span>Loading recent trades...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-3 mt-5">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><small><strong>System Status & Info</strong></small></p>
                    <p class="mb-1 text-xs">
                        <span class="icon icon-server me-1"></span>
                        App Run Time: <span id="footer-system-uptime">0s</span> |
                        <span class="icon icon-exchange me-1"></span>
                        OKX: <span id="footer-okx-status">Connected</span> |
                        <span class="icon icon-code me-1"></span>
                        Version: {{ version|default('dev') }}
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-1"><small><strong>Legal & Risk Notice</strong></small></p>
                    <p class="mb-0 text-xs">
                        <strong>Disclaimer:</strong> High-risk trading platform for informational purposes.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script defer src="{{ url_for('static', filename='app.js') }}?v={{ cache_version|default(0) }}"></script>

    <script>
    // === GLOBAL ADMIN TOKEN HANDLING ===
    let adminToken = localStorage.getItem('admin-token') || null;

    function getAdminToken() {
        if (!adminToken) {
            adminToken = prompt('Please enter admin token for bot control:');
            if (adminToken) {
                localStorage.setItem('admin-token', adminToken);
            }
        }
        return adminToken;
    }

    function clearAdminToken() {
        adminToken = null;
        localStorage.removeItem('admin-token');
    }

    // === CURRENCY SWITCHING ===
    function handleCurrencyChange() {
        const selector = document.getElementById('currency-selector');
        if (!selector) return;
        
        selector.addEventListener('change', function(e) {
            const newCurrency = e.target.value;
            console.log(`Currency changed to: ${newCurrency}. Clearing cache and fetching fresh OKX data...`);
            
            // Clear cache and force refresh
            localStorage.removeItem('portfolioData');
            
            // Trigger fresh data load
            if (window.tradingApp && typeof window.tradingApp.updateCryptoPortfolio === 'function') {
                window.tradingApp.updateCryptoPortfolio();
            }
        });
    }

    // === BOT CONTROL ===
    async function toggleBot() {
        try {
            // Get current bot status first
            const statusResponse = await fetch('/api/bot/status');
            const statusData = await statusResponse.json();
            
            const isCurrentlyRunning = statusData.running || false;
            const endpoint = isCurrentlyRunning ? '/api/bot/stop' : '/api/bot/start';
            const method = 'POST';
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add admin token if required
            const token = getAdminToken();
            if (token) {
                headers['X-Admin-Token'] = token;
            }
            
            const body = isCurrentlyRunning ? null : JSON.stringify({
                mode: 'live',
                strategy: 'enhanced_bollinger'
            });
            
            const response = await fetch(endpoint, {
                method: method,
                headers: headers,
                body: body
            });
            
            if (response.status === 401) {
                clearAdminToken();
                alert('Invalid admin token. Please try again.');
                return;
            }
            
            const data = await response.json();
            
            if (response.ok && (data.success !== false)) {
                // Update UI immediately
                updateBotStatusUI(!isCurrentlyRunning);
                
                const action = !isCurrentlyRunning ? 'started' : 'stopped';
                console.log(`Bot ${action}:`, data.message || data);
                
                // Refresh status after a short delay
                setTimeout(fetchAndUpdateBotStatus, 1000);
            } else {
                throw new Error(data.error || data.message || 'Unknown error');
            }
            
        } catch (error) {
            console.error('Bot toggle error:', error);
            alert(`Error toggling bot: ${error.message}`);
        }
    }

    function updateBotStatusUI(isRunning) {
        const button = document.getElementById('bot-status-top');
        const badge = document.getElementById('trading-status');
        
        if (button) {
            button.textContent = isRunning ? 'STOP BOT' : 'START BOT';
            button.parentElement.className = isRunning ? 
                'btn btn-danger btn-sm' : 'btn btn-warning btn-sm';
        }
        
        if (badge) {
            badge.innerHTML = `<i class="fa-solid fa-circle me-1" aria-hidden="true"></i>${isRunning ? 'Active' : 'Inactive'}`;
            badge.className = `badge ${isRunning ? 'bg-success' : 'bg-secondary'} ms-2`;
        }
    }

    async function fetchAndUpdateBotStatus() {
        try {
            const response = await fetch('/api/bot/status');
            const data = await response.json();
            updateBotStatusUI(data.running || false);
        } catch (error) {
            console.debug('Failed to fetch bot status:', error);
        }
    }

    // === FOOTER STATUS UPDATES ===
    async function updateFooterStatus() {
        try {
            // Update app uptime
            const statusResponse = await fetch('/api/status');
            const statusData = await statusResponse.json();
            
            const uptimeEl = document.getElementById('footer-system-uptime');
            if (uptimeEl && statusData.uptime_human) {
                uptimeEl.textContent = statusData.uptime_human;
            }
            
            // Update OKX status
            const okxResponse = await fetch('/api/okx-status');
            const okxData = await okxResponse.json();
            
            // Update footer OKX status
            const okxEl = document.getElementById('footer-okx-status');
            if (okxEl) {
                if (okxData.status && okxData.status.connected) {
                    okxEl.textContent = okxData.status.connection_type || 'Connected';
                    okxEl.className = 'text-success';
                } else {
                    okxEl.textContent = 'Disconnected';
                    okxEl.className = 'text-danger';
                }
            }
            
            // Update overview section OKX status
            const overviewConnectionEl = document.getElementById('overview-connection');
            const connectionBadgeEl = document.getElementById('okx-connection-badge');
            if (overviewConnectionEl && connectionBadgeEl) {
                if (okxData.status && okxData.status.connected) {
                    overviewConnectionEl.textContent = okxData.status.connection_type || 'Connected';
                    connectionBadgeEl.className = 'badge bg-success';
                } else {
                    overviewConnectionEl.textContent = 'Disconnected';
                    connectionBadgeEl.className = 'badge bg-danger';
                }
            }
            
        } catch (error) {
            console.debug('Footer status update failed:', error);
        }
    }

    // === TABLE SORTING ===
    function initTableSorting() {
        document.addEventListener('click', function(e) {
            if (e.target.closest('.table-sortable')) {
                const th = e.target.closest('.table-sortable');
                const table = th.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const index = Array.from(th.parentNode.children).indexOf(th);
                const sortKey = th.getAttribute('data-sort');
                
                if (rows.length <= 1) return; // Skip if no data or loading
                
                // Simple sort (ascending)
                rows.sort((a, b) => {
                    const aVal = a.children[index]?.textContent.trim() || '';
                    const bVal = b.children[index]?.textContent.trim() || '';
                    
                    // Try numeric sort first
                    const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
                    const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return aNum - bNum;
                    }
                    
                    // Fallback to string sort
                    return aVal.localeCompare(bVal);
                });
                
                // Re-append sorted rows
                rows.forEach(row => tbody.appendChild(row));
            }
        });
    }

    // === TIMING UPDATES ===
    function updateTimingDisplays() {
        // Update positions timing
        const positionsUpdate = document.getElementById('positions-last-update');
        const positionsNext = document.getElementById('positions-next-refresh');
        
        if (positionsUpdate) positionsUpdate.textContent = new Date().toLocaleTimeString();
        if (positionsNext) positionsNext.textContent = '5s';
        
        // Update available positions timing
        const availableUpdate = document.getElementById('available-last-update');
        const availableNext = document.getElementById('available-next-refresh');
        
        if (availableUpdate) availableUpdate.textContent = new Date().toLocaleTimeString();
        if (availableNext) availableNext.textContent = '5s';
        
        // Update overview timing
        const overviewUpdate = document.getElementById('overview-last-update');
        if (overviewUpdate) overviewUpdate.textContent = new Date().toLocaleTimeString();
    }

    // === TABLE RENDERERS ===
    function renderHoldingsTable(holdings) {
        // DISABLED: This function conflicts with the main JavaScript update
        // The main app.js updateAllTables() method handles all table updates
        console.log('renderHoldingsTable() disabled to prevent table flashing - using consolidated update instead');
        return;
        
        tbody.innerHTML = holdings.map(holding => {
            const pnlClass = (holding.pnl || 0) >= 0 ? 'text-success' : 'text-danger';
            const pnlSign = (holding.pnl || 0) >= 0 ? '+' : '';
            const symbol = holding.symbol || holding.name || 'N/A';
            
            // Get crypto icon
            const cryptoIcon = getCryptoIcon(symbol);
            
            // Calculate values
            const quantity = holding.quantity || holding.available_quantity || 0;
            const costBasis = holding.cost_basis || 0;
            const currentValue = holding.current_value || holding.value || 0;
            const currentPrice = holding.current_price || 0;
            const pnlDollar = holding.pnl || 0;
            const pnlPercent = holding.pnl_percent || 0;
            
            // Calculate target values (15% profit target)
            const profitTarget = 0.15; // 15% target
            const targetValue = costBasis * (1 + profitTarget);
            const targetPnlDollar = targetValue - costBasis;
            const targetPnlPercent = profitTarget * 100;
            
            // Calculate days (placeholder - would need real trade date)
            const days = '30 days';
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            ${cryptoIcon}
                            <strong class="ms-2">${symbol}</strong>
                        </div>
                    </td>
                    <td class="text-end">${quantity.toFixed(6)}</td>
                    <td class="text-end">$${currentValue.toFixed(6)}</td>
                    <td class="text-end">$${costBasis.toFixed(6)}</td>
                    <td class="text-end">$${currentPrice.toFixed(4)}</td>
                    <td class="text-end">$${currentValue.toFixed(6)}</td>
                    <td class="text-end ${pnlClass}">
                        ${pnlSign}$${Math.abs(pnlDollar).toFixed(6)}
                    </td>
                    <td class="text-end ${pnlClass}">
                        ${pnlSign}${Math.abs(pnlPercent).toFixed(2)}%
                    </td>
                    <td class="text-end">$${targetValue.toFixed(6)}</td>
                    <td class="text-end text-success">
                        +$${targetPnlDollar.toFixed(6)}
                    </td>
                    <td class="text-end text-success">
                        +${targetPnlPercent.toFixed(3)}%
                    </td>
                    <td class="text-center">${days}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-xs">25%</button>
                            <button class="btn btn-outline-primary btn-xs">50%</button>
                            <button class="btn btn-outline-primary btn-xs">All</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderAvailableTable(positions) {
        const tbody = document.getElementById('available-tbody');
        if (!tbody || !positions || positions.length === 0) {
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">No available positions</td></tr>';
            }
            return;
        }
        
        tbody.innerHTML = positions.slice(0, 50).map(pos => {
            const diffClass = (pos.price_difference || 0) < 0 ? 'text-success' : 'text-muted';
            const timingClass = 
                pos.entry_confidence?.timing_signal === 'BUY_NOW' ? 'badge bg-success' :
                pos.entry_confidence?.timing_signal === 'CAUTIOUS_BUY' ? 'badge bg-warning' :
                'badge bg-secondary';
                
            const symbol = pos.symbol || 'N/A';
            const cryptoIcon = getCryptoIcon(symbol);
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            ${cryptoIcon}
                            <strong class="ms-2">${symbol}</strong>
                        </div>
                    </td>
                    <td class="text-end">$${(pos.current_price || 0).toFixed(4)}</td>
                    <td class="text-end">$${(pos.target_buy_price || 0).toFixed(4)}</td>
                    <td class="text-end ${diffClass}">
                        ${(pos.price_difference || 0) < 0 ? '' : '+'}${(pos.price_difference || 0).toFixed(2)}%
                    </td>
                    <td>${pos.buy_signal || 'N/A'}</td>
                    <td class="text-center">
                        <span class="${timingClass}">
                            ${pos.entry_confidence?.timing_signal || 'WAIT'}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderTradesTable(trades) {
        const tbody = document.getElementById('trades-tbody');
        if (!tbody || !trades || trades.length === 0) {
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">No recent trades</td></tr>';
            }
            return;
        }
        
        tbody.innerHTML = trades.slice(0, 20).map(trade => {
            const pnlClass = (trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger';
            const pnlSign = (trade.pnl || 0) >= 0 ? '+' : '';
            const sideClass = trade.side === 'BUY' ? 'text-success' : 'text-danger';
            
            const date = trade.timestamp ? new Date(trade.timestamp).toLocaleDateString() : 'N/A';
            
            return `
                <tr>
                    <td class="text-white">${date}</td>
                    <td class="text-white"><strong>${trade.symbol || 'N/A'}</strong></td>
                    <td class="${sideClass}">${trade.side || 'N/A'}</td>
                    <td class="text-end">${(trade.quantity || 0).toFixed(6)}</td>
                    <td class="text-end">$${(trade.price || 0).toFixed(4)}</td>
                    <td class="text-end ${pnlClass}">
                        ${pnlSign}$${Math.abs(trade.pnl || 0).toFixed(2)}
                    </td>
                </tr>
            `;
        }).join('');
    }

    /** Modern icon mapping -> Font Awesome 6 (solid) **/
    const ICON_MAP = {
      'icon-dashboard': 'fa-gauge',
      'icon-chart': 'fa-chart-line',
      'icon-wallet': 'fa-wallet',
      'icon-coins': 'fa-coins',
      'icon-exchange': 'fa-arrow-right-arrow-left',
      'icon-refresh': 'fa-rotate',
      'icon-up': 'fa-arrow-trend-up',
      'icon-down': 'fa-arrow-trend-down',
      'icon-robot': 'fa-robot',
      'icon-shield': 'fa-shield-halved',
      'icon-wifi': 'fa-wifi',
      'icon-server': 'fa-server',
      'icon-file': 'fa-file-lines',
      'icon-dollar': 'fa-dollar-sign',
      'icon-percent': 'fa-percent',
      'icon-sort': 'fa-arrow-up-arrow-down',
      'icon-close': 'fa-xmark',
      'icon-trophy': 'fa-trophy',
      'icon-code': 'fa-code',
      'icon-menu': 'fa-bars',
      'icon-fire': 'fa-fire',
      'icon-balance': 'fa-scale-balanced',
      'icon-pnl': 'fa-chart-line',
      'icon-positions': 'fa-layer-group',
      'icon-tier': 'fa-gem',
      'icon-stop': 'fa-stop',
      'icon-circle': 'fa-circle',
      'icon-clock': 'fa-clock',
      'icon-timer': 'fa-hourglass-half'
    };

    /** Replace <span class="icon icon-XYZ ..."> with <i class="fa-solid fa-... ..."> */
    function upgradeIcons(root = document) {
      root.querySelectorAll('.icon').forEach(el => {
        const classes = Array.from(el.classList);
        const key = classes.find(c => c.startsWith('icon-') && c !== 'icon');
        if (!key || !ICON_MAP[key]) return;
        const i = document.createElement('i');
        // preserve any spacing/utility classes (me-1, me-2, etc.)
        const preserved = classes.filter(c => c !== 'icon' && c !== key).join(' ');
        i.className = `fa-solid ${ICON_MAP[key]} ${preserved}`.trim();
        i.setAttribute('aria-hidden', 'true');
        el.replaceWith(i);
      });
    }

    /** Get cryptocurrency icon - uses CoinGecko API for authentic logos */
    function getCryptoIcon(symbol) {
        if (!symbol || symbol === 'N/A') {
            return '<i class="fa-solid fa-coins text-muted" style="width: 24px; height: 24px; font-size: 18px;"></i>';
        }
        
        // Map symbol to CoinGecko ID for accurate logos
        const coinGeckoIds = {
            'BTC': 'bitcoin',
            'ETH': 'ethereum', 
            'SOL': 'solana',
            'ADA': 'cardano',
            'DOT': 'polkadot',
            'AVAX': 'avalanche-2',
            'MATIC': 'polygon',
            'LINK': 'chainlink',
            'UNI': 'uniswap',
            'LTC': 'litecoin',
            'XRP': 'ripple',
            'DOGE': 'dogecoin',
            'SHIB': 'shiba-inu',
            'GALA': 'gala',
            'TRX': 'tron',
            'PEPE': 'pepe',
            'USDT': 'tether',
            'USDC': 'usd-coin',
            'BNB': 'binancecoin',
            'AUD': 'australian-dollar',
            'USD': 'us-dollar'
        };
        
        const coinId = coinGeckoIds[symbol.toUpperCase()] || symbol.toLowerCase();
        
        return `<img src="https://assets.coingecko.com/coins/images/${getCoinGeckoImageId(coinId)}/small/${coinId}.png" 
                     alt="${symbol}" 
                     class="crypto-icon" 
                     style="width: 24px; height: 24px; border-radius: 50%;"
                     onerror="this.outerHTML='<i class=\\'fa-solid fa-coins text-warning\\' style=\\'width: 24px; height: 24px; font-size: 18px;\\'></i>'">`;
    }
    
    /** Get CoinGecko image IDs for major cryptocurrencies */
    function getCoinGeckoImageId(coinId) {
        const imageIds = {
            'bitcoin': '1',
            'ethereum': '279', 
            'solana': '4128',
            'cardano': '975',
            'polkadot': '12171',
            'avalanche-2': '12559',
            'polygon': '4713',
            'chainlink': '877',
            'uniswap': '12504',
            'litecoin': '2',
            'ripple': '44',
            'dogecoin': '5',
            'shiba-inu': '11939',
            'gala': '12493',
            'tron': '1094',
            'pepe': '29850',
            'tether': '325',
            'usd-coin': '6319',
            'binancecoin': '825'
        };
        
        return imageIds[coinId] || '1'; // Default to Bitcoin ID if not found
    }

    // === CARD VIEW TOGGLE FUNCTIONALITY ===
    const cardViews = ['text', 'graph', 'detailed', 'compact'];
    const cardViewState = {};
    
    function toggleCardView(cardId) {
        // Initialize card state if not exists
        if (!cardViewState[cardId]) {
            cardViewState[cardId] = 0;
        }
        
        // Cycle to next view
        cardViewState[cardId] = (cardViewState[cardId] + 1) % cardViews.length;
        const newView = cardViews[cardViewState[cardId]];
        
        const card = document.querySelector(`[data-card="${cardId}"]`);
        if (!card) return;
        
        // Update card class
        card.className = `kpi-card view-${newView}`;
        
        // Hide all view contents
        const viewContents = card.querySelectorAll('.view-content');
        viewContents.forEach(content => content.classList.remove('active'));
        
        // Show active view content
        const activeContent = card.querySelector(`.view-${newView}-content`);
        if (activeContent) {
            activeContent.classList.add('active');
        }
        
        // Update button icon based on view
        const button = card.querySelector('.view-toggle-btn i');
        if (button) {
            const icons = {
                'text': 'fa-font',
                'graph': 'fa-chart-line', 
                'detailed': 'fa-list-ul',
                'compact': 'fa-compress'
            };
            button.className = `fa-solid ${icons[newView]}`;
        }
        
        // Initialize mini charts for graph views
        if (newView === 'graph') {
            initializeMiniChart(cardId);
        }
        
        // Update data for new view mode
        updateCardDataForView(cardId, newView);
        
        console.log(`Card ${cardId} switched to ${newView} view`);
    }
    
    function initializeMiniChart(cardId) {
        const canvas = document.querySelector(`#${cardId.replace('-', '')}-chart`);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Generate sample data
        const data = Array.from({length: 20}, (_, i) => Math.random() * 100 + 50);
        
        // Draw simple line chart
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        data.forEach((value, index) => {
            const x = (index / (data.length - 1)) * width;
            const y = height - ((value - 50) / 100 * height);
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
        
        // Add gradient fill
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, 'rgba(0, 123, 255, 0.2)');
        gradient.addColorStop(1, 'rgba(0, 123, 255, 0.05)');
        
        ctx.fillStyle = gradient;
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        ctx.fill();
    }
    
    function updateCardDataForView(cardId, viewType) {
        // Get current data from text view elements
        const textValue = document.querySelector(`#okx-${cardId.replace('-', '')}`);
        if (!textValue) return;
        
        const value = textValue.textContent;
        
        // Update corresponding view elements
        if (viewType === 'graph') {
            const graphValue = document.querySelector(`#okx-${cardId.replace('-', '')}-graph`);
            if (graphValue) graphValue.textContent = value;
        } else if (viewType === 'detailed') {
            const detailedValue = document.querySelector(`#okx-${cardId.replace('-', '')}-detailed`);
            if (detailedValue) detailedValue.textContent = value;
        } else if (viewType === 'compact') {
            const compactValue = document.querySelector(`#okx-${cardId.replace('-', '')}-compact`);
            if (compactValue) compactValue.textContent = value;
        }
    }

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
        upgradeIcons(); // convert all existing icons
        // Set up event handlers
        handleCurrencyChange();
        initTableSorting();
        
        // Set up bot toggle button
        const botButton = document.getElementById('btn-bot-toggle');
        if (botButton) {
            botButton.addEventListener('click', toggleBot);
        }
        
        // Set up other button handlers
        document.getElementById('btn-ato-export')?.addEventListener('click', function() {
            window.open('/api/ato-export', '_blank');
        });
        
        document.getElementById('btn-take-profit')?.addEventListener('click', async function() {
            if (confirm('Execute take profit for all positions above 2% profit?')) {
                try {
                    const token = getAdminToken();
                    const response = await fetch('/api/take-profit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': token
                        }
                    });
                    const data = await response.json();
                    alert(data.message || 'Take profit executed');
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
        });
        
        // Initial status fetch
        fetchAndUpdateBotStatus();
        updateFooterStatus();
        updateTimingDisplays();
        
        // Set up periodic updates
        setInterval(updateFooterStatus, 10000); // Every 10 seconds
        setInterval(updateTimingDisplays, 5000); // Every 5 seconds
        setInterval(fetchAndUpdateBotStatus, 30000); // Every 30 seconds
        
        // Initialize the main trading app if available
        if (window.tradingApp && typeof window.tradingApp.init === 'function') {
            window.tradingApp.init();
        }
        
        // Load initial data for tables
        setTimeout(() => {
            if (window.tradingApp && typeof window.tradingApp.updateCurrentHoldings === 'function') {
                window.tradingApp.updateCurrentHoldings();
            }
            if (typeof refreshHoldingsData === 'function') {
                refreshHoldingsData();
            }
            if (typeof fetchAndUpdateAvailablePositions === 'function') {
                fetchAndUpdateAvailablePositions();
            }
        }, 1000);
    });
    </script>
</body>
</html>