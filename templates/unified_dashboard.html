<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard - Unified View</title>
    
    <!-- Performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- System fonts for reliability -->
    <style>
        :root {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* Simple black and white icon system using modern Unicode symbols */
        .icon {
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
            color: currentColor;
        }
        
        .icon-dashboard::before { content: "◧"; }
        .icon-chart::before { content: "▤"; }
        .icon-wallet::before { content: "◈"; }
        .icon-coins::before { content: "●"; }
        .icon-exchange::before { content: "⇄"; }
        .icon-refresh::before { content: "↻"; }
        .icon-up::before { content: "▲"; }
        .icon-down::before { content: "▼"; }
        .icon-robot::before { content: "◉"; }
        .icon-shield::before { content: "◈"; }
        .icon-wifi::before { content: "◦"; }
        .icon-server::before { content: "▣"; }
        .icon-file::before { content: "◻"; }
        .icon-dollar::before { content: "$"; }
        .icon-percent::before { content: "%"; }
        .icon-sort::before { content: "↕"; }
        .icon-close::before { content: "✕"; }
        .icon-trophy::before { content: "♦"; }
        .icon-code::before { content: "◉"; }
        .icon-menu::before { content: "☰"; }
        .icon-fire::before { content: "▲"; }
        .icon-balance::before { content: "◗"; }
        .icon-pnl::before { content: "▲"; }
        .icon-positions::before { content: "◩"; }
        .icon-tier::before { content: "◈"; }
        .icon-stop::before { content: "⬛"; }
    </style>
    
    <!-- Minimal CSS (preload for performance) -->
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}" as="style">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Color scheme and theme -->
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#111315">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body class="theme-min">
    <!-- Navigation Bar with Mobile Toggle -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#overview">
                <span class="icon icon-chart me-2"></span>Crypto Trading Dashboard
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="icon icon-menu"></span>
            </button>

            <div id="mainNav" class="collapse navbar-collapse">
                <div class="navbar-nav me-auto nav-pills-container d-flex">
                    <a class="nav-link active" href="#overview">
                        <span class="icon icon-dashboard me-1"></span>Overview
                    </a>
                    <a class="nav-link" href="#holdings">Holdings</a>
                    <a class="nav-link" href="#trades">Trades</a>
                </div>

                <div class="navbar-nav ms-auto">
                    <!-- keep minimal here to avoid crowding; main controls go in control bar -->
                    <a class="btn btn-outline-secondary btn-sm me-2" href="{{ url_for('test_sync_data') }}" target="_blank" rel="noopener">Sync Test</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Control Bar (sticky, right under navbar) -->
    <div class="control-bar border-bottom">
        <div class="container-fluid d-flex flex-wrap align-items-center gap-2 py-2">
            <div class="d-flex align-items-center gap-2">
                <label class="small muted mb-0">Currency</label>
                <select id="currency-selector" class="form-select form-select-sm" onchange="changeCurrency()">
                    <option value="USD" selected>USD</option>
                    <option value="AUD">AUD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>

            <div class="ms-auto d-flex flex-wrap gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportATOTax()" aria-label="Export ATO tax data">
                    <span class="icon icon-file me-1" aria-hidden="true"></span>ATO Export
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="executeTakeProfit()" aria-label="Execute take profit strategy">
                    <span class="icon icon-dollar me-1" aria-hidden="true"></span>Take Profit
                </button>
                <button class="btn btn-sm" onclick="showBuyDialog()" aria-label="Show buy order dialog">
                    <span class="icon icon-up me-1" aria-hidden="true"></span>Buy
                </button>
                <button class="btn btn-sm" onclick="showSellDialog()" aria-label="Show sell order dialog">
                    <span class="icon icon-down me-1" aria-hidden="true"></span>Sell
                </button>
                <button class="btn btn-sm" onclick="toggleBot()" aria-label="Toggle trading bot">
                    <span class="icon icon-robot me-1" aria-hidden="true"></span><span id="bot-status-top">Start Bot</span>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="stopAllTrading()" aria-label="Stop all trading activity">
                    <span class="icon icon-stop me-1" aria-hidden="true"></span>Stop Trading
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="container-fluid py-3">
        
        <!-- SECTION 1: OVERVIEW DASHBOARD -->
        <section id="overview" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><span class="icon icon-wallet me-2"></span>OKX Portfolio Overview</h2>
                <div class="d-flex align-items-center gap-2">
                    <span id="okx-account-level" class="badge bg-info">Standard</span>
                    <span class="badge bg-success">
                        <span class="icon icon-wifi me-1"></span>
                        <span id="overview-connection">Connected</span>
                    </span>
                    <small class="text-muted">
                        Last Update: <span id="overview-last-update">—</span>
                    </small>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row text-center mb-4 g-2">
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-balance me-1"></span>Total Balance
                        </div>
                        <div id="okx-total-balance" class="value">$0.00</div>
                        <div id="okx-balance-change" class="change-indicator"></div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-pnl me-1"></span>24h P&L
                        </div>
                        <div id="okx-day-pnl" class="value">$0.00</div>
                        <div id="okx-day-pnl-percent" class="change-indicator"></div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-trophy me-1"></span>Best Performer
                        </div>
                        <div id="okx-best-performer" class="value">—</div>
                        <div id="okx-best-gain" class="change-indicator text-success"></div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-positions me-1"></span>Active Positions
                        </div>
                        <div id="okx-active-positions" class="value">0</div>
                        <div id="okx-positions-detail" class="change-indicator"></div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-robot me-1"></span>Trading Bot
                        </div>
                        <div id="okx-bot-status" class="value">Inactive</div>
                        <div id="okx-bot-details" class="change-indicator"></div>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <div class="kpi-card">
                        <div class="label">
                            <span class="icon icon-tier me-1"></span>Account Level
                        </div>
                        <div id="okx-account-tier" class="value">Standard</div>
                        <div id="okx-account-features" class="change-indicator"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Trading Controls -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <span class="icon icon-exchange me-2"></span>Quick Trading
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <button class="btn btn-success fw-bold w-100" onclick="showBuyDialog()">
                                <span class="icon icon-up me-2"></span> BUY
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-danger fw-bold w-100" onclick="showSellDialog()">
                                <span class="icon icon-down me-2"></span> SELL
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-warning fw-bold w-100" onclick="toggleBot()">
                                <span class="icon icon-robot me-2"></span> <span id="bot-status">START BOT</span>
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-danger fw-bold w-100" onclick="confirmLiveTrading()" title="Start live trading with real money">
                                <span class="icon icon-fire me-2"></span> LIVE TRADE
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-warning">
                            <span class="icon icon-fire me-1"></span><strong>Live Trading Enabled</strong>
                        </small>
                        <div class="mt-1">
                            <small class="text-muted">
                                <span class="icon icon-shield me-1"></span>OKX API Connected
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 2: OPEN POSITIONS -->
        <section id="holdings" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <h2><span class="icon icon-positions me-2"></span>Open Positions</h2>
                    <small class="text-muted">
                        <span class="icon icon-clock me-1"></span>
                        Last updated: <span id="positions-last-refresh">—</span>
                    </small>
                    <small class="text-info">
                        <span class="icon icon-timer me-1"></span>
                        Next refresh: <span id="positions-next-refresh">—</span>
                    </small>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshHoldingsData()" aria-label="Refresh positions data">
                    <span class="icon icon-refresh me-1"></span> Refresh
                </button>
            </div>

            <!-- Open Positions Table -->
            <div class="card card--hover">
                <div class="card-header">
                    <h6 class="mb-0">Open Positions</h6>
                    <span class="meta">Live OKX Portfolio Data</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0" id="open-positions-table">
                            <thead>
                                <tr>
                                    <th class="table-sortable" onclick="sortPositionsTable(0)" aria-label="Sort by symbol">Symbol <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(1)" aria-label="Sort by quantity">Quantity <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(2)" aria-label="Sort by purchase price">Purchase Price <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(3)" aria-label="Sort by current price">Current Price <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(4)" aria-label="Sort by market value">Market Value <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(5)" aria-label="Sort by current P&L dollars">Current P&L $ <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(6)" aria-label="Sort by current P&L percentage">Current P&L % <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(7)" aria-label="Sort by target sell price">Target Price <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(8)" aria-label="Sort by target P&L dollars">Target P&L $ <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(9)" aria-label="Sort by target P&L percentage">Target P&L % <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortPositionsTable(10)" aria-label="Sort by days held">Days <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="open-positions-table-body">
                                <tr><td colspan="12" class="text-center">Loading open positions...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Available Positions Table -->
            <div class="card card--hover mt-4">
                <div class="card-header">
                    <h6 class="mb-0">Available Positions</h6>
                    <span class="meta">Cryptocurrencies Ready for Buy-Back</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0" id="available-positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Current Balance</th>
                                    <th>Last Exit Price</th>
                                    <th>Current Price</th>
                                    <th>Target Buy Price</th>
                                    <th>Price Difference</th>
                                    <th>Buy Signal</th>
                                    <th>Last Trade Date</th>
                                    <th>Days Since Exit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="available-positions-table-body">
                                <tr><td colspan="10" class="text-center">Loading available positions...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="section-divider my-5">

        <!-- SECTION 3: TRADES -->
        <section id="trades" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><span class="icon icon-exchange me-2"></span>Recent Trades</h2>
                <div class="d-flex gap-2">
                    <select id="trades-timeframe" class="form-select form-select-sm" onchange="filterTradesByTimeframe()">
                        <option value="7d" selected>Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="all">All trades</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshTradesData()">
                        <span class="icon icon-refresh me-1"></span> Refresh
                    </button>
                </div>
            </div>

            <!-- Trade Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="text" id="trades-filter" class="form-control form-control-sm" placeholder="Filter by symbol..." oninput="filterTradesTable()">
                </div>
                <div class="col-md-3">
                    <select id="trades-action-filter" class="form-select form-select-sm" onchange="filterTradesTable()">
                        <option value="">All Actions</option>
                        <option value="BUY">Buy Only</option>
                        <option value="SELL">Sell Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="trades-pnl-filter" class="form-select form-select-sm" onchange="filterTradesTable()">
                        <option value="">All P&L</option>
                        <option value="positive">Profitable</option>
                        <option value="negative">Loss</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearTradesFilters()">
                        <span class="icon icon-close me-1"></span> Clear Filters
                    </button>
                </div>
            </div>

            <!-- Trades Table -->
            <div class="card card--hover">
                <div class="card-header">
                    <h6 class="mb-0">Recent Trades</h6>
                    <span class="meta">Authentic OKX History</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0" id="trades-table-main">
                            <thead>
                                <tr>
                                    <th class="table-sortable" onclick="sortTradesTable(0)" aria-label="Sort by trade number">Trade # <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(1)" aria-label="Sort by trade time">Time <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(2)" aria-label="Sort by symbol">Symbol <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(3)" aria-label="Sort by trade action">Action <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(4)" aria-label="Sort by trade size">Size <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(5)" aria-label="Sort by trade price">Price <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                    <th class="table-sortable" onclick="sortTradesTable(6)" aria-label="Sort by profit and loss">P&L <span class="icon icon-sort ms-1" aria-hidden="true"></span></th>
                                </tr>
                            </thead>
                            <tbody id="trades-table">
                                <tr><td colspan="7" class="text-center">Loading recent trades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-3 mt-5">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><small><strong>System Status & Info</strong></small></p>
                    <p class="mb-1 text-xs">
                        <span class="icon icon-server me-1"></span>
                        Server Uptime: <span id="footer-system-uptime">0s</span> |
                        <span class="icon icon-exchange me-1"></span>
                        OKX: <span id="footer-okx-status">Connected</span> |
                        <span class="icon icon-code me-1"></span>
                        Version: {{ version|default('dev') }}
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-1"><small><strong>Legal & Compliance</strong></small></p>
                    <p class="mb-0 text-xs">
                        © 2025 ARM Digital Enterprises. ATO compliant reporting system.
                        <strong>Disclaimer:</strong> High-risk trading platform for informational purposes.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='app.js') }}?v={{ cache_version|default(0) }}" defer></script>
    
    <!-- Unified Dashboard JS -->
    <script>
    // Smooth scrolling and navigation highlighting
    function scrollToSection(sectionId) {
        document.getElementById(sectionId).scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        
        // Update active nav pill
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector(`[href="#${sectionId}"]`).classList.add('active');
    }

    // Auto-update active section based on scroll position
    window.addEventListener('scroll', function() {
        const sections = ['overview', 'holdings', 'trades'];
        const scrollPos = window.scrollY + 100;
        
        sections.forEach(section => {
            const element = document.getElementById(section);
            const navLink = document.querySelector(`[href="#${section}"]`);
            
            if (element.offsetTop <= scrollPos && element.offsetTop + element.offsetHeight > scrollPos) {
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                navLink.classList.add('active');
            }
        });
    });

    // Trading control functions
    function showBuyDialog() {
        const symbol = prompt("Enter symbol to buy (e.g., BTC-USDT):");
        if (!symbol) return;
        
        const amount = prompt("Enter USD amount to invest:");
        if (!amount || isNaN(amount)) return;
        
        if (confirm(`Buy $${amount} worth of ${symbol}?`)) {
            executeBuyOrder(symbol, parseFloat(amount));
        }
    }

    function showSellDialog() {
        const symbol = prompt("Enter symbol to sell (e.g., BTC-USDT):");
        if (!symbol) return;
        
        const percentage = prompt("Enter percentage to sell (1-100):");
        if (!percentage || isNaN(percentage) || percentage < 1 || percentage > 100) return;
        
        if (confirm(`Sell ${percentage}% of your ${symbol} position?`)) {
            executeSellOrder(symbol, parseFloat(percentage));
        }
    }

    async function executeBuyOrder(symbol, amount) {
        try {
            const data = await fetch('/api/buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol, amount: amount }),
                cache: 'no-store',
                signal: new AbortController().signal
            }).then(res => res.json());
            if (data.success) {
                alert(`Buy order successful: ${data.message}`);
                // Refresh data
                if (typeof loadDashboardData === 'function') loadDashboardData();
                if (typeof loadHoldingsData === 'function') loadHoldingsData();
            } else {
                alert(`Buy order failed: ${data.error}`);
            }
        } catch (error) {
            console.error('Buy order error:', error);
            alert('Buy order failed: Network error');
        }
    }

    async function executeSellOrder(symbol, percentage) {
        try {
            const data = await fetch('/api/sell', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: symbol, percentage: percentage }),
                cache: 'no-store',
                signal: new AbortController().signal
            }).then(res => res.json());
            if (data.success) {
                alert(`Sell order successful: ${data.message}`);
                // Refresh data
                if (typeof loadDashboardData === 'function') loadDashboardData();
                if (typeof loadHoldingsData === 'function') loadHoldingsData();
            } else {
                alert(`Sell order failed: ${data.error}`);
            }
        } catch (error) {
            console.error('Sell order error:', error);
            alert('Sell order failed: Network error');
        }
    }

    async function toggleBot() {
        try {
            const ctl = new AbortController();
            const data = await fetch('/api/toggle-bot', { 
                method: 'POST',
                cache: 'no-store',
                signal: ctl.signal,
                headers: { 'Cache-Control': 'no-store' }
            }).then(res => res.json());
            if (data.success) {
                const botStatus = document.getElementById('bot-status');
                const botToggleText = document.getElementById('bot-toggle-text');
                if (botStatus) botStatus.textContent = data.status;
                if (botToggleText) botToggleText.textContent = data.status;
                alert(`Bot ${data.status}`);
            } else {
                alert(`Bot toggle failed: ${data.error}`);
            }
        } catch (error) {
            console.error('Bot toggle error:', error);
            alert('Bot toggle failed: Network error');
        }
    }

    async function executeRebalance() {
        if (confirm('Execute portfolio rebalance? This will adjust all positions.')) {
            try {
                const ctl = new AbortController();
                const data = await fetch('/api/rebalance', { 
                    method: 'POST',
                    cache: 'no-store',
                    signal: ctl.signal,
                    headers: { 'Cache-Control': 'no-store' }
                }).then(res => res.json());
                if (data.success) {
                    alert(`Rebalance successful: ${data.message}`);
                    // Refresh data
                    if (typeof loadDashboardData === 'function') loadDashboardData();
                    if (typeof loadHoldingsData === 'function') loadHoldingsData();
                } else {
                    alert(`Rebalance failed: ${data.error}`);
                }
            } catch (error) {
                console.error('Rebalance error:', error);
                alert('Rebalance failed: Network error');
            }
        }
    }

    async function confirmLiveTrading() {
        if (confirm('WARNING: This will enable live trading with real money. Are you sure?')) {
            if (confirm('FINAL CONFIRMATION: Start live trading mode?')) {
                try {
                    const ctl = new AbortController();
                    const data = await fetch('/api/enable-live-trading', { 
                        method: 'POST',
                        cache: 'no-store',
                        signal: ctl.signal,
                        headers: { 'Cache-Control': 'no-store' }
                    }).then(res => res.json());
                    if (data.success) {
                        alert(`Live trading enabled: ${data.message}`);
                        // Refresh data
                        if (typeof loadDashboardData === 'function') loadDashboardData();
                    } else {
                        alert(`Live trading failed: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Live trading error:', error);
                    alert('Live trading failed: Network error');
                }
            }
        }
    }

    // Initialize OKX Portfolio Overview using working portfolio service data
    async function updateNativeOKXDisplay() {
        try {
            // Use working portfolio service instead of failing dashboard API
            const [portfolioResponse, bestPerformerResponse] = await Promise.all([
                fetch('/api/crypto-portfolio'),
                fetch('/api/best-performer')
            ]);
            
            if (!portfolioResponse.ok) {
                console.warn('Portfolio service not available');
                return;
            }
            
            const portfolioData = await portfolioResponse.json();
            if (portfolioData && portfolioData.total_current_value !== undefined) {
                // Update total balance - use total estimated value including fiat
                const totalBalance = document.getElementById('okx-total-balance');
                if (totalBalance) {
                    // Use total_estimated_value (includes AUD + crypto) instead of just crypto holdings
                    const balance = portfolioData.total_estimated_value || portfolioData.total_current_value || 0;
                    
                    if (balance >= 1) {
                        // For larger amounts (like your AUD balance), use standard currency formatting
                        totalBalance.textContent = new Intl.NumberFormat("en-US", { 
                            style: "currency", 
                            currency: "USD",
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(balance);
                    } else if (balance < 0.000001 && balance > 0) {
                        // For micro-values, use extended decimals
                        totalBalance.textContent = new Intl.NumberFormat("en-US", { 
                            style: "currency", 
                            currency: "USD",
                            minimumFractionDigits: 8,
                            maximumFractionDigits: 12
                        }).format(balance);
                    } else {
                        totalBalance.textContent = `$${balance.toFixed(2)}`;
                    }
                }
                
                // Update P&L with proper formatting
                const dayPnl = document.getElementById('okx-day-pnl');
                const dayPnlPercent = document.getElementById('okx-day-pnl-percent');
                if (dayPnl && portfolioData.total_pnl !== undefined) {
                    const pnlValue = portfolioData.total_pnl || 0;
                    
                    // Format P&L value with proper decimals for micro amounts
                    if (Math.abs(pnlValue) < 0.000001 && pnlValue !== 0) {
                        dayPnl.textContent = new Intl.NumberFormat("en-US", { 
                            style: "currency", 
                            currency: "USD",
                            minimumFractionDigits: 8,
                            maximumFractionDigits: 12
                        }).format(pnlValue);
                    } else {
                        dayPnl.textContent = `$${pnlValue.toFixed(6)}`;
                    }
                    dayPnl.className = `value ${pnlValue >= 0 ? 'text-success' : 'text-danger'}`;
                    
                    if (dayPnlPercent && portfolioData.total_pnl_percent !== undefined) {
                        const pnlPercent = portfolioData.total_pnl_percent || 0;
                        dayPnlPercent.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
                        dayPnlPercent.className = `change-indicator ${pnlPercent >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                }
                
                // Update active positions count
                const activePositions = document.getElementById('okx-active-positions');
                if (activePositions && portfolioData.holdings) {
                    activePositions.textContent = portfolioData.holdings.length.toString();
                }
                
                // Update positions detail
                const positionsDetail = document.getElementById('okx-positions-detail');
                if (positionsDetail && portfolioData.holdings) {
                    const cryptoCount = portfolioData.holdings.filter(p => !['USD', 'USDT', 'AUD'].includes(p.symbol)).length;
                    positionsDetail.textContent = `${cryptoCount} crypto`;
                }
                
                // Update best performer - use the actual holding if it's profitable
                const bestPerformer = document.getElementById('okx-best-performer');
                const bestGain = document.getElementById('okx-best-gain');
                if (portfolioData.holdings && portfolioData.holdings.length > 0) {
                    const profitableHolding = portfolioData.holdings.find(h => h.pnl_percent > 0);
                    if (profitableHolding) {
                        if (bestPerformer) bestPerformer.textContent = profitableHolding.symbol;
                        if (bestGain) bestGain.textContent = `+${profitableHolding.pnl_percent.toFixed(2)}%`;
                    }
                }
            }
            
            // Only use separate best performer API if no holdings data available
            if (bestPerformerResponse.ok && (!portfolioData.holdings || portfolioData.holdings.length === 0)) {
                const bestData = await bestPerformerResponse.json();
                if (bestData.success && bestData.symbol) {
                    const bestPerformer = document.getElementById('okx-best-performer');
                    const bestGain = document.getElementById('okx-best-gain');
                    if (bestPerformer) bestPerformer.textContent = bestData.symbol;
                    if (bestGain && bestData.change_24h !== undefined) {
                        bestGain.textContent = `+${bestData.change_24h.toFixed(2)}%`;
                    }
                }
            }
            
            // Set static account level (since native API is unauthorized)
            const accountLevel = document.getElementById('okx-account-level');
            if (accountLevel) {
                accountLevel.textContent = 'Standard';
                accountLevel.className = 'badge bg-info';
            }
            
            const accountTier = document.getElementById('okx-account-tier');
            if (accountTier) accountTier.textContent = 'Standard';
            
            console.log('OKX Portfolio Overview updated with actual OKX data');
        } catch (error) {
            console.warn('Failed to update OKX Portfolio Overview:', error);
        }
    }

    // Positions refresh tracking
    let positionsLastRefreshTime = null;
    let positionsRefreshInterval = null;
    const REFRESH_INTERVAL_MS = 90000; // 90 seconds between refreshes
    
    function updatePositionsRefreshTime() {
        positionsLastRefreshTime = new Date();
        updatePositionsTimeDisplay();
        
        // Clear existing interval if any
        if (positionsRefreshInterval) {
            clearInterval(positionsRefreshInterval);
        }
        
        // Start new interval to update time display every 5 seconds for smooth countdown
        positionsRefreshInterval = setInterval(updatePositionsTimeDisplay, 5000);
    }
    
    function updatePositionsTimeDisplay() {
        const refreshDisplay = document.getElementById('positions-last-refresh');
        const nextRefreshDisplay = document.getElementById('positions-next-refresh');
        if (!refreshDisplay || !positionsLastRefreshTime) return;
        
        const now = new Date();
        const diffMs = now - positionsLastRefreshTime;
        const diffMinutes = Math.floor(diffMs / 60000);
        const diffSeconds = Math.floor((diffMs % 60000) / 1000);
        
        // Update "last refresh" display
        if (diffMinutes > 0) {
            refreshDisplay.textContent = `${diffMinutes}m ${diffSeconds}s ago`;
            refreshDisplay.className = diffMinutes > 2 ? 'text-warning' : 'text-muted';
        } else {
            refreshDisplay.textContent = `${diffSeconds}s ago`;
            refreshDisplay.className = 'text-success';
        }
        
        // Update "next refresh" countdown
        if (nextRefreshDisplay) {
            const nextRefreshMs = REFRESH_INTERVAL_MS - diffMs;
            if (nextRefreshMs > 0) {
                const nextMinutes = Math.floor(nextRefreshMs / 60000);
                const nextSeconds = Math.floor((nextRefreshMs % 60000) / 1000);
                
                if (nextMinutes > 0) {
                    nextRefreshDisplay.textContent = `${nextMinutes}m ${nextSeconds}s`;
                } else {
                    nextRefreshDisplay.textContent = `${nextSeconds}s`;
                }
                nextRefreshDisplay.className = nextRefreshMs < 15000 ? 'text-warning' : 'text-info';
            } else {
                nextRefreshDisplay.textContent = 'now';
                nextRefreshDisplay.className = 'text-success';
            }
        }
    }
    
    // Override the existing updateHoldingsTable to track refresh time
    const originalUpdateHoldingsTable = window.updateHoldingsTable;
    window.updateHoldingsTable = function() {
        if (originalUpdateHoldingsTable) {
            originalUpdateHoldingsTable();
        }
        updatePositionsRefreshTime();
    };
    
    // Call updateNativeOKXDisplay on page load and periodically
    document.addEventListener('DOMContentLoaded', function() {
        updateNativeOKXDisplay();
        setInterval(updateNativeOKXDisplay, 120000); // Update every 2 minutes for OKX API compliance
        
        // Initialize positions refresh tracking
        updatePositionsRefreshTime();
    });
    </script>
    
</body>
</html>