<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX Live Sync Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .test-card.pass {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .test-card.fail {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        .test-card.warning {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }
        .sync-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .sync-status.pass {
            background-color: #d4edda;
            color: #155724;
        }
        .sync-status.fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .sync-status.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .live-indicator {
            color: #28a745;
            font-weight: bold;
        }
        .cached-indicator {
            color: #ffc107;
            font-weight: bold;
        }
        .error-indicator {
            color: #dc3545;
            font-weight: bold;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .metric-highlight {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .refresh-icon {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-sync-alt me-2"></i>OKX Live Sync Test Suite</h1>
                    <button class="btn btn-primary" onclick="runSyncTests()">
                        <i class="fas fa-play me-2"></i>Run All Tests
                    </button>
                </div>

                <!-- Test Status Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Tests Run</h5>
                                <div class="metric-highlight text-primary" id="tests-run">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Passed</h5>
                                <div class="metric-highlight text-success" id="tests-passed">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Failed</h5>
                                <div class="metric-highlight text-danger" id="tests-failed">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Last Run</h5>
                                <div class="metric-highlight text-muted" id="last-run">Never</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Results Container -->
                <div id="test-results-container">
                    <div class="text-center p-5">
                        <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                        <h4>OKX Live Data Synchronization Tests</h4>
                        <p class="text-muted">Click "Run All Tests" to verify OKX API synchronization with your dashboard</p>
                    </div>
                </div>

                <!-- Raw Data Display -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Raw Test Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="code-block" id="raw-data">
                                    No test data available. Run tests to see detailed output.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testData = null;

        function runSyncTests() {
            const button = document.querySelector('button[onclick="runSyncTests()"]');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner refresh-icon me-2"></i>Running Tests...';

            fetch('/api/test-sync-data', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                testData = data;
                displayTestResults(data);
                updateOverview(data);
            })
            .catch(error => {
                console.error('Test execution failed:', error);
                document.getElementById('test-results-container').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Test Execution Failed:</strong> ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i>Run All Tests';
            });
        }

        function updateOverview(data) {
            const testResults = data.test_results || {};
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(t => t.status === 'pass').length;
            const failedTests = Object.values(testResults).filter(t => t.status === 'fail').length;

            document.getElementById('tests-run').textContent = totalTests;
            document.getElementById('tests-passed').textContent = passedTests;
            document.getElementById('tests-failed').textContent = failedTests;
            document.getElementById('last-run').textContent = new Date(data.timestamp).toLocaleTimeString();
        }

        function displayTestResults(data) {
            const container = document.getElementById('test-results-container');
            const testResults = data.test_results || {};

            if (Object.keys(testResults).length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No test results available.
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';

            Object.entries(testResults).forEach(([testName, result]) => {
                const cardClass = result.status === 'pass' ? 'pass' : 
                                result.status === 'fail' ? 'fail' : 'warning';
                const statusClass = result.status === 'pass' ? 'pass' : 
                                  result.status === 'fail' ? 'fail' : 'warning';
                const icon = result.status === 'pass' ? 'fa-check-circle' : 
                           result.status === 'fail' ? 'fa-times-circle' : 'fa-exclamation-triangle';

                html += `
                    <div class="col-lg-6 mb-3">
                        <div class="card test-card ${cardClass}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${getTestDisplayName(testName)}</h6>
                                <span class="sync-status ${statusClass}">
                                    <i class="fas ${icon} me-1"></i>${result.status.toUpperCase()}
                                </span>
                            </div>
                            <div class="card-body">
                                ${generateTestContent(testName, result)}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            // Update raw data display
            document.getElementById('raw-data').textContent = JSON.stringify(data, null, 2);
        }

        function getTestDisplayName(testName) {
            const names = {
                'holdings_sync': 'Holdings Synchronization',
                'price_freshness': 'Price Data Freshness',
                'strategy_pnl': 'Strategy P&L Testing',
                'unrealized_pnl': 'Unrealized P&L Accuracy',
                'futures_margin': 'Futures/Margin Access'
            };
            return names[testName] || testName.replace('_', ' ').toUpperCase();
        }

        function generateTestContent(testName, result) {
            if (result.status === 'error') {
                return `
                    <div class="alert alert-danger mb-0">
                        <strong>Error:</strong> ${result.error}
                    </div>
                `;
            }

            let content = `<p class="text-muted mb-3">${getTestDescription(testName)}</p>`;

            // Add specific metrics based on test type
            if (result.perfect_matches !== undefined) {
                content += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Perfect Matches:</strong> <span class="text-success">${result.perfect_matches}</span>
                        </div>
                        <div class="col-6">
                            <strong>Mismatches:</strong> <span class="text-danger">${result.mismatches || 0}</span>
                        </div>
                    </div>
                `;
            }

            if (result.timestamps_different !== undefined) {
                content += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Live Updates:</strong> 
                            <span class="${result.timestamps_different ? 'live-indicator' : 'cached-indicator'}">
                                ${result.timestamps_different ? 'YES' : 'NO'}
                            </span>
                        </div>
                        <div class="col-6">
                            <strong>Holdings Live:</strong> 
                            <span class="${result.holdings_marked_live ? 'live-indicator' : 'cached-indicator'}">
                                ${result.holdings_marked_live ? 'YES' : 'NO'}
                            </span>
                        </div>
                    </div>
                `;
            }

            if (result.calculation_accuracy !== undefined) {
                content += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Accuracy:</strong> <span class="text-primary">${result.calculation_accuracy}%</span>
                        </div>
                        <div class="col-6">
                            <strong>Test Cases:</strong> ${result.test_cases || 0}
                        </div>
                    </div>
                `;
            }

            return content;
        }

        function getTestDescription(testName) {
            const descriptions = {
                'holdings_sync': 'Verifies that portfolio holdings match exactly between OKX API and dashboard display.',
                'price_freshness': 'Ensures market prices are fetched live from OKX and not served from cache.',
                'strategy_pnl': 'Validates that trading strategy profit/loss calculations are mathematically accurate.',
                'unrealized_pnl': 'Checks that unrealized P&L calculations match OKX account data.',
                'futures_margin': 'Verifies access to futures and margin trading account information.'
            };
            return descriptions[testName] || 'Test validation for OKX data synchronization.';
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runSyncTests, 1000);
        });
    </script>
</body>
</html>