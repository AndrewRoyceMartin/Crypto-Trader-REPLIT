<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Performance â€” Algorithmic Trading System</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- Custom CSS -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}"
  />

  <style>
    /* Make chart containers white and crisp */
    .chart-card {
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: .5rem;
      padding: 1rem;
      height: 360px;
    }
    .chart-card canvas {
      background: #fff; /* ensure canvas is white if parent changes */
    }

    .kpi .value {
      font-weight: 700;
      font-size: 1.25rem;
    }
    .kpi small {
      color: #6c757d;
    }

    .sticky-actions {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.05);
      padding: .5rem 0;
      margin: -0.5rem 0 1rem;
    }

    .table thead th {
      white-space: nowrap;
    }
    .text-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>

  <script>
    // Force cache refresh for JS if you want to reference window.cacheVersion elsewhere
    window.cacheVersion = {{ cache_version|default(0) }};
  </script>
</head>
<body class="bg-light">
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <i class="fas fa-chart-line me-2"></i>
        Algorithmic Trading System
      </a>

      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarsMain"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">
              <i class="fas fa-home me-1"></i> Dashboard
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm" href="{{ url_for('portfolio') }}">
              <i class="fas fa-wallet me-1"></i> Portfolio
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-light btn-sm" href="#">
              <i class="fas fa-chart-bar me-1"></i> Performance
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm" href="{{ url_for('holdings') }}">
              <i class="fas fa-coins me-1"></i> Holdings
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm" href="{{ url_for('trades') }}">
              <i class="fas fa-exchange-alt me-1"></i> Trades
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-info btn-sm" href="{{ url_for('test_sync_data') }}">
              <i class="fas fa-sync-alt me-1"></i> Sync Test
            </a>
          </li>
        </ul>
        <div class="navbar-text text-end text-white-50 small">
          <i class="fas fa-code-branch me-1"></i> v{{ version|default('dev') }}
        </div>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <div class="container-fluid py-4">

    <!-- Filters & Actions -->
    <div class="sticky-actions">
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label mb-1">Start</label>
          <input type="date" class="form-control form-control-sm" id="perf-date-start" />
        </div>
        <div class="col-md-2">
          <label class="form-label mb-1">End</label>
          <input type="date" class="form-control form-control-sm" id="perf-date-end" />
        </div>
        <div class="col-md-2">
          <label class="form-label mb-1">Symbol</label>
          <select class="form-select form-select-sm" id="perf-symbol-filter">
            <option value="ALL" selected>ALL</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label mb-1">Strategy</label>
          <select class="form-select form-select-sm" id="perf-strategy-filter">
            <option value="ALL" selected>ALL</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end gap-2 flex-wrap">
          <div class="btn-group btn-group-sm me-2" role="group" aria-label="Ranges">
            <button class="btn btn-outline-secondary" data-range="1M">1M</button>
            <button class="btn btn-outline-secondary" data-range="3M">3M</button>
            <button class="btn btn-outline-secondary" data-range="6M">6M</button>
            <button class="btn btn-outline-secondary" data-range="YTD">YTD</button>
            <button class="btn btn-outline-secondary" data-range="1Y">1Y</button>
            <button class="btn btn-outline-secondary" data-range="MAX">MAX</button>
          </div>
          <button id="perf-refresh" class="btn btn-primary btn-sm">
            <i class="fas fa-sync-alt me-1"></i> Refresh
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="fas fa-file-export me-1"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="perf-export-summary">Summary (JSON)</a></li>
              <li><a class="dropdown-item" href="#" id="perf-export-trades">Trades (CSV)</a></li>
              <li><a class="dropdown-item" href="#" id="perf-export-returns">Returns (CSV)</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Total Invested</div>
          <div class="value text-mono" id="perf-total-invested">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Current Value</div>
          <div class="value text-mono" id="perf-current-value">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Total P&L</div>
          <div class="value text-mono" id="perf-total-pnl">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Overall Return</div>
          <div class="value text-mono" id="perf-overall-return">0.00%</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Sharpe (ann.)</div>
          <div class="value text-mono" id="perf-sharpe">0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Sortino (ann.)</div>
          <div class="value text-mono" id="perf-sortino">0.00</div>
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Volatility (ann.)</div>
          <div class="value text-mono" id="perf-vol">0.00%</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Max Drawdown</div>
          <div class="value text-mono" id="perf-maxdd">0.00%</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">CAGR</div>
          <div class="value text-mono" id="perf-cagr">0.00%</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Profit Factor</div>
          <div class="value text-mono" id="perf-profit-factor">0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Win Rate</div>
          <div class="value text-mono" id="perf-win-rate">0.00%</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi p-3">
          <div class="small text-muted">Trades</div>
          <div class="value text-mono" id="perf-trade-count">0</div>
        </div>
      </div>
    </div>

    <!-- CHARTS: Equity & Drawdown -->
    <div class="row g-3 mb-4">
      <div class="col-lg-8">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="fas fa-chart-line me-2"></i> Equity Curve (vs Benchmark)
            </h6>
            <small class="text-muted">Value over time</small>
          </div>
          <canvas id="equityCurveChart"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="fas fa-water me-2"></i> Drawdown
            </h6>
            <small class="text-muted">Underwater curve</small>
          </div>
          <canvas id="drawdownChart"></canvas>
        </div>
      </div>
    </div>

    <!-- CHARTS: Distributions & Attribution -->
    <div class="row g-3 mb-4">
      <div class="col-lg-4">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="fas fa-percent me-2"></i> Daily Returns Histogram
            </h6>
            <small class="text-muted">Distribution</small>
          </div>
          <canvas id="returnsHistChart"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="fas fa-coins me-2"></i> Trade P&L Histogram
            </h6>
            <small class="text-muted">Per-trade distribution</small>
          </div>
          <canvas id="tradePLHistChart"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i> Attribution by Symbol
            </h6>
            <small class="text-muted">P&L contribution</small>
          </div>
          <canvas id="contribBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Attribution Table -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-table me-2"></i>Attribution</h6>
        <small class="text-muted">Symbol / Trades / P&L / P&L %</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Symbol</th>
                <th class="text-end">Trades</th>
                <th class="text-end">P&L</th>
                <th class="text-end">P&L %</th>
              </tr>
            </thead>
            <tbody id="attribution-table">
              <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Monthly Returns -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Monthly Returns</h6>
        <small class="text-muted">Heatmap (%, by month)</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0 text-center align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-start">Year</th>
                <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
                <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="monthly-returns-table">
              <tr><td colspan="14" class="text-muted py-3">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Drawdowns -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-arrow-down me-2"></i>Top Drawdowns</h6>
        <small class="text-muted">Worst periods</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Peak Date</th>
                <th>Valley Date</th>
                <th class="text-end">Peak</th>
                <th class="text-end">Valley</th>
                <th class="text-end">Drawdown</th>
                <th class="text-end">Days</th>
              </tr>
            </thead>
            <tbody id="drawdowns-table">
              <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trades -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Trades</h6>
        <div class="input-group input-group-sm" style="width: 200px;">
          <input type="text" class="form-control" id="trades-search" placeholder="Search symbol...">
          <button class="btn btn-outline-secondary" id="trades-clear">Clear</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 400px;">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th>Date</th>
                <th>Symbol</th>
                <th>Side</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Price</th>
                <th class="text-end">Value</th>
                <th class="text-end">P&L</th>
                <th class="text-end">P&L %</th>
              </tr>
            </thead>
            <tbody id="trades-table">
              <tr><td colspan="8" class="text-center text-muted py-3">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Performance Analytics Script -->
  <script>
  (function() {
    'use strict';

    // Global vars for Chart.js instances
    let equityChart, drawdownChart, returnsHistChart, tradePLHistChart, contribBarChart;

    // State
    const state = {
      rawData: null,
      filteredData: null
    };

    // DOM Ready
    document.addEventListener('DOMContentLoaded', function() {
      initializeDateInputs();
      attachEventListeners();
      loadInitialData();
    });

    function initializeDateInputs() {
      const today = new Date();
      const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
      
      document.getElementById('perf-date-end').value = today.toLocaleDateString('en-CA'); // YYYY-MM-DD format
      document.getElementById('perf-date-start').value = oneYearAgo.toLocaleDateString('en-CA');
    }

    function attachEventListeners() {
      // Refresh button
      document.getElementById('perf-refresh').addEventListener('click', loadInitialData);

      // Range buttons
      document.querySelectorAll('[data-range]').forEach(btn => {
        btn.addEventListener('click', function() {
          setDateRange(this.dataset.range);
          loadInitialData();
        });
      });

      // Export buttons
      document.getElementById('perf-export-summary').addEventListener('click', () => exportData('summary'));
      document.getElementById('perf-export-trades').addEventListener('click', () => exportData('trades'));
      document.getElementById('perf-export-returns').addEventListener('click', () => exportData('returns'));

      // Search
      document.getElementById('trades-search').addEventListener('input', filterTrades);
      document.getElementById('trades-clear').addEventListener('click', clearTradesSearch);

      // Filter changes
      ['perf-date-start', 'perf-date-end', 'perf-symbol-filter', 'perf-strategy-filter'].forEach(id => {
        document.getElementById(id).addEventListener('change', loadInitialData);
      });
    }

    function setDateRange(range) {
      const end = new Date();
      let start = new Date();

      switch(range) {
        case '1M':
          start.setMonth(end.getMonth() - 1);
          break;
        case '3M':
          start.setMonth(end.getMonth() - 3);
          break;
        case '6M':
          start.setMonth(end.getMonth() - 6);
          break;
        case 'YTD':
          start = new Date(end.getFullYear(), 0, 1);
          break;
        case '1Y':
          start.setFullYear(end.getFullYear() - 1);
          break;
        case 'MAX':
          start = new Date('2020-01-01');
          break;
      }

      document.getElementById('perf-date-start').value = start.toLocaleDateString('en-CA');
      document.getElementById('perf-date-end').value = end.toLocaleDateString('en-CA');
    }

    async function loadInitialData() {
      try {
        const params = new URLSearchParams({
          start: document.getElementById('perf-date-start').value,
          end: document.getElementById('perf-date-end').value,
          symbol: document.getElementById('perf-symbol-filter').value,
          strategy: document.getElementById('perf-strategy-filter').value
        });

        const response = await fetch(`/api/performance?${params}`);
        if (!response.ok) {
          throw new Error('Failed to load performance data');
        }

        const data = await response.json();
        state.rawData = data;
        state.filteredData = data;

        updateKPIs(data);
        updateCharts(data);
        updateTables(data);

      } catch (error) {
        console.error('Error loading performance data:', error);
        showError('Failed to load performance data');
      }
    }

    function updateKPIs(data) {
      const summary = data.summary || {};
      
      document.getElementById('perf-total-invested').textContent = formatCurrency(summary.total_invested || 0);
      document.getElementById('perf-current-value').textContent = formatCurrency(summary.current_value || 0);
      document.getElementById('perf-total-pnl').textContent = formatCurrency(summary.total_pnl || 0);
      document.getElementById('perf-overall-return').textContent = formatPercent(summary.overall_return || 0);
      document.getElementById('perf-sharpe').textContent = (summary.sharpe_ratio || 0).toFixed(2);
      document.getElementById('perf-sortino').textContent = (summary.sortino_ratio || 0).toFixed(2);
      document.getElementById('perf-vol').textContent = formatPercent(summary.volatility || 0);
      document.getElementById('perf-maxdd').textContent = formatPercent(summary.max_drawdown || 0);
      document.getElementById('perf-cagr').textContent = formatPercent(summary.cagr || 0);
      document.getElementById('perf-profit-factor').textContent = (summary.profit_factor || 0).toFixed(2);
      document.getElementById('perf-win-rate').textContent = formatPercent(summary.win_rate || 0);
      document.getElementById('perf-trade-count').textContent = (summary.trade_count || 0).toString();
    }

    function updateCharts(data) {
      updateEquityChart(data.equity_curve || []);
      updateDrawdownChart(data.drawdown_curve || []);
      updateReturnsHistogram(data.daily_returns || []);
      updateTradePLHistogram(data.trades || []);
      updateAttributionChart(data.attribution || []);
    }

    function updateEquityChart(equityData) {
      const ctx = document.getElementById('equityCurveChart');
      if (!ctx) return;

      if (equityChart) equityChart.destroy();

      const dates = equityData.map(d => d.date);
      const values = equityData.map(d => d.value);

      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Portfolio Value',
            data: values,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });
    }

    function updateDrawdownChart(drawdownData) {
      const ctx = document.getElementById('drawdownChart');
      if (!ctx) return;

      if (drawdownChart) drawdownChart.destroy();

      const dates = drawdownData.map(d => d.date);
      const values = drawdownData.map(d => d.drawdown);

      drawdownChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Drawdown %',
            data: values,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              max: 0,
              ticks: {
                callback: value => value + '%'
              }
            }
          }
        }
      });
    }

    function updateReturnsHistogram(dailyReturns) {
      const ctx = document.getElementById('returnsHistChart');
      if (!ctx) return;

      if (returnsHistChart) returnsHistChart.destroy();

      // Create histogram bins
      const bins = createHistogramBins(dailyReturns, 20);

      returnsHistChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: bins.labels,
          datasets: [{
            data: bins.counts,
            backgroundColor: '#198754',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Daily Return %'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Frequency'
              }
            }
          }
        }
      });
    }

    function updateTradePLHistogram(trades) {
      const ctx = document.getElementById('tradePLHistChart');
      if (!ctx) return;

      if (tradePLHistChart) tradePLHistChart.destroy();

      const pnls = trades.map(t => t.pnl || 0);
      const bins = createHistogramBins(pnls, 15);

      tradePLHistChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: bins.labels,
          datasets: [{
            data: bins.counts,
            backgroundColor: '#fd7e14',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Trade P&L'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Frequency'
              }
            }
          }
        }
      });
    }

    function updateAttributionChart(attributionData) {
      const ctx = document.getElementById('contribBarChart');
      if (!ctx) return;

      if (contribBarChart) contribBarChart.destroy();

      const sortedData = [...attributionData].sort((a, b) => Math.abs(b.pnl) - Math.abs(a.pnl)).slice(0, 10);

      contribBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedData.map(d => d.symbol),
          datasets: [{
            data: sortedData.map(d => d.pnl),
            backgroundColor: sortedData.map(d => d.pnl >= 0 ? '#198754' : '#dc3545'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });
    }

    function updateTables(data) {
      updateAttributionTable(data.attribution || []);
      updateMonthlyReturnsTable(data.monthly_returns || {});
      updateDrawdownsTable(data.top_drawdowns || []);
      updateTradesTable(data.trades || []);
    }

    function updateAttributionTable(attribution) {
      const tbody = document.getElementById('attribution-table');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!attribution.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>';
        return;
      }

      attribution.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${row.symbol}</strong></td>
          <td class="text-end">${row.trades || 0}</td>
          <td class="text-end ${row.pnl >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(row.pnl || 0)}</td>
          <td class="text-end ${row.pnl_percent >= 0 ? 'text-success' : 'text-danger'}">${formatPercent(row.pnl_percent || 0)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateMonthlyReturnsTable(monthlyData) {
      const tbody = document.getElementById('monthly-returns-table');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!Object.keys(monthlyData).length) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-muted py-3">No data</td></tr>';
        return;
      }

      Object.entries(monthlyData).forEach(([year, months]) => {
        const tr = document.createElement('tr');
        const yearTotal = Object.values(months).reduce((sum, val) => sum + (val || 0), 0);
        
        tr.innerHTML = `
          <td class="text-start"><strong>${year}</strong></td>
          ${['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(month => {
            const val = months[month] || 0;
            const colorClass = val >= 0 ? 'text-success' : 'text-danger';
            return `<td class="${colorClass}">${val.toFixed(2)}%</td>`;
          }).join('')}
          <td class="${yearTotal >= 0 ? 'text-success' : 'text-danger'}"><strong>${yearTotal.toFixed(2)}%</strong></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateDrawdownsTable(drawdowns) {
      const tbody = document.getElementById('drawdowns-table');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!drawdowns.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>';
        return;
      }

      drawdowns.forEach(dd => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(dd.peak_date)}</td>
          <td>${formatDate(dd.valley_date)}</td>
          <td class="text-end">${formatCurrency(dd.peak_value)}</td>
          <td class="text-end">${formatCurrency(dd.valley_value)}</td>
          <td class="text-end text-danger">${formatPercent(dd.drawdown)}</td>
          <td class="text-end">${dd.duration_days || 0}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateTradesTable(trades) {
      const tbody = document.getElementById('trades-table');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!trades.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">No data</td></tr>';
        return;
      }

      trades.forEach(trade => {
        const tr = document.createElement('tr');
        const sideClass = trade.side === 'BUY' ? 'text-success' : 'text-danger';
        const pnlClass = (trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger';
        
        tr.innerHTML = `
          <td>${formatDate(trade.timestamp)}</td>
          <td><strong>${trade.symbol}</strong></td>
          <td><span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.side}</span></td>
          <td class="text-end">${(trade.quantity || 0).toFixed(6)}</td>
          <td class="text-end">${formatCurrency(trade.price || 0)}</td>
          <td class="text-end">${formatCurrency(trade.value || 0)}</td>
          <td class="text-end ${pnlClass}">${formatCurrency(trade.pnl || 0)}</td>
          <td class="text-end ${pnlClass}">${formatPercent(trade.pnl_percent || 0)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterTrades() {
      const searchTerm = document.getElementById('trades-search').value.toLowerCase();
      const rows = document.querySelectorAll('#trades-table tr');
      
      rows.forEach(row => {
        const symbol = row.cells[1]?.textContent.toLowerCase() || '';
        row.style.display = symbol.includes(searchTerm) ? '' : 'none';
      });
    }

    function clearTradesSearch() {
      document.getElementById('trades-search').value = '';
      filterTrades();
    }

    function exportData(type) {
      if (!state.rawData) {
        showError('No data to export');
        return;
      }

      let filename, content;

      switch(type) {
        case 'summary':
          filename = 'performance-summary.json';
          content = JSON.stringify(state.rawData.summary, null, 2);
          break;
        case 'trades':
          filename = 'performance-trades.csv';
          content = convertToCSV(state.rawData.trades || [], ['timestamp', 'symbol', 'side', 'quantity', 'price', 'value', 'pnl', 'pnl_percent']);
          break;
        case 'returns':
          filename = 'performance-returns.csv';
          content = convertToCSV(state.rawData.equity_curve || [], ['date', 'value', 'daily_return']);
          break;
      }

      downloadFile(filename, content);
    }

    // Helper functions
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    function formatPercent(value) {
      return (value * 100).toFixed(2) + '%';
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString([], {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function createHistogramBins(data, numBins) {
      if (!data.length) return { labels: [], counts: [] };

      const min = Math.min(...data);
      const max = Math.max(...data);
      const binWidth = (max - min) / numBins;

      const bins = Array(numBins).fill(0);
      const labels = [];

      for (let i = 0; i < numBins; i++) {
        labels.push((min + i * binWidth).toFixed(2));
      }

      data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binWidth), numBins - 1);
        bins[binIndex]++;
      });

      return { labels, counts: bins };
    }

    function convertToCSV(data, fields) {
      const header = fields.join(',');
      const rows = data.map(row => fields.map(field => row[field] || '').join(','));
      return [header, ...rows].join('\n');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function showError(message) {
      console.error(message);
      // Could show a toast or alert here
    }

  })();
  </script>

</body>
</html>