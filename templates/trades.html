{% extends "base_layout.html" %}

{% block title %}Trades - Hybrid Trading Intelligence{% endblock %}

{% block extra_css %}
<style>
    .trades-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 12px;
    }
    
    .stat-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .trades-table th {
        background: var(--primary-dark);
        color: var(--text-primary);
        padding: 1rem 0.75rem;
        font-weight: 600;
        border: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table td {
        padding: 0.875rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .trades-table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    
    .signal-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .signal-buy {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .signal-sell {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .signal-wait {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .signal-avoid {
        background: rgba(156, 163, 175, 0.15);
        color: #9ca3af;
        border: 1px solid rgba(156, 163, 175, 0.3);
    }
    
    .type-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .type-signal {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }
    
    .type-trade {
        background: rgba(168, 85, 247, 0.15);
        color: #a855f7;
    }
    
    .confidence-bar {
        width: 100%;
        height: 6px;
        background: rgba(156, 163, 175, 0.2);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .confidence-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .confidence-high { background: #22c55e; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #ef4444; }
    
    .filters-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-group:last-child {
        margin-bottom: 0;
    }
    
    .symbol-tag {
        background: var(--accent-blue);
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .trades-table {
            font-size: 0.8rem;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="trades-header">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    Trading Signals & Execution History
                </h1>
                <p class="page-subtitle">
                    Real-time trading signals from your hybrid ML + technical analysis system
                </p>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="row mb-4" id="summary-stats">
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-primary" id="total-signals">-</div>
                <div class="stat-label">Total Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-success" id="buy-signals">-</div>
                <div class="stat-label">Buy Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-danger" id="sell-signals">-</div>
                <div class="stat-label">Sell Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-info" id="recent-24h">-</div>
                <div class="stat-label">Last 24h</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-warning" id="avg-confidence">-</div>
                <div class="stat-label">Avg Confidence</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-purple" id="total-trades">-</div>
                <div class="stat-label">Executed Trades</div>
            </div>
        </div>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Symbol:</label>
                    <select class="form-select form-select-sm" id="symbol-filter">
                        <option value="">All Symbols</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Signal Type:</label>
                    <select class="form-select form-select-sm" id="action-filter">
                        <option value="">All Actions</option>
                        <option value="BUY">Buy Signals</option>
                        <option value="SELL">Sell Signals</option>
                        <option value="WAIT">Wait Signals</option>
                        <option value="AVOID">Avoid Signals</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Type:</label>
                    <select class="form-select form-select-sm" id="type-filter">
                        <option value="">All Types</option>
                        <option value="SIGNAL">Signals Only</option>
                        <option value="TRADE">Executed Trades</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <button class="btn btn-primary btn-sm" onclick="loadTradesData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trades Table -->
    <div class="trades-table">
        <div class="loading-spinner" id="loading-spinner">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <div>Loading trades data...</div>
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;">
            <i class="fas fa-chart-line"></i>
            <h4>No trades found</h4>
            <p>Try adjusting your filters or check back later for new trading signals.</p>
        </div>
        
        <table class="table-v02" style="--v02-head-bg: #6c7ae0; display: none;" id="trades-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Type</th>
                    <th>Action</th>
                    <th>Price</th>
                    <th>Confidence</th>
                    <th>Technical</th>
                    <th>ML Data</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="trades-tbody">
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
let allTradesData = [];
let filteredData = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTradesData();
    
    // Setup filter event listeners
    document.getElementById('symbol-filter').addEventListener('change', applyFilters);
    document.getElementById('action-filter').addEventListener('change', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
});

async function loadTradesData() {
    try {
        showLoading(true);
        
        const response = await fetch('/api/trades');
        const data = await response.json();
        
        if (data.success) {
            allTradesData = data.trades;
            updateSummaryStats(data.summary);
            populateSymbolFilter();
            applyFilters();
            console.log('✅ Trades data loaded:', data.trades.length, 'records');
        } else {
            console.error('❌ Trades API error:', data.error);
            showEmptyState();
        }
        
    } catch (error) {
        console.error('❌ Failed to load trades data:', error);
        showEmptyState();
    } finally {
        showLoading(false);
    }
}

function updateSummaryStats(summary) {
    document.getElementById('total-signals').textContent = summary.total_signals;
    document.getElementById('buy-signals').textContent = summary.buy_signals;
    document.getElementById('sell-signals').textContent = summary.sell_signals;
    document.getElementById('recent-24h').textContent = summary.recent_24h;
    document.getElementById('avg-confidence').textContent = summary.avg_confidence.toFixed(1) + '%';
    document.getElementById('total-trades').textContent = summary.total_trades;
}

function populateSymbolFilter() {
    const symbols = [...new Set(allTradesData.map(t => t.symbol).filter(s => s && s !== 'N/A'))].sort();
    const symbolFilter = document.getElementById('symbol-filter');
    
    // Clear existing options except "All Symbols"
    symbolFilter.innerHTML = '<option value="">All Symbols</option>';
    
    symbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolFilter.appendChild(option);
    });
}

function applyFilters() {
    const symbolFilter = document.getElementById('symbol-filter').value;
    const actionFilter = document.getElementById('action-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    
    filteredData = allTradesData.filter(trade => {
        const symbolMatch = !symbolFilter || trade.symbol === symbolFilter;
        const actionMatch = !actionFilter || trade.action === actionFilter;
        const typeMatch = !typeFilter || trade.signal_type === typeFilter;
        
        return symbolMatch && actionMatch && typeMatch;
    });
    
    renderTradesTable();
}

function renderTradesTable() {
    const tbody = document.getElementById('trades-tbody');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    
    if (filteredData.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filteredData.map(trade => {
        const date = new Date(trade.timestamp);
        const timeStr = date.toLocaleString();
        
        // Signal badge
        const signalClass = getSignalClass(trade.action);
        const signalBadge = `<span class="signal-badge ${signalClass}">${trade.action || 'N/A'}</span>`;
        
        // Type badge
        const typeBadge = `<span class="type-badge type-${trade.signal_type.toLowerCase()}">${trade.signal_type}</span>`;
        
        // Confidence bar
        const confidence = trade.confidence || 0;
        const confidenceClass = confidence >= 70 ? 'confidence-high' : confidence >= 50 ? 'confidence-medium' : 'confidence-low';
        const confidenceBar = `
            <div class="confidence-bar">
                <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
            </div>
            <small class="text-muted">${confidence.toFixed(1)}%</small>
        `;
        
        // Technical indicators
        const technical = [];
        if (trade.rsi) technical.push(`RSI: ${trade.rsi.toFixed(1)}`);
        if (trade.volatility) technical.push(`Vol: ${trade.volatility.toFixed(1)}%`);
        if (trade.volume_ratio) technical.push('Volume ✓');
        if (trade.momentum) technical.push('Momentum ✓');
        if (trade.support) technical.push('Support ✓');
        if (trade.bollinger) technical.push('BB ✓');
        
        const technicalStr = technical.length > 0 ? technical.slice(0, 2).join('<br>') : 'N/A';
        
        // ML data
        let mlData = 'N/A';
        if (trade.ml_probability !== null && trade.ml_probability !== undefined) {
            mlData = `P: ${(trade.ml_probability * 100).toFixed(1)}%`;
            if (trade.predicted_return) {
                mlData += `<br>Return: ${trade.predicted_return.toFixed(1)}%`;
            }
        }
        
        // Price formatting
        const price = trade.price ? `$${parseFloat(trade.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}` : 'N/A';
        
        // Symbol with tag
        const symbolDisplay = trade.symbol ? `<span class="symbol-tag">${trade.symbol}</span>` : 'N/A';
        
        return `
            <tr>
                <td>
                    <div style="font-size: 0.85rem;">${timeStr}</div>
                </td>
                <td>${symbolDisplay}</td>
                <td>${typeBadge}</td>
                <td>${signalBadge}</td>
                <td class="text-end">${price}</td>
                <td>${confidenceBar}</td>
                <td><small>${technicalStr}</small></td>
                <td><small>${mlData}</small></td>
                <td>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        ${trade.status}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function getSignalClass(action) {
    switch (action?.toUpperCase()) {
        case 'BUY': return 'signal-buy';
        case 'SELL': return 'signal-sell';
        case 'WAIT': return 'signal-wait';
        case 'AVOID': return 'signal-avoid';
        default: return 'signal-wait';
    }
}

function clearFilters() {
    document.getElementById('symbol-filter').value = '';
    document.getElementById('action-filter').value = '';
    document.getElementById('type-filter').value = '';
    applyFilters();
}

function showLoading(show) {
    document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
    document.getElementById('trades-table').style.display = show ? 'none' : 'table';
    document.getElementById('empty-state').style.display = 'none';
}

function showEmptyState() {
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('trades-table').style.display = 'none';
    document.getElementById('empty-state').style.display = 'block';
}

// Auto-refresh every 30 seconds
setInterval(loadTradesData, 30000);
</script>
{% endblock %}