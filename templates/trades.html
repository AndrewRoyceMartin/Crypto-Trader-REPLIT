{% extends "base_layout.html" %}

{% block title %}Trades - Grim Trader v2.0{% endblock %}

{% block extra_css %}
<style>
    .trades-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 12px;
    }
    
    .stat-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #9ca3af;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .trades-table th {
        background: var(--primary-dark);
        color: var(--text-primary);
        padding: 1rem 0.75rem;
        font-weight: 600;
        border: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table td {
        padding: 0.875rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .trades-table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    
    .signal-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .signal-buy {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .signal-sell {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .signal-wait {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .signal-avoid {
        background: rgba(156, 163, 175, 0.15);
        color: #9ca3af;
        border: 1px solid rgba(156, 163, 175, 0.3);
    }
    
    .type-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .type-signal {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }
    
    .type-trade {
        background: rgba(168, 85, 247, 0.15);
        color: #a855f7;
    }
    
    .confidence-bar {
        width: 100%;
        height: 6px;
        background: rgba(156, 163, 175, 0.2);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .confidence-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .confidence-high { background: #22c55e; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #ef4444; }
    
    .filters-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-group:last-child {
        margin-bottom: 0;
    }
    
    .symbol-tag {
        background: var(--accent-blue);
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Enhanced Loading Animations */
    .loading-skeleton {
        background: linear-gradient(90deg, 
            rgba(156, 163, 175, 0.1) 25%, 
            rgba(156, 163, 175, 0.2) 50%, 
            rgba(156, 163, 175, 0.1) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
        height: 1.2em;
    }
    
    .loading-skeleton-stat {
        background: linear-gradient(90deg, 
            rgba(59, 130, 246, 0.1) 25%, 
            rgba(59, 130, 246, 0.3) 50%, 
            rgba(59, 130, 246, 0.1) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
        height: 2rem;
        width: 80%;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .stat-loading {
        opacity: 0.7;
        transform: scale(0.98);
        transition: all 0.3s ease;
    }
    
    .stat-loaded {
        opacity: 1;
        transform: scale(1);
        animation: statPulse 0.5s ease-out;
    }
    
    @keyframes statPulse {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .loading-spinner-container {
        display: none;
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .trades-table {
            font-size: 0.8rem;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="trades-header">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    Trading Signals & Execution History
                </h1>
                <p class="page-subtitle">
                    Real-time trading signals from your hybrid ML + technical analysis system
        <br><small id="last-updated" style="color: #9ca3af; font-size: 0.8rem;" data-status="last-updated" data-timestamp>Loading data...</small>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="row mb-4" id="summary-stats">
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="total-signals">
                <div class="stat-value text-primary" id="total-signals" data-metric="totalSignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Total Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="buy-signals">
                <div class="stat-value text-success" id="buy-signals" data-metric="buySignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Buy Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="sell-signals">
                <div class="stat-value text-danger" id="sell-signals" data-metric="sellSignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Sell Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="recent-24h">
                <div class="stat-value text-info" id="recent-24h" data-metric="recent24h" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Last 24h</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="avg-confidence">
                <div class="stat-value text-warning" id="avg-confidence" data-metric="avgConfidence" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Avg Confidence</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="total-trades">
                <div class="stat-value text-purple" id="total-trades" data-metric="totalTrades" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Executed Trades</div>
            </div>
        </div>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Symbol:</label>
                    <select class="form-select form-select-sm" id="symbol-filter" data-filter="symbol" data-control>
                        <option value="">All Symbols</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Signal Type:</label>
                    <select class="form-select form-select-sm" id="action-filter" data-filter="action" data-control>
                        <option value="">All Actions</option>
                        <option value="BUY">Buy Signals</option>
                        <option value="SELL">Sell Signals</option>
                        <option value="WAIT">Wait Signals</option>
                        <option value="AVOID">Avoid Signals</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Type:</label>
                    <select class="form-select form-select-sm" id="type-filter" data-filter="type" data-control>
                        <option value="">All Types</option>
                        <option value="SIGNAL">Signals Only</option>
                        <option value="TRADE">Executed Trades</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <button class="btn btn-primary btn-sm" onclick="loadTradesData()" data-action="refresh" data-control>
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" data-action="clear-filters" data-control>
                        <i class="fas fa-times me-1"></i>
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trades Table -->
    <div class="trades-table">
        <div class="loading-spinner-container" id="loading-spinner" data-loading="trades">
            <div class="loading-spinner text-primary"></div>
            <div>Loading trades data...</div>
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;" data-state="empty" data-content>
            <i class="fas fa-chart-line"></i>
            <h4>No trades found</h4>
            <p>Try adjusting your filters or check back later for new trading signals.</p>
        </div>
        
        <table class="table-v02" style="--v02-head-bg: #6c7ae0; display: none;" id="trades-table" data-table="trades" data-content>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Type</th>
                    <th>Action</th>
                    <th>Price</th>
                    <th>Confidence</th>
                    <th>Technical</th>
                    <th>ML Data</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="trades-tbody" data-tbody="trades" data-content>
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
let allTradesData = [];
let filteredData = [];

// REPAIR: Enhanced loading skeleton management for trades page
function hideAllLoadingSkeletons() {
    console.log('ðŸ”§ REPAIR: Hiding all trades loading skeletons...');
    
    // Hide all loading skeletons
    document.querySelectorAll('.loading-skeleton, .loading-skeleton-stat').forEach(skeleton => {
        skeleton.style.display = 'none';
        // Mark parent as loaded
        const parent = skeleton.closest('[data-metric], [data-stat]');
        if (parent) {
            parent.setAttribute('data-loaded', 'true');
        }
    });
    
    // Update all stat cards to loaded state
    document.querySelectorAll('.stat-card').forEach(card => {
        card.classList.add('stat-loaded');
        card.classList.remove('stat-loading');
        card.setAttribute('data-loading-state', 'loaded');
    });
    
    console.log('âœ… All trades loading skeletons hidden successfully');
}

// Initialize page
// ðŸ”§ TRADES DEBUG FUNCTIONS
const TradesDebug = {
    // Inspect trades state
    inspectState() {
        TradingDebug.log('ðŸ“Š Trades State Inspection');
        TradingDebug.inspectState('trades data', window.tradesData);
        TradingDebug.inspectState('filtered trades', window.filteredTrades);
    },
    
    // Debug trades loading
    async debugTrades() {
        TradingDebug.log('ðŸ“Š Testing trades loading...');
        try {
            await loadTradesData();
            TradingDebug.log('ðŸ“Š Trades loaded successfully');
            this.inspectState();
        } catch (error) {
            TradingDebug.trackError(error, 'Trades Loading');
        }
    },
    
    // Test trades APIs
    async testAPIs() {
        TradingDebug.log('ðŸ“Š Testing Trades APIs...');
        const endpoints = [
            '/api/trades',
            '/api/current-holdings'
        ];
        
        for (const endpoint of endpoints) {
            await TradingDebug.helpers.testAPI(endpoint);
        }
    },
    
    // Debug filters
    debugFilters() {
        TradingDebug.log('ðŸ“Š Filter Debug:');
        const symbolFilter = document.getElementById('symbol-filter');
        const actionFilter = document.getElementById('action-filter');
        
        console.log('Symbol Filter:', symbolFilter?.value);
        console.log('Action Filter:', actionFilter?.value);
        this.inspectState();
    }
};

// Add trades debug to global scope
window.tradesDebug = TradesDebug;

document.addEventListener('DOMContentLoaded', function() {
    loadTradesData();
    
    // Setup filter event listeners
    document.getElementById('symbol-filter').addEventListener('change', applyFilters);
    document.getElementById('action-filter').addEventListener('change', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
});

async function loadTradesData() {
    try {
        showLoading(true);
        console.log('ðŸ”„ Loading trades data with enhanced animations...');
        
        // REPAIR: Reset stat cards to loading state with proper tracking
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.remove('stat-loaded');
            card.classList.add('stat-loading');
            card.setAttribute('data-loading-state', 'loading');
        });
        
        const response = await fetch('/api/trades');
        const data = await response.json();
        
        if (data.success) {
            allTradesData = data.trades;
            
            // Add slight delay to show loading animation
            setTimeout(() => {
                updateSummaryStats(data.summary);
                populateSymbolFilter();
                applyFilters();
                
                // REPAIR: Ensure all loading skeletons are properly hidden
                hideAllLoadingSkeletons();
                
                console.log('âœ… Trades data loaded with animations:', data.trades.length, 'records');
            }, 300);
        } else {
            console.error('âŒ Trades API error:', data.error);
            showEmptyState();
        }
        
    } catch (error) {
        console.error('âŒ Failed to load trades data:', error);
        showEmptyState();
    } finally {
        setTimeout(() => showLoading(false), 400);
    }
}

function updateSummaryStats(summary) {
    // Enhanced loading to data transition with animations
    const stats = [
        { id: 'total-signals', value: summary.total_signals, suffix: '' },
        { id: 'buy-signals', value: summary.buy_signals, suffix: '' },
        { id: 'sell-signals', value: summary.sell_signals, suffix: '' },
        { id: 'recent-24h', value: summary.recent_24h, suffix: '' },
        { id: 'avg-confidence', value: summary.avg_confidence ? summary.avg_confidence.toFixed(1) : '0.0', suffix: '%' },
        { id: 'total-trades', value: summary.total_trades, suffix: '' }
    ];
    
    stats.forEach((stat, index) => {
        setTimeout(() => {
            const element = document.getElementById(stat.id);
            const parent = element.closest('.stat-card');
            
            // Add loading state
            parent.classList.add('stat-loading');
            
            setTimeout(() => {
                // Replace loading skeleton with actual data
                element.innerHTML = `<span style="opacity: 0; transform: translateY(10px); transition: all 0.4s ease;">${stat.value}${stat.suffix}</span>`;
                
                // Trigger animation
                requestAnimationFrame(() => {
                    const span = element.querySelector('span');
                    span.style.opacity = '1';
                    span.style.transform = 'translateY(0)';
                    parent.classList.remove('stat-loading');
                    parent.classList.add('stat-loaded');
                });
            }, 200);
        }, index * 100); // Stagger the animations
    });
}

function populateSymbolFilter() {
    const symbols = [...new Set(allTradesData.map(t => t.symbol).filter(s => s && s !== 'N/A'))].sort();
    const symbolFilter = document.getElementById('symbol-filter');
    
    // Clear existing options except "All Symbols"
    symbolFilter.innerHTML = '<option value="">All Symbols</option>';
    
    symbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolFilter.appendChild(option);
    });
}

function applyFilters() {
    const symbolFilter = document.getElementById('symbol-filter').value;
    const actionFilter = document.getElementById('action-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    
    filteredData = allTradesData.filter(trade => {
        const symbolMatch = !symbolFilter || trade.symbol === symbolFilter;
        const actionMatch = !actionFilter || trade.action === actionFilter;
        const typeMatch = !typeFilter || trade.signal_type === typeFilter;
        
        return symbolMatch && actionMatch && typeMatch;
    });
    
    renderTradesTable();
}

function renderTradesTable() {
    const tbody = document.getElementById('trades-tbody');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    
    if (filteredData.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filteredData.map(trade => {
        const date = new Date(trade.timestamp);
        const timeStr = date.toLocaleString();
        
        // Signal badge
        const signalClass = getSignalClass(trade.action);
        const signalBadge = `<span class="signal-badge ${signalClass}">${trade.action || 'N/A'}</span>`;
        
        // Type badge
        const typeBadge = `<span class="type-badge type-${trade.signal_type.toLowerCase()}">${trade.signal_type}</span>`;
        
        // Confidence bar
        const confidence = trade.confidence || 0;
        const confidenceClass = confidence >= 70 ? 'confidence-high' : confidence >= 50 ? 'confidence-medium' : 'confidence-low';
        const confidenceBar = `
            <div class="confidence-bar">
                <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
            </div>
            <small style="color: #9ca3af;">${confidence.toFixed(1)}%</small>
        `;
        
        // Technical indicators
        const technical = [];
        if (trade.rsi) technical.push(`RSI: ${trade.rsi.toFixed(1)}`);
        if (trade.volatility) technical.push(`Vol: ${trade.volatility.toFixed(1)}%`);
        if (trade.volume_ratio) technical.push('Volume âœ“');
        if (trade.momentum) technical.push('Momentum âœ“');
        if (trade.support) technical.push('Support âœ“');
        if (trade.bollinger) technical.push('BB âœ“');
        
        const technicalStr = technical.length > 0 ? technical.slice(0, 2).join('<br>') : 'N/A';
        
        // ML data
        let mlData = 'N/A';
        if (trade.ml_probability !== null && trade.ml_probability !== undefined) {
            mlData = `P: ${(trade.ml_probability * 100).toFixed(1)}%`;
            if (trade.predicted_return) {
                mlData += `<br>Return: ${trade.predicted_return.toFixed(1)}%`;
            }
        }
        
        // Price formatting
        const price = trade.price ? `$${parseFloat(trade.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}` : 'N/A';
        
        // Symbol with tag
        const symbolDisplay = trade.symbol ? `<span class="symbol-tag">${trade.symbol}</span>` : 'N/A';
        
        return `
            <tr>
                <td>
                    <div style="font-size: 0.85rem;">${timeStr}</div>
                </td>
                <td>${symbolDisplay}</td>
                <td>${typeBadge}</td>
                <td>${signalBadge}</td>
                <td class="text-end">${price}</td>
                <td>${confidenceBar}</td>
                <td><small>${technicalStr}</small></td>
                <td><small>${mlData}</small></td>
                <td>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        ${trade.status}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function getSignalClass(action) {
    switch (action?.toUpperCase()) {
        case 'BUY': return 'signal-buy';
        case 'SELL': return 'signal-sell';
        case 'WAIT': return 'signal-wait';
        case 'AVOID': return 'signal-avoid';
        default: return 'signal-wait';
    }
}

function clearFilters() {
    document.getElementById('symbol-filter').value = '';
    document.getElementById('action-filter').value = '';
    document.getElementById('type-filter').value = '';
    applyFilters();
}

function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    const lastUpdated = document.getElementById('last-updated');
    
    if (spinner) spinner.style.display = show ? 'block' : 'none';
    if (table) table.style.display = show ? 'none' : 'table';
    if (emptyState) emptyState.style.display = 'none';
    
    if (lastUpdated) {
        if (show) {
            lastUpdated.textContent = 'Loading data...';
            lastUpdated.style.color = '#f59e0b';
        } else {
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            lastUpdated.style.color = '#22c55e';
        }
    }
}

function showEmptyState() {
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('trades-table').style.display = 'none';
    document.getElementById('empty-state').style.display = 'block';
}

// Auto-refresh every 30 seconds
setInterval(loadTradesData, 30000);
</script>
{% endblock %}
