<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trades • Algorithmic Trading System</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_version|default(0) }}"/>

  <style>
    .kpi-card .label { font-size: .8rem; color: #6c757d; }
    .kpi-card .value { font-weight: 700; font-size: 1.15rem; }
    .chart-card { background: #fff !important; border: 1px solid rgba(0,0,0,.1); border-radius: .5rem; }
    .chart-card canvas { background: #fff !important; }
    .table thead th { white-space: nowrap; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <i class="fas fa-chart-line me-2"></i>Algorithmic Trading System
      </a>
      <div class="navbar-nav me-auto">
        <a class="btn btn-outline-light btn-sm me-2" href="{{ url_for('index') }}"><i class="fas fa-home me-1"></i>Dashboard</a>
        <a class="btn btn-outline-light btn-sm me-2" href="{{ url_for('portfolio') }}"><i class="fas fa-wallet me-1"></i>Portfolio</a>
        <a class="btn btn-outline-light btn-sm me-2" href="{{ url_for('performance') }}"><i class="fas fa-chart-bar me-1"></i>Performance</a>
        <a class="btn btn-outline-light btn-sm me-2" href="{{ url_for('holdings') }}"><i class="fas fa-coins me-1"></i>Holdings</a>
        <a class="btn btn-light btn-sm me-2" href="#"><i class="fas fa-exchange-alt me-1"></i>Trades</a>
        <button class="btn btn-outline-success btn-sm me-2" onclick="exportATOTax()">
          <i class="fas fa-file-invoice-dollar me-1"></i>ATO Export
        </button>
      </div>

      <div class="navbar-nav ms-auto">
        <div class="nav-item d-flex align-items-center">

          <div class="me-3">
            <select class="form-select form-select-sm" id="currency-selector" onchange="changeCurrency()" style="min-width: 80px; font-size: 0.8rem;">
              <option value="USD" selected>USD</option>
              <option value="AUD">AUD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <span class="navbar-text me-3">
            <i class="fas fa-server text-info me-1"></i>
            <span class="text-light">Server Uptime:</span>
            <span id="system-uptime" class="text-info ms-1">0s</span>
          </span>
          <span class="navbar-text me-3" id="server-connection-status">
            <i class="fas fa-wifi text-success me-1"></i>
            <span class="text-light">OKX API:</span>
            <span id="server-connection-text" class="text-success ms-1">Connected</span>
          </span>
          <span class="navbar-text" id="okx-connection-status">
            <i class="fas fa-server text-success me-1"></i>
            <span class="text-light">Trading Mode:</span>
            <span id="okx-connection-text" class="text-success ms-1">Simulated</span>
          </span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Page -->
  <div id="recent-trades-page" class="container-fluid py-4">
    <!-- Header & Controls -->
    <div class="row mb-3">
      <div class="col-12 d-flex align-items-center justify-content-between">
        <h4 class="mb-0">
          <i class="fas fa-exchange-alt me-2"></i>Trades
          <i class="fas fa-info-circle text-muted ms-2" data-bs-toggle="tooltip"
             title="Completed buy/sell executions with realized P&L, filters, and charts."></i>
        </h4>
        <div class="d-flex gap-2">
          <div class="btn-group">
            <button class="btn btn-success btn-sm" onclick="startTrading('paper', 'single')"><i class="fas fa-play me-1"></i>Paper (Single)</button>
            <button class="btn btn-success btn-sm" onclick="startTrading('paper', 'portfolio')"><i class="fas fa-play me-1"></i>Paper (Portfolio)</button>
          </div>
          <div class="btn-group">
            <button class="btn btn-warning btn-sm" onclick="startTrading('live', 'single')"><i class="fas fa-bolt me-1"></i>Live (Single)</button>
            <button class="btn btn-warning btn-sm" onclick="startTrading('live', 'portfolio')"><i class="fas fa-bolt me-1"></i>Live (Portfolio)</button>
          </div>
          <button class="btn btn-danger btn-sm" onclick="stopTrading()"><i class="fas fa-stop me-1"></i>Stop</button>
          <button class="btn btn-danger btn-sm" onclick="emergencyStop()"><i class="fas fa-exclamation-triangle me-1"></i>Emergency</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Trades</div>
          <div id="trades-kpi-total" class="value">0</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Realized P&L</div>
          <div id="trades-kpi-realized" class="value">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Win Rate</div>
          <div id="trades-kpi-winrate" class="value">0.0%</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Avg P&L / Trade</div>
          <div id="trades-kpi-avg" class="value">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Fees</div>
          <div id="trades-kpi-fees" class="value">$0.00</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="card p-3 kpi-card">
          <div class="label">Last Trade</div>
          <div id="trades-kpi-lasttrade" class="value">—</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="chart-card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Cumulative Realized P&L</h6>
            <small class="text-muted">By time</small>
          </div>
          <canvas id="trades-cum-chart" height="260"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="chart-card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">P&L Distribution</h6>
            <small class="text-muted">Histogram</small>
          </div>
          <canvas id="trades-hist-chart" height="260"></canvas>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Symbol</label>
            <input type="text" id="trades-filter" class="form-control form-control-sm" placeholder="e.g., BTC/USDT" onkeyup="filterTradesTable()"/>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Action</label>
            <select id="trades-action-filter" class="form-select form-select-sm" onchange="filterTradesTable()">
              <option value="">All</option>
              <option value="BUY">Buy</option>
              <option value="SELL">Sell</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Time</label>
            <select id="trades-time-filter" class="form-select form-select-sm" onchange="filterTradesTable()">
              <option value="">All Time</option>
              <option value="24h">24 Hours</option>
              <option value="3d">3 Days</option>
              <option value="7d">7 Days</option>
              <option value="1m">1 Month</option>
              <option value="6m">6 Months</option>
              <option value="1y">1 Year</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">P&L</label>
            <select id="trades-pnl-filter" class="form-select form-select-sm" onchange="filterTradesTable()">
              <option value="">All</option>
              <option value="positive">Profitable</option>
              <option value="negative">Loss</option>
            </select>
          </div>
          <div class="col-md-3 text-end">
            <button class="btn btn-outline-secondary btn-sm" onclick="clearTradesFilters()">
              <i class="fas fa-times me-1"></i>Clear Filters
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Trades Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Recent Trades</h6>
        <div class="small text-muted">New → Old</div>
      </div>
      <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
        <table class="table table-sm">
          <thead class="table-dark sticky-top">
            <tr>
              <th onclick="sortTradesTable(0)" class="sortable" style="cursor:pointer;">Trade # <i id="trades-sort-0" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(1)" class="sortable" style="cursor:pointer;">Time <i id="trades-sort-1" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(2)" class="sortable" style="cursor:pointer;">Symbol <i id="trades-sort-2" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(3)" class="sortable" style="cursor:pointer;">Action <i id="trades-sort-3" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(4)" class="sortable" style="cursor:pointer;">Size <i id="trades-sort-4" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(5)" class="sortable" style="cursor:pointer;">Price <i id="trades-sort-5" class="fas fa-sort ms-1"></i></th>
              <th onclick="sortTradesTable(6)" class="sortable" style="cursor:pointer;">P&L <i id="trades-sort-6" class="fas fa-sort ms-1"></i></th>
            </tr>
          </thead>
          <tbody id="trades-table">
            <tr>
              <td colspan="7" class="text-center">
                <div class="d-flex align-items-center justify-content-center">
                  <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <span class="text-muted">Loading trades...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="bg-dark text-light py-4 mt-5">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>ARM Digital Enterprises</strong></p>
          <p class="mb-2">ABN: 92 384 831 384</p>
          <p class="mb-0"><small>Algorithmic Trading System</small></p>
          <p class="mb-1"><small>Professional Cryptocurrency Portfolio Management</small></p>
          <p class="mb-2"><small>Real-time market monitoring and automated execution with comprehensive risk management controls</small></p>
          <div class="d-flex align-items-center">
            <small class="me-3">© 2024 ARM Digital Enterprises. All rights reserved.</small>
            <small class="text-muted me-3">
              <i class="fas fa-code-branch me-1"></i>
              Version {{ version|default('dev') }}
            </small>
            <small class="text-muted">
              <i class="fas fa-shield-alt me-1"></i>
              Australian Capital Territory • Licensed Financial Services
            </small>
          </div>
        </div>
        <div class="col-md-6">
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-chart-line me-1"></i>Trading Features</h6>
              <ul class="list-unstyled mb-0">
                <li><small><i class="fas fa-check text-success me-1"></i>Real-time OKX Integration</small></li>
                <li><small><i class="fas fa-check text-success me-1"></i>Advanced Risk Management</small></li>
                <li><small><i class="fas fa-check text-success me-1"></i>Portfolio Analytics</small></li>
                <li><small><i class="fas fa-check text-success me-1"></i>ATO Compliance Export</small></li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6><i class="fas fa-cog me-1"></i>System Status</h6>
              <ul class="list-unstyled mb-0">
                <li><small><span id="footer-connection-status" class="text-success">✓ OKX Connected</span></small></li>
                <li><small><span id="footer-trading-status" class="text-info">• Paper Trading Mode</span></small></li>
                <li><small><span id="footer-server-status" class="text-success">✓ Server Online</span></small></li>
                <li><small><span class="text-muted">Portfolio: 103 Assets</span></small></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script src="{{ url_for('static', filename='app.js') }}?v={{ cache_version|default(0) }}"></script>

  <script>
    // Trades page initialization and KPI updates
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Start periodic updates - use tradingApp method
      if (window.tradingApp) {
        window.tradingApp.updateRecentTrades();
        setInterval(() => window.tradingApp.updateRecentTrades(), 6000);
      }
      
      console.log('Trades page initialized');
    });

    // Enhanced trades display with KPIs and charts
    const originalDisplayRecentTrades = window.displayRecentTrades;
    window.displayRecentTrades = function(tradesData) {
      // Handle wrapped response from API
      let trades = tradesData;
      if (tradesData && typeof tradesData === 'object' && tradesData.trades) {
        trades = tradesData.trades;
        console.log(`Extracted ${trades.length} trades from wrapped response`);
      }
      
      // Call original function first
      if (originalDisplayRecentTrades) {
        originalDisplayRecentTrades(trades);
      }
      
      // Update KPIs
      updateTradesKPIs(trades);
      
      // Update charts
      updateTradesCharts(trades);
    };

    // Also override the tradingApp method to ensure KPIs get updated
    if (window.tradingApp && window.tradingApp.displayRecentTrades) {
      const originalTradingAppDisplay = window.tradingApp.displayRecentTrades;
      window.tradingApp.displayRecentTrades = function(trades) {
        // Call original method
        originalTradingAppDisplay.call(this, trades);
        
        // Update KPIs with trades data
        updateTradesKPIs(trades);
        updateTradesCharts(trades);
      };
    }

    function updateTradesKPIs(trades) {
      if (!trades || !Array.isArray(trades)) {
        trades = [];
      }

      const totalTrades = trades.length;
      let totalRealized = 0;
      let totalFees = 0;
      let winningTrades = 0;
      let lastTradeTime = "—";

      trades.forEach(trade => {
        // Handle different field names (pnl vs realized_pnl)
        const pnl = trade.pnl !== undefined ? trade.pnl : trade.realized_pnl;
        if (pnl !== undefined && pnl !== null) {
          totalRealized += pnl;
          if (pnl > 0) {
            winningTrades++;
          }
        }
        if (trade.fee) {
          totalFees += trade.fee;
        }
      });

      if (trades.length > 0) {
        const lastTrade = trades[0]; // Assuming trades are sorted newest first
        if (lastTrade.timestamp) {
          lastTradeTime = new Date(lastTrade.timestamp).toLocaleString();
        }
      }

      const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
      const avgPnL = totalTrades > 0 ? (totalRealized / totalTrades) : 0;

      // Update KPI elements
      updateElementSafe('trades-kpi-total', totalTrades.toString());
      updateElementSafe('trades-kpi-realized', formatCurrency(totalRealized));
      updateElementSafe('trades-kpi-winrate', winRate.toFixed(1) + '%');
      updateElementSafe('trades-kpi-avg', formatCurrency(avgPnL));
      updateElementSafe('trades-kpi-fees', formatCurrency(totalFees));
      updateElementSafe('trades-kpi-lasttrade', lastTradeTime);

      console.log(`Updated trades KPIs: ${totalTrades} trades, ${formatCurrency(totalRealized)} realized P&L`);
    }

    function updateTradesCharts(trades) {
      if (!trades || !Array.isArray(trades)) {
        trades = [];
      }

      // Cumulative P&L chart
      updateCumulativePnLChart(trades);
      
      // P&L distribution histogram
      updatePnLHistogramChart(trades);
    }

    function updateCumulativePnLChart(trades) {
      const ctx = document.getElementById('trades-cum-chart');
      if (!ctx) return;

      const sortedTrades = [...trades].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      let cumulativePnL = 0;
      const data = sortedTrades.map(trade => {
        const pnl = trade.pnl !== undefined ? trade.pnl : trade.realized_pnl || 0;
        cumulativePnL += pnl;
        return {
          x: new Date(trade.timestamp),
          y: cumulativePnL
        };
      });

      if (window.cumulativePnLChart) {
        window.cumulativePnLChart.destroy();
      }

      window.cumulativePnLChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Cumulative P&L',
            data: data,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day' }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          }
        }
      });
    }

    function updatePnLHistogramChart(trades) {
      const ctx = document.getElementById('trades-hist-chart');
      if (!ctx) return;

      const pnlValues = trades.map(trade => {
        const pnl = trade.pnl !== undefined ? trade.pnl : trade.realized_pnl || 0;
        return pnl;
      }).filter(pnl => pnl !== 0);
      
      if (pnlValues.length === 0) {
        if (window.pnlHistogramChart) {
          window.pnlHistogramChart.destroy();
        }
        return;
      }

      // Create histogram bins
      const min = Math.min(...pnlValues);
      const max = Math.max(...pnlValues);
      const binCount = Math.min(10, Math.max(5, Math.floor(Math.sqrt(pnlValues.length))));
      const binSize = (max - min) / binCount;
      
      const bins = Array(binCount).fill(0).map((_, i) => ({
        x: min + i * binSize,
        count: 0
      }));

      pnlValues.forEach(pnl => {
        const binIndex = Math.min(Math.floor((pnl - min) / binSize), binCount - 1);
        bins[binIndex].count++;
      });

      if (window.pnlHistogramChart) {
        window.pnlHistogramChart.destroy();
      }

      window.pnlHistogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: bins.map(bin => formatCurrency(bin.x)),
          datasets: [{
            label: 'Trade Count',
            data: bins.map(bin => bin.count),
            backgroundColor: bins.map(bin => bin.x >= 0 ? 'rgba(75, 192, 75, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
            borderColor: bins.map(bin => bin.x >= 0 ? 'rgb(75, 192, 75)' : 'rgb(255, 99, 132)'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    function updateElementSafe(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    }

    function clearTradesFilters() {
      document.getElementById('trades-filter').value = '';
      document.getElementById('trades-action-filter').value = '';
      document.getElementById('trades-time-filter').value = '';
      document.getElementById('trades-pnl-filter').value = '';
      filterTradesTable();
    }
  </script>
</body>
</html>