{% extends "base_layout.html" %}

{% block title %}Trades - Grim Trader v2.0{% endblock %}

{% block extra_css %}
<style>
    .trades-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 12px;
    }
    
    .stat-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #9ca3af;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .trades-table th {
        background: var(--primary-dark);
        color: var(--text-primary);
        padding: 1rem 0.75rem;
        font-weight: 600;
        border: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trades-table td {
        padding: 0.875rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .trades-table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    
    .signal-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .signal-buy {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .signal-sell {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .signal-wait {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .signal-avoid {
        background: rgba(156, 163, 175, 0.15);
        color: #9ca3af;
        border: 1px solid rgba(156, 163, 175, 0.3);
    }
    
    .type-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .type-signal {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }
    
    .type-trade {
        background: rgba(168, 85, 247, 0.15);
        color: #a855f7;
    }
    
    .confidence-bar {
        width: 100%;
        height: 6px;
        background: rgba(156, 163, 175, 0.2);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .confidence-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .confidence-high { background: #22c55e; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #ef4444; }
    
    .filters-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-group:last-child {
        margin-bottom: 0;
    }
    
    .symbol-tag {
        background: var(--accent-blue);
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Enhanced Loading Animations */
    .loading-skeleton {
        background: linear-gradient(90deg, 
            rgba(156, 163, 175, 0.1) 25%, 
            rgba(156, 163, 175, 0.2) 50%, 
            rgba(156, 163, 175, 0.1) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
        height: 1.2em;
    }
    
    .loading-skeleton-stat {
        background: linear-gradient(90deg, 
            rgba(59, 130, 246, 0.1) 25%, 
            rgba(59, 130, 246, 0.3) 50%, 
            rgba(59, 130, 246, 0.1) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
        height: 2rem;
        width: 80%;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .stat-loading {
        opacity: 0.7;
        transform: scale(0.98);
        transition: all 0.3s ease;
    }
    
    .stat-loaded {
        opacity: 1;
        transform: scale(1);
        animation: statPulse 0.5s ease-out;
    }
    
    @keyframes statPulse {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .loading-spinner-container {
        display: none;
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .trades-table {
            font-size: 0.8rem;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="trades-header">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    Trading Signals & Execution History
                </h1>
                <p class="page-subtitle">
                    Real-time trading signals from your hybrid ML + technical analysis system
        <br><small id="last-updated" style="color: #9ca3af; font-size: 0.8rem;" data-status="last-updated" data-timestamp>Loading data...</small>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="row mb-4" id="summary-stats">
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="total-signals">
                <div class="stat-value text-primary" id="total-signals" data-metric="totalSignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Total Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="buy-signals">
                <div class="stat-value text-success" id="buy-signals" data-metric="buySignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Buy Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="sell-signals">
                <div class="stat-value text-danger" id="sell-signals" data-metric="sellSignals" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Sell Signals</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="recent-24h">
                <div class="stat-value text-info" id="recent-24h" data-metric="recent24h" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Last 24h</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="avg-confidence">
                <div class="stat-value text-warning" id="avg-confidence" data-metric="avgConfidence" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Avg Confidence</div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stat-card" data-stat="total-trades">
                <div class="stat-value text-purple" id="total-trades" data-metric="totalTrades" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="stat-label">Executed Trades</div>
            </div>
        </div>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Symbol:</label>
                    <select class="form-select form-select-sm" id="symbol-filter" data-filter="symbol" data-control>
                        <option value="">All Symbols</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Signal Type:</label>
                    <select class="form-select form-select-sm" id="action-filter" data-filter="action" data-control>
                        <option value="">All Actions</option>
                        <option value="BUY">Buy Signals</option>
                        <option value="SELL">Sell Signals</option>
                        <option value="WAIT">Wait Signals</option>
                        <option value="AVOID">Avoid Signals</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label mb-0">Type:</label>
                    <select class="form-select form-select-sm" id="type-filter" data-filter="type" data-control>
                        <option value="">All Types</option>
                        <option value="SIGNAL">Signals Only</option>
                        <option value="TRADE">Executed Trades</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <button class="btn btn-primary btn-sm" onclick="loadTradesData()" data-action="refresh" data-control>
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" data-action="clear-filters" data-control>
                        <i class="fas fa-times me-1"></i>
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trades Table -->
    <div class="trades-table">
        <div class="loading-spinner-container" id="loading-spinner" data-loading="trades">
            <div class="loading-spinner text-primary"></div>
            <div>Loading trades data...</div>
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;" data-state="empty" data-content>
            <i class="fas fa-chart-line"></i>
            <h4>No trades found</h4>
            <p>Try adjusting your filters or check back later for new trading signals.</p>
        </div>
        
        <table class="table-v02" style="--v02-head-bg: #6c7ae0; display: none;" id="trades-table" data-table="trades" data-content>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Symbol</th>
                    <th>Type</th>
                    <th>Action</th>
                    <th>Price</th>
                    <th>Confidence</th>
                    <th>Technical</th>
                    <th>ML Data</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="trades-tbody" data-tbody="trades" data-content>
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
let allTradesData = [];
let filteredData = [];

// Safe debug shim to avoid ReferenceErrors if TradingDebug is not present
(function ensureTradingDebug() {
    if (!window.TradingDebug) {
        const noop = () => {};
        window.TradingDebug = {
            log: console.log.bind(console),
            inspectState: (label, value) => console.log(`ðŸ”Ž ${label}:`, value),
            trackError: (e, ctx) => console.error(`âŒ ${ctx || 'Error'}`, e),
            helpers: {
                testAPI: async (endpoint) => {
                    try {
                        const r = await fetch(endpoint, { method: 'GET' });
                        console.log(`ðŸ§ª ${endpoint}`, r.status);
                        return r.status;
                    } catch (err) {
                        console.error(`ðŸ§ª ${endpoint} failed`, err);
                        return 0;
                    }
                }
            }
        };
    }
})();

// Minimal toast utils (no placeholders; only used for error UX)
let toastContainer = null;
function initToastContainer() {
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 350px;';
        document.body.appendChild(toastContainer);
    }
}
function showToast(message, type = 'info') {
    initToastContainer();
    const toast = document.createElement('div');
    toast.style.cssText = 'margin-bottom: 8px; padding: 10px 12px; border-radius: 6px; color: #fff; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15);';
    toast.style.background = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#2563eb';
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
}

// REPAIR: Enhanced loading skeleton management for trades page
function hideAllLoadingSkeletons() {
    console.log('ðŸ”§ REPAIR: Hiding all trades loading skeletons...');
    
    // Hide all loading skeletons
    document.querySelectorAll('.loading-skeleton, .loading-skeleton-stat').forEach(skeleton => {
        skeleton.style.display = 'none';
        // Mark parent as loaded
        const parent = skeleton.closest('[data-metric], [data-stat]');
        if (parent) {
            parent.setAttribute('data-loaded', 'true');
        }
    });
    
    // Update all stat cards to loaded state
    document.querySelectorAll('.stat-card').forEach(card => {
        card.classList.add('stat-loaded');
        card.classList.remove('stat-loading');
        card.setAttribute('data-loading-state', 'loaded');
    });
    
    console.log('âœ… All trades loading skeletons hidden successfully');
}

// Utility: normalize timestamp to Date
function parseTimestamp(ts) {
    if (!ts && ts !== 0) return null;
    if (typeof ts === 'string') {
        const d = new Date(ts);
        return isNaN(d.getTime()) ? null : d;
    }
    if (typeof ts === 'number') {
        // seconds vs ms
        const ms = ts < 1e12 ? ts * 1000 : ts;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
    }
    return null;
}

function getConfidencePercent(value) {
    if (value === null || value === undefined) return 0;
    const n = Number(value);
    if (!isFinite(n)) return 0;
    // Treat 0..1 as probability, else assume already percent
    return n <= 1 ? n * 100 : n;
}

function normalizeTradesResponse(data) {
    // Expect either { success, trades, summary } or a direct array
    if (data && Array.isArray(data.trades)) {
        const trades = data.trades;
        const summary = data.summary && typeof data.summary === 'object'
            ? data.summary
            : computeSummary(trades);
        return { trades, summary };
    }
    if (Array.isArray(data)) {
        return { trades: data, summary: computeSummary(data) };
    }
    // Some APIs return { items: [] } or { results: [] }
    if (data && Array.isArray(data.items)) {
        return { trades: data.items, summary: computeSummary(data.items) };
    }
    if (data && Array.isArray(data.results)) {
        return { trades: data.results, summary: computeSummary(data.results) };
    }
    // Fallback to empty
    return { trades: [], summary: computeSummary([]) };
}

function computeSummary(trades) {
    const now = Date.now();
    const recentCutoff = now - 24 * 60 * 60 * 1000;

    let totalSignals = 0;
    let buySignals = 0;
    let sellSignals = 0;
    let recent24h = 0;
    let totalTrades = 0;
    let confSum = 0;
    let confCount = 0;

    for (const t of trades) {
        const action = String(t?.action || t?.side || '').toUpperCase();
        const type = String(t?.signal_type || '').toUpperCase();

        // Count actions
        if (['BUY', 'SELL', 'WAIT', 'AVOID'].includes(action)) {
            totalSignals += 1;
            if (action === 'BUY') buySignals += 1;
            if (action === 'SELL') sellSignals += 1;
        }

        // Count executed trades
        if (type === 'TRADE' || String(t?.status || '').toUpperCase() === 'EXECUTED' || String(t?.status || '').toUpperCase() === 'FILLED') {
            totalTrades += 1;
        }

        // 24h recency
        const d = parseTimestamp(t?.timestamp);
        if (d && d.getTime() >= recentCutoff) {
            recent24h += 1;
        }

        // Confidence
        const cp = getConfidencePercent(t?.confidence);
        if (cp > 0) {
            confSum += cp;
            confCount += 1;
        }
    }

    const avgConfidence = confCount > 0 ? confSum / confCount : 0;

    return {
        total_signals: totalSignals || trades.length, // fallback to count if signals missing
        buy_signals: buySignals,
        sell_signals: sellSignals,
        recent_24h: recent24h,
        avg_confidence: avgConfidence,
        total_trades: totalTrades
    };
}

// Initialize page
// ðŸ”§ TRADES DEBUG FUNCTIONS
const TradesDebug = {
    // Inspect trades state
    inspectState() {
        TradingDebug.log('ðŸ“Š Trades State Inspection');
        TradingDebug.inspectState('trades data', window.tradesData);
        TradingDebug.inspectState('filtered trades', window.filteredTrades);
    },
    
    // Debug trades loading
    async debugTrades() {
        TradingDebug.log('ðŸ“Š Testing trades loading...');
        try {
            await loadTradesData();
            TradingDebug.log('ðŸ“Š Trades loaded successfully');
            this.inspectState();
        } catch (error) {
            TradingDebug.trackError(error, 'Trades Loading');
        }
    },
    
    // Test trades APIs
    async testAPIs() {
        TradingDebug.log('ðŸ“Š Testing Trades APIs...');
        const endpoints = [
            '/api/trades',
            '/api/current-holdings'
        ];
        
        for (const endpoint of endpoints) {
            await TradingDebug.helpers.testAPI(endpoint);
        }
    },
    
    // Debug filters
    debugFilters() {
        TradingDebug.log('ðŸ“Š Filter Debug:');
        const symbolFilter = document.getElementById('symbol-filter');
        const actionFilter = document.getElementById('action-filter');
        
        console.log('Symbol Filter:', symbolFilter?.value);
        console.log('Action Filter:', actionFilter?.value);
        this.inspectState();
    }
};

// Add trades debug to global scope
window.tradesDebug = TradesDebug;

document.addEventListener('DOMContentLoaded', function() {
    loadTradesData();
    
    // Setup filter event listeners safely
    const sf = document.getElementById('symbol-filter');
    const af = document.getElementById('action-filter');
    const tf = document.getElementById('type-filter');
    sf && sf.addEventListener('change', applyFilters);
    af && af.addEventListener('change', applyFilters);
    tf && tf.addEventListener('change', applyFilters);
});

async function loadTradesData() {
    try {
        showLoading(true);
        console.log('ðŸ”„ Loading trades data with enhanced animations...');
        
        // REPAIR: Reset stat cards to loading state with proper tracking
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.remove('stat-loaded');
            card.classList.add('stat-loading');
            card.setAttribute('data-loading-state', 'loading');
        });
        
        const response = await fetch('/api/trades', { method: 'GET' });
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        const normalized = normalizeTradesResponse(data);
        
        allTradesData = Array.isArray(normalized.trades) ? normalized.trades : [];
        window.tradesData = allTradesData; // expose for debug
        
        // Add slight delay to show loading animation
        setTimeout(() => {
            updateSummaryStats(normalized.summary || computeSummary(allTradesData));
            populateSymbolFilter();
            applyFilters();
            
            // REPAIR: Ensure all loading skeletons are properly hidden
            hideAllLoadingSkeletons();
            
            console.log('âœ… Trades data loaded with animations:', allTradesData.length, 'records');
        }, 300);
        
    } catch (error) {
        console.error('âŒ Failed to load trades data:', error);
        showToast(`Failed to load trades: ${error.message}`, 'error');
        showEmptyState();
    } finally {
        setTimeout(() => showLoading(false), 400);
    }
}

function updateSummaryStats(summary) {
    if (!summary) return;
    // Enhanced loading to data transition with animations
    const stats = [
        { id: 'total-signals', value: summary.total_signals ?? 0, suffix: '' },
        { id: 'buy-signals', value: summary.buy_signals ?? 0, suffix: '' },
        { id: 'sell-signals', value: summary.sell_signals ?? 0, suffix: '' },
        { id: 'recent-24h', value: summary.recent_24h ?? 0, suffix: '' },
        { id: 'avg-confidence', value: (summary.avg_confidence ?? 0).toFixed(1), suffix: '%' },
        { id: 'total-trades', value: summary.total_trades ?? 0, suffix: '' }
    ];
    
    stats.forEach((stat, index) => {
        setTimeout(() => {
            const element = document.getElementById(stat.id);
            if (!element) return;
            const parent = element.closest('.stat-card');
            if (!parent) return;
            
            // Add loading state
            parent.classList.add('stat-loading');
            
            setTimeout(() => {
                // Replace loading skeleton with actual data
                element.innerHTML = `<span style="opacity: 0; transform: translateY(10px); transition: all 0.4s ease;">${stat.value}${stat.suffix}</span>`;
                
                // Trigger animation
                requestAnimationFrame(() => {
                    const span = element.querySelector('span');
                    if (span) {
                        span.style.opacity = '1';
                        span.style.transform = 'translateY(0)';
                    }
                    parent.classList.remove('stat-loading');
                    parent.classList.add('stat-loaded');
                });
            }, 200);
        }, index * 100); // Stagger the animations
    });
}

function populateSymbolFilter() {
    const symbols = [...new Set(allTradesData.map(t => (t.symbol || t.pair || '').toString())
        .filter(s => s && s !== 'N/A')
        .map(s => s.includes('-') ? s.split('-')[0] : (s.includes('/') ? s.split('/')[0] : s))
    )].sort();
    const symbolFilter = document.getElementById('symbol-filter');
    if (!symbolFilter) return;
    
    // Clear existing options except "All Symbols"
    symbolFilter.innerHTML = '<option value="">All Symbols</option>';
    
    symbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolFilter.appendChild(option);
    });
}

function applyFilters() {
    const symbolFilter = document.getElementById('symbol-filter')?.value || '';
    const actionFilter = document.getElementById('action-filter')?.value || '';
    const typeFilter = document.getElementById('type-filter')?.value || '';
    
    filteredData = allTradesData.filter(trade => {
        const rawSymbol = (trade.symbol || trade.pair || '').toString();
        const normalizedSymbol = rawSymbol.includes('-') ? rawSymbol.split('-')[0] : (rawSymbol.includes('/') ? rawSymbol.split('/')[0] : rawSymbol);
        const symbolMatch = !symbolFilter || normalizedSymbol === symbolFilter;

        const action = String(trade.action || trade.side || '').toUpperCase();
        const actionMatch = !actionFilter || action === actionFilter;

        const signalType = String(trade.signal_type || (['BUY', 'SELL', 'WAIT', 'AVOID'].includes(action) ? 'SIGNAL' : 'TRADE')).toUpperCase();
        const typeMatch = !typeFilter || signalType === typeFilter;
        
        return symbolMatch && actionMatch && typeMatch;
    });
    
    window.filteredTrades = filteredData; // expose for debug
    renderTradesTable();
}

function renderTradesTable() {
    const tbody = document.getElementById('trades-tbody');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    if (!tbody || !table || !emptyState) return;
    
    if (!Array.isArray(filteredData) || filteredData.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filteredData.map(trade => {
        const d = parseTimestamp(trade.timestamp);
        const timeStr = d ? d.toLocaleString() : 'â€”';
        
        // Action badge
        const actionRaw = String(trade.action || trade.side || '').toUpperCase();
        const actionDisplay = actionRaw || 'N/A';
        const signalClass = getSignalClass(actionRaw);
        const signalBadge = `<span class="signal-badge ${signalClass}">${actionDisplay}</span>`;
        
        // Type badge
        const signalType = String(trade.signal_type || (['BUY', 'SELL', 'WAIT', 'AVOID'].includes(actionRaw) ? 'SIGNAL' : 'TRADE')).toUpperCase();
        const typeBadgeClass = signalType === 'TRADE' ? 'type-trade' : 'type-signal';
        const typeBadge = `<span class="type-badge ${typeBadgeClass}">${signalType}</span>`;
        
        // Confidence bar
        const confidence = getConfidencePercent(trade.confidence || 0);
        const confidenceClass = confidence >= 70 ? 'confidence-high' : confidence >= 50 ? 'confidence-medium' : 'confidence-low';
        const confidenceBar = `
            <div class="confidence-bar">
                <div class="confidence-fill ${confidenceClass}" style="width: ${Math.max(0, Math.min(100, confidence))}%"></div>
            </div>
            <small style="color: #9ca3af;">${confidence.toFixed(1)}%</small>
        `;
        
        // Technical indicators
        const technical = [];
        const rsi = Number(trade.rsi);
        if (isFinite(rsi) && rsi > 0) technical.push(`RSI: ${rsi.toFixed(1)}`);
        const vol = Number(trade.volatility);
        if (isFinite(vol) && vol > 0) technical.push(`Vol: ${vol.toFixed(1)}%`);
        if (trade.volume_ratio) technical.push('Volume âœ“');
        if (trade.momentum) technical.push('Momentum âœ“');
        if (trade.support) technical.push('Support âœ“');
        if (trade.bollinger) technical.push('BB âœ“');
        const technicalStr = technical.length > 0 ? technical.slice(0, 2).join('<br>') : 'N/A';
        
        // ML data
        let mlData = 'N/A';
        if (trade.ml_probability !== null && trade.ml_probability !== undefined) {
            const p = Number(trade.ml_probability);
            const pPct = isFinite(p) ? (p <= 1 ? p * 100 : p) : 0;
            mlData = `P: ${pPct.toFixed(1)}%`;
            const pr = Number(trade.predicted_return);
            if (isFinite(pr)) {
                mlData += `<br>Return: ${pr.toFixed(1)}%`;
            }
        }
        
        // Price formatting
        const priceNum = Number(trade.price);
        const price = isFinite(priceNum) && priceNum > 0
            ? `$${priceNum.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}`
            : 'N/A';
        
        // Symbol with tag
        const rawSymbol = (trade.symbol || trade.pair || '').toString();
        const cleanSymbol = rawSymbol.includes('-') ? rawSymbol.split('-')[0] : (rawSymbol.includes('/') ? rawSymbol.split('/')[0] : rawSymbol);
        const symbolDisplay = cleanSymbol ? `<span class="symbol-tag">${cleanSymbol}</span>` : 'N/A';
        
        // Status
        const status = (trade.status || '').toString().toUpperCase();
        const statusBadgeClass = status === 'FILLED' || status === 'EXECUTED' ? 'bg-success' : status === 'CANCELED' ? 'bg-secondary' : 'bg-info';
        const statusLabel = status || (signalType === 'SIGNAL' ? 'SIGNAL' : 'â€”');
        
        return `
            <tr>
                <td>
                    <div style="font-size: 0.85rem;">${timeStr}</div>
                </td>
                <td>${symbolDisplay}</td>
                <td>${typeBadge}</td>
                <td>${signalBadge}</td>
                <td class="text-end">${price}</td>
                <td>${confidenceBar}</td>
                <td><small>${technicalStr}</small></td>
                <td><small>${mlData}</small></td>
                <td>
                    <span class="badge ${statusBadgeClass}">
                        <i class="fas fa-check-circle me-1"></i>
                        ${statusLabel}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function getSignalClass(action) {
    switch ((action || '').toUpperCase()) {
        case 'BUY': return 'signal-buy';
        case 'SELL': return 'signal-sell';
        case 'WAIT': return 'signal-wait';
        case 'AVOID': return 'signal-avoid';
        default: return 'signal-wait';
    }
}

function clearFilters() {
    const sf = document.getElementById('symbol-filter');
    const af = document.getElementById('action-filter');
    const tf = document.getElementById('type-filter');
    if (sf) sf.value = '';
    if (af) af.value = '';
    if (tf) tf.value = '';
    applyFilters();
}

function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    const lastUpdated = document.getElementById('last-updated');
    
    if (spinner) spinner.style.display = show ? 'block' : 'none';
    if (table) table.style.display = show ? 'none' : 'table';
    if (emptyState) emptyState.style.display = 'none';
    
    if (lastUpdated) {
        if (show) {
            lastUpdated.textContent = 'Loading data...';
            lastUpdated.style.color = '#f59e0b';
        } else {
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            lastUpdated.style.color = '#22c55e';
        }
    }
}

function showEmptyState() {
    const spinner = document.getElementById('loading-spinner');
    const table = document.getElementById('trades-table');
    const emptyState = document.getElementById('empty-state');
    if (spinner) spinner.style.display = 'none';
    if (table) table.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
}

// Auto-refresh every 30 seconds
setInterval(loadTradesData, 30000);
</script>
{% endblock %}