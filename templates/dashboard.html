{% extends "base_layout.html" %}

{% block title %}Trading Intelligence Dashboard - Hybrid Trading Platform{% endblock %}

{% block extra_css %}
<style>
/* Dashboard-specific styling */
.dashboard-header {
    background: linear-gradient(135deg, var(--accent-blue) 0%, var(--secondary-dark) 100%);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.metric-card {
    background: linear-gradient(135deg, rgba(15, 52, 96, 0.4) 0%, rgba(22, 33, 62, 0.4) 100%);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-blue);
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.metric-card:hover::before {
    background: var(--success-green);
}

.metric-value {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.metric-label {
    font-size: 0.9rem;
    color: var(--text-light);
    opacity: 0.8;
    margin-bottom: 5px;
}

.metric-change {
    font-size: 0.8rem;
    font-weight: 600;
}

.dashboard-section {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-light);
    margin: 0;
}

.status-indicator {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-live { background: var(--success-green); color: white; }
.status-warning { background: var(--warning-orange); color: white; }
.status-error { background: var(--danger-red); color: white; }

.chart-container {
    position: relative;
    height: 300px;
    margin: 15px 0;
}

.signal-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.signal-BUY { background: var(--success-green); color: white; }
.signal-CONSIDER { background: var(--warning-orange); color: white; }
.signal-WAIT { background: #6c757d; color: white; }
.signal-AVOID { background: var(--danger-red); color: white; }

.ml-confidence {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    background: rgba(40, 167, 69, 0.2);
    color: var(--success-green);
}

/* Remove this since table-v02 handles hover effects */

.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--accent-blue);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 0.85rem;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.refresh-indicator.show {
    opacity: 1;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent-blue);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

@media (max-width: 768px) {
    .two-column {
        grid-template-columns: 1fr;
    }
    .metric-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}

/* --- Table v02: robust, bootstrap-proof styles --- */

/* Fallbacks if not defined in :root */
:root {
  --v02-head-bg: #6c7ae0;
  --v02-head-fg: #ffffff;
  --v02-row-hover: rgba(108, 122, 224, 0.12);
  --v02-row-alt: rgba(255,255,255,0.02);
  --v02-border: rgba(255,255,255,0.12);
  --v02-fg: #e5e7eb;
}

/* Increase specificity with a parent scope to beat older rules */
.dashboard-section .table-v02,
.dashboard-section .table-v02--compact {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  color: var(--v02-fg);
  background: transparent;
  /* In case bootstrap's table overrides fonts/line-height */
  font: 500 13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

/* Prevent .table (Bootstrap) rules from leaking if present by mistake */
.dashboard-section .table-v02.table,
.dashboard-section .table-v02--compact.table {
  /* neutralize bootstrap table background/borders */
  background-color: transparent !important;
  border-color: var(--v02-border) !important;
}

/* Head */
.dashboard-section .table-v02 thead th,
.dashboard-section .table-v02--compact thead th {
  background: var(--v02-head-bg);
  color: var(--v02-head-fg);
  padding: 10px 12px;
  font-weight: 700;
  letter-spacing: 0.02em;
  position: sticky;
  top: 0;
  z-index: 1;
  border-bottom: 1px solid var(--v02-border);
  white-space: nowrap;
}

/* Body rows */
.dashboard-section .table-v02 tbody tr,
.dashboard-section .table-v02--compact tbody tr {
  border-bottom: 1px solid var(--v02-border);
  background: transparent;
}
.dashboard-section .table-v02 tbody tr:nth-child(even),
.dashboard-section .table-v02--compact tbody tr:nth-child(even) {
  background: var(--v02-row-alt);
}
.dashboard-section .table-v02 tbody tr:hover,
.dashboard-section .table-v02--compact tbody tr:hover {
  background: var(--v02-row-hover);
}

/* Cells */
.dashboard-section .table-v02 th, 
.dashboard-section .table-v02 td,
.dashboard-section .table-v02--compact th,
.dashboard-section .table-v02--compact td {
  padding: 10px 12px;
  vertical-align: middle;
}

/* Compact variant */
.dashboard-section .table-v02--compact th,
.dashboard-section .table-v02--compact td {
  padding: 8px 10px;
  font-size: 12px;
}

/* Header accent color via CSS var inline on table (you already set style="--v02-head-bg:#6c7ae0;") */
.dashboard-section .table-v02[style*="--v02-head-bg"] thead th,
.dashboard-section .table-v02--compact[style*="--v02-head-bg"] thead th {
  background: var(--v02-head-bg) !important;
}

/* Utility aligns â€“ don't rely on Bootstrap .text-end/.text-center if legacy CSS overrides */
.t-right { text-align: right !important; }
.t-center { text-align: center !important; }
</style>
{% endblock %}

{% block content %}
<!-- Refresh Indicator -->
<div id="refreshIndicator" class="refresh-indicator">
    <i class="fas fa-sync-alt"></i> Updating data...
</div>

<div class="content-wrapper">
    <div class="container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line text-warning"></i>
                        Trading Intelligence Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">
                        Live portfolio monitoring with ML-powered signal analysis and OKX integration
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="systemStatus" class="status-indicator status-live">
                        <i class="fas fa-circle"></i> SYSTEM LIVE
                    </div>
                    <div class="mt-2">
                        <small id="lastUpdate" class="text-muted">Last updated: --</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Performance Metrics -->
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value text-info" id="portfolioValue">$0.00</div>
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-change" id="portfolioChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalPnL">$0.00</div>
                <div class="metric-label">Total P&L</div>
                <div class="metric-change" id="pnlPercent">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-value text-warning" id="activePositions">0</div>
                <div class="metric-label">Active Positions</div>
                <div class="metric-change" id="winRate">-- Win Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value text-success" id="mlAccuracy">0%</div>
                <div class="metric-label">ML Accuracy</div>
                <div class="metric-change" id="signalsToday">-- Signals Today</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Portfolio Performance Chart -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-area text-info"></i>
                        Portfolio Performance
                    </h3>
                    <span class="text-muted small">30-day trend</span>
                </div>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>

            <!-- ML Signal Intelligence -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-brain text-warning"></i>
                        ML Signal Intelligence
                    </h3>
                    <span class="text-muted small">Recent predictions</span>
                </div>
                <div class="table-responsive">
                    <table class="table-v02 table-v02--compact" style="--v02-head-bg: #6c7ae0;">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>ML Score</th>
                                <th>Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="mlSignalsBody">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="loading-spinner"></div>
                                    Loading ML signals...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Current Holdings Overview -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-wallet text-success"></i>
                    Current Holdings Performance
                </h3>
                <div>
                    <span class="text-muted small">Live OKX data</span>
                    <i class="fas fa-circle text-success ms-1" style="font-size: 8px;"></i>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table-v02" style="--v02-head-bg: #6c7ae0;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Entry Price</th>
                            <th class="text-end">Current Price</th>
                            <th class="text-end">Market Value</th>
                            <th class="text-end">P&L</th>
                            <th class="text-end">P&L %</th>
                            <th class="text-center">Trend</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="loading-spinner"></div>
                                Loading portfolio positions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="two-column">
            <!-- Risk Metrics -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-shield-alt text-danger"></i>
                        Risk Analysis
                    </h3>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="maxDrawdown">--</div>
                            <small class="text-muted">Max Drawdown</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="sharpeRatio">--</div>
                            <small class="text-muted">Sharpe Ratio</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="volatility">--</div>
                            <small class="text-muted">Volatility</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="exposureRisk">--</div>
                            <small class="text-muted">Risk Exposure</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-trophy text-warning"></i>
                        Performance Leaders
                    </h3>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <div id="bestPerformer" class="text-center p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                            <div class="loading-spinner"></div>
                            Loading best performer...
                        </div>
                    </div>
                    <div class="col-12">
                        <div id="worstPerformer" class="text-center p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                            <div class="loading-spinner"></div>
                            Loading worst performer...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health & Activity -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-heartbeat text-info"></i>
                    System Health & Activity
                </h3>
            </div>
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="apiStatus">
                        <i class="fas fa-circle text-success"></i> OKX API
                    </div>
                    <small class="text-muted">Exchange Connection</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="mlStatus">
                        <i class="fas fa-circle text-success"></i> ML Engine
                    </div>
                    <small class="text-muted">Prediction System</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="dataSync">
                        <i class="fas fa-sync text-warning"></i> Data Sync
                    </div>
                    <small class="text-muted">Real-time Updates</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="riskEngine">
                        <i class="fas fa-shield text-info"></i> Risk Engine
                    </div>
                    <small class="text-muted">Safety Controls</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class TradingDashboard {
    constructor() {
        this.charts = {};
        this.refreshInterval = 30000; // 30 seconds
        this.init();
    }

    init() {
        console.log('ðŸš€ Initializing Trading Intelligence Dashboard');
        this.loadAllData();
        this.startAutoRefresh();
        console.log('âœ… Dashboard initialization complete');
    }

    async loadAllData() {
        this.showRefreshIndicator();
        try {
            await Promise.all([
                this.loadPortfolioOverview(),
                this.loadMLSignals(),
                this.loadHoldings(),
                this.loadChartData(),
                this.loadRiskMetrics()
            ]);
            this.updateLastUpdateTime();
        } catch (error) {
            console.error('âŒ Error loading dashboard data:', error);
            this.updateSystemStatus('error');
        } finally {
            this.hideRefreshIndicator();
        }
    }

    async loadPortfolioOverview() {
        try {
            const response = await fetch('/api/performance-overview');
            const data = await response.json();
            
            if (data.success) {
                this.updatePortfolioMetrics(data);
                this.updateTopPerformers(data.top_performers);
            }
        } catch (error) {
            console.error('âŒ Error loading portfolio overview:', error);
        }
    }

    async loadMLSignals() {
        try {
            const response = await fetch('/api/signal-tracking');
            const data = await response.json();
            
            if (data.success) {
                this.updateMLSignalsTable(data.recent_signals);
            }
        } catch (error) {
            console.error('âŒ Error loading ML signals:', error);
        }
    }

    async loadHoldings() {
        try {
            const response = await fetch('/api/trade-performance');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.trades) {
                this.updateHoldingsTable(data.trades);
                this.updateRiskMetrics(data.trade_summary);
                console.log('âœ… Holdings loaded successfully:', data.trades.length, 'positions');
            } else {
                console.warn('âš ï¸ Holdings data missing or unsuccessful:', data);
            }
        } catch (error) {
            console.error('âŒ Error loading holdings:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
        }
    }

    async loadChartData() {
        try {
            const response = await fetch('/api/performance-charts');
            const data = await response.json();
            
            if (data.success) {
                this.updatePortfolioChart(data.pnl_curve);
            }
        } catch (error) {
            console.error('âŒ Error loading chart data:', error);
        }
    }

    async loadRiskMetrics() {
        try {
            // This would connect to a risk analytics endpoint when available
            // For now, we'll calculate from available data
        } catch (error) {
            console.error('âŒ Error loading risk metrics:', error);
        }
    }

    updatePortfolioMetrics(data) {
        const metrics = data.portfolio_metrics;
        const signals = data.signal_metrics;

        document.getElementById('portfolioValue').textContent = `$${metrics.total_value.toLocaleString()}`;
        document.getElementById('totalPnL').textContent = `$${metrics.total_pnl.toFixed(2)}`;
        document.getElementById('totalPnL').className = `metric-value ${metrics.total_pnl >= 0 ? 'text-success' : 'text-danger'}`;
        document.getElementById('pnlPercent').textContent = `${metrics.total_pnl_percent.toFixed(2)}%`;
        document.getElementById('pnlPercent').className = `metric-change ${metrics.total_pnl_percent >= 0 ? 'text-success' : 'text-danger'}`;
        
        document.getElementById('activePositions').textContent = metrics.total_positions;
        document.getElementById('winRate').textContent = `${metrics.win_rate}% Win Rate`;
        
        document.getElementById('mlAccuracy').textContent = `${signals.ml_accuracy}%`;
        document.getElementById('signalsToday').textContent = `${signals.signals_today} Signals Today`;
    }

    updateMLSignalsTable(signals) {
        const tbody = document.getElementById('mlSignalsBody');
        
        if (!signals || signals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent ML signals</td></tr>';
            return;
        }

        tbody.innerHTML = signals.slice(0, 5).map(signal => {
            const hybridScore = (signal.hybrid_score || 0);
            return `
            <tr>
                <td><strong>${signal.symbol || 'N/A'}</strong></td>
                <td><span class="signal-badge signal-${signal.signal || 'WAIT'}">${signal.signal || 'WAIT'}</span></td>
                <td><span class="ml-confidence">${hybridScore.toFixed(1)}%</span></td>
                <td class="${signal.pnl_percent !== null ? (signal.pnl_percent >= 0 ? 'text-success' : 'text-danger') : 'text-muted'}">
                    ${(signal.outcome || 'pending').replace('_', ' ')}
                </td>
            </tr>
        `;}).join('');
    }

    updateHoldingsTable(trades) {
        const tbody = document.getElementById('holdingsBody');
        
        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No active positions</td></tr>';
            return;
        }

        tbody.innerHTML = trades.slice(0, 10).map(trade => {
            // Safely handle potentially undefined values
            const quantity = (trade.quantity || 0);
            const entryPrice = (trade.entry_price || 0);
            const currentPrice = (trade.current_price || 0);
            const marketValue = (trade.market_value || 0);
            const pnlUsd = (trade.pnl_usd || 0);
            const pnlPercent = (trade.pnl_percent || 0);
            
            const pnlClass = pnlPercent >= 0 ? 'text-success' : 'text-danger';
            const trendIcon = pnlPercent >= 0 ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger';
            
            return `
                <tr>
                    <td><strong>${trade.symbol || 'N/A'}</strong></td>
                    <td class="text-end">${quantity.toFixed(4)}</td>
                    <td class="text-end">$${entryPrice.toFixed(4)}</td>
                    <td class="text-end">$${currentPrice.toFixed(4)}</td>
                    <td class="text-end">$${marketValue.toFixed(2)}</td>
                    <td class="text-end ${pnlClass}">$${pnlUsd.toFixed(2)}</td>
                    <td class="text-end ${pnlClass}">${pnlPercent.toFixed(2)}%</td>
                    <td class="text-center"><i class="fas ${trendIcon}"></i></td>
                </tr>
            `;
        }).join('');
    }

    updateTopPerformers(performers) {
        const bestEl = document.getElementById('bestPerformer');
        const worstEl = document.getElementById('worstPerformer');

        if (performers.best) {
            const bestPnlPercent = (performers.best.pnl_percent || 0);
            const bestPnlUsd = (performers.best.pnl_usd || 0);
            bestEl.innerHTML = `
                <div class="h4 text-success mb-1">${performers.best.symbol || 'N/A'}</div>
                <div class="text-success h5 mb-1">+${bestPnlPercent.toFixed(2)}%</div>
                <small class="text-muted">$${bestPnlUsd.toFixed(2)} profit</small>
            `;
        } else {
            bestEl.innerHTML = '<p class="text-muted mb-0">No profit positions</p>';
        }

        if (performers.worst) {
            const worstPnlPercent = (performers.worst.pnl_percent || 0);
            const worstPnlUsd = (performers.worst.pnl_usd || 0);
            worstEl.innerHTML = `
                <div class="h4 text-danger mb-1">${performers.worst.symbol || 'N/A'}</div>
                <div class="text-danger h5 mb-1">${worstPnlPercent.toFixed(2)}%</div>
                <small class="text-muted">$${worstPnlUsd.toFixed(2)} loss</small>
            `;
        } else {
            worstEl.innerHTML = '<p class="text-muted mb-0">No loss positions</p>';
        }
    }

    updateRiskMetrics(summary) {
        if (summary) {
            document.getElementById('maxDrawdown').textContent = `${summary.max_drawdown || 0}%`;
            document.getElementById('sharpeRatio').textContent = `${summary.sharpe_ratio || 0}`;
            document.getElementById('volatility').textContent = `${(Math.abs(summary.avg_pnl_percent) * 2).toFixed(1)}%`;
            document.getElementById('exposureRisk').textContent = summary.total_trades > 15 ? 'HIGH' : 'MODERATE';
        }
    }

    updatePortfolioChart(data) {
        const ctx = document.getElementById('portfolioChart').getContext('2d');
        
        if (this.charts.portfolio) {
            this.charts.portfolio.destroy();
        }

        this.charts.portfolio = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                datasets: [{
                    label: 'Portfolio Value',
                    data: data.values || [1000, 1020, 995, 1045, 1067],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#36A2EB',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#adb5bd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { 
                            color: '#adb5bd',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    updateSystemStatus(status) {
        const statusEl = document.getElementById('systemStatus');
        switch(status) {
            case 'live':
                statusEl.className = 'status-indicator status-live';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> SYSTEM LIVE';
                break;
            case 'warning':
                statusEl.className = 'status-indicator status-warning';
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> WARNING';
                break;
            case 'error':
                statusEl.className = 'status-indicator status-error';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> ERROR';
                break;
        }
    }

    updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }

    showRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.add('show');
    }

    hideRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.remove('show');
    }

    startAutoRefresh() {
        setInterval(() => {
            this.loadAllData();
        }, this.refreshInterval);
    }
}

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.dashboard = new TradingDashboard();
});
</script>

<script>
/* Remove legacy/Bootstrap classes that override v02 tables */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.table-v02, .table-v02--compact').forEach((el) => {
    // If Bootstrap .table slipped in via server/JS, kill it
    if (el.classList.contains('table')) el.classList.remove('table');
    // If any legacy class snuck in, strip common offenders
    ['table-striped','table-hover','table-sm','data-table','legacy-table'].forEach(c => {
      if (el.classList.contains(c)) el.classList.remove(c);
    });
    // Add a marker to help CSS specificity (if needed)
    el.setAttribute('data-style', 'v02');
  });
});
</script>
{% endblock %}