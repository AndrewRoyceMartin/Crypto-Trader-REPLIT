{% extends "base_layout.html" %}

{% block title %}Trading Intelligence Dashboard - Hybrid Trading Platform{% endblock %}

{% block extra_css %}
<style>
/* v02: variables (safe defaults) */
:root{
  --v02-head-bg:#6c7ae0; --v02-head-fg:#fff;
  --v02-row-hover:rgba(108,122,224,.12); --v02-row-alt:rgba(255,255,255,.02);
  --v02-border:rgba(255,255,255,.12); --v02-fg:#e5e7eb;
}

/* Boost specificity to beat Bootstrap & legacy */
.dashboard-section .table-responsive .table-v02,
.dashboard-section .table-v02,
.dashboard-section .table-v02--compact{
  width:100%; border-collapse:separate; border-spacing:0;
  color:var(--v02-fg); background:transparent;
  font:500 13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}

/* Kill Bootstrap skin if it sneaks in */
.dashboard-section .table-responsive .table-v02.table,
.dashboard-section .table-responsive .table-v02--compact.table,
.dashboard-section .table-v02.table,
.dashboard-section .table-v02--compact.table{
  background-color:transparent !important;
  border-color:var(--v02-border) !important;
}

/* Head */
.dashboard-section .table-responsive .table-v02 thead th,
.dashboard-section .table-responsive .table-v02--compact thead th,
.dashboard-section .table-v02 thead th,
.dashboard-section .table-v02--compact thead th{
  background:var(--v02-head-bg) !important; color:var(--v02-head-fg);
  padding:10px 12px; font-weight:700; letter-spacing:.02em;
  position:sticky; top:0; z-index:1; border-bottom:1px solid var(--v02-border);
  white-space:nowrap;
}

/* Rows */
.dashboard-section .table-responsive .table-v02 tbody tr,
.dashboard-section .table-responsive .table-v02--compact tbody tr,
.dashboard-section .table-v02 tbody tr,
.dashboard-section .table-v02--compact tbody tr{
  border-bottom:1px solid var(--v02-border); background:transparent;
}
.dashboard-section .table-responsive .table-v02 tbody tr:nth-child(even),
.dashboard-section .table-responsive .table-v02--compact tbody tr:nth-child(even),
.dashboard-section .table-v02 tbody tr:nth-child(even),
.dashboard-section .table-v02--compact tbody tr:nth-child(even){
  background:var(--v02-row-alt);
}
.dashboard-section .table-responsive .table-v02 tbody tr:hover,
.dashboard-section .table-responsive .table-v02--compact tbody tr:hover,
.dashboard-section .table-v02 tbody tr:hover,
.dashboard-section .table-v02--compact tbody tr:hover{
  background:var(--v02-row-hover);
}

/* Cells */
.dashboard-section .table-responsive .table-v02 th,
.dashboard-section .table-responsive .table-v02 td,
.dashboard-section .table-responsive .table-v02--compact th,
.dashboard-section .table-responsive .table-v02--compact td,
.dashboard-section .table-v02 th, .dashboard-section .table-v02 td,
.dashboard-section .table-v02--compact th, .dashboard-section .table-v02--compact td{
  padding:10px 12px; vertical-align:middle;
}

/* Compact variant */
.dashboard-section .table-v02--compact th,
.dashboard-section .table-v02--compact td{ padding:8px 10px; font-size:12px; }

/* ULTRA HIGH SPECIFICITY - Force blue headers regardless of Bootstrap */
.table-responsive .table-v02 thead th,
.table-responsive .table-v02--compact thead th,
div.table-responsive table.table-v02 thead th,
div.table-responsive table.table-v02--compact thead th {
  background-color: #6c7ae0 !important;
  background: #6c7ae0 !important;
  color: #ffffff !important;
  border-color: transparent !important;
}

/* Override any possible Bootstrap table inheritance */
.table-responsive .table-v02,
.table-responsive .table-v02--compact {
  --bs-table-bg: transparent !important;
  --bs-table-accent-bg: transparent !important;
  --bs-table-striped-bg: transparent !important;
  --bs-table-active-bg: transparent !important;
  --bs-table-hover-bg: transparent !important;
}

/* Dashboard-specific styling */
.dashboard-header {
    background: linear-gradient(135deg, var(--accent-blue) 0%, var(--secondary-dark) 100%);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.metric-card {
    background: linear-gradient(135deg, rgba(15, 52, 96, 0.4) 0%, rgba(22, 33, 62, 0.4) 100%);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-blue);
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.metric-card:hover::before {
    background: var(--success-green);
}

.metric-value {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.metric-label {
    font-size: 0.9rem;
    color: var(--text-light);
    opacity: 0.8;
    margin-bottom: 5px;
}

.metric-change {
    font-size: 0.8rem;
    font-weight: 600;
}

.dashboard-section {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-light);
    margin: 0;
}

.status-indicator {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-live { background: var(--success-green); color: white; }
.status-warning { background: var(--warning-orange); color: white; }
.status-error { background: var(--danger-red); color: white; }

.chart-container {
    position: relative;
    height: 300px;
    margin: 15px 0;
}

.signal-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.signal-BUY { background: var(--success-green); color: white; }
.signal-CONSIDER { background: var(--warning-orange); color: white; }
.signal-WAIT { background: #6c757d; color: white; }
.signal-AVOID { background: var(--danger-red); color: white; }

.ml-confidence {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    background: rgba(40, 167, 69, 0.2);
    color: var(--success-green);
}

/* Remove this since table-v02 handles hover effects */

.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--accent-blue);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 0.85rem;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.refresh-indicator.show {
    opacity: 1;
}


.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

@media (max-width: 768px) {
    .two-column {
        grid-template-columns: 1fr;
    }
    .metric-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}

/* --- Table v02: robust, bootstrap-proof styles --- */

/* Fallbacks if not defined in :root */
:root {
  --v02-head-bg: #6c7ae0;
  --v02-head-fg: #ffffff;
  --v02-row-hover: rgba(108, 122, 224, 0.12);
  --v02-row-alt: rgba(255,255,255,0.02);
  --v02-border: rgba(255,255,255,0.12);
  --v02-fg: #e5e7eb;
}

/* Increase specificity with a parent scope to beat older rules */
.dashboard-section .table-v02,
.dashboard-section .table-v02--compact {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  color: var(--v02-fg);
  background: transparent;
  /* In case bootstrap's table overrides fonts/line-height */
  font: 500 13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

/* Prevent .table (Bootstrap) rules from leaking if present by mistake */
.dashboard-section .table-v02.table,
.dashboard-section .table-v02--compact.table {
  /* neutralize bootstrap table background/borders */
  background-color: transparent !important;
  border-color: var(--v02-border) !important;
}

/* Head */
.dashboard-section .table-v02 thead th,
.dashboard-section .table-v02--compact thead th {
  background: var(--v02-head-bg);
  color: var(--v02-head-fg);
  padding: 10px 12px;
  font-weight: 700;
  letter-spacing: 0.02em;
  position: sticky;
  top: 0;
  z-index: 1;
  border-bottom: 1px solid var(--v02-border);
  white-space: nowrap;
}

/* Body rows */
.dashboard-section .table-v02 tbody tr,
.dashboard-section .table-v02--compact tbody tr {
  border-bottom: 1px solid var(--v02-border);
  background: transparent;
}
.dashboard-section .table-v02 tbody tr:nth-child(even),
.dashboard-section .table-v02--compact tbody tr:nth-child(even) {
  background: var(--v02-row-alt);
}
.dashboard-section .table-v02 tbody tr:hover,
.dashboard-section .table-v02--compact tbody tr:hover {
  background: var(--v02-row-hover);
}

/* Cells */
.dashboard-section .table-v02 th, 
.dashboard-section .table-v02 td,
.dashboard-section .table-v02--compact th,
.dashboard-section .table-v02--compact td {
  padding: 10px 12px;
  vertical-align: middle;
}

/* Compact variant */
.dashboard-section .table-v02--compact th,
.dashboard-section .table-v02--compact td {
  padding: 8px 10px;
  font-size: 12px;
}

/* Header accent color via CSS var inline on table (you already set style="--v02-head-bg:#6c7ae0;") */
.dashboard-section .table-v02[style*="--v02-head-bg"] thead th,
.dashboard-section .table-v02--compact[style*="--v02-head-bg"] thead th {
  background: var(--v02-head-bg) !important;
}

/* Utility aligns â€“ don't rely on Bootstrap .text-end/.text-center if legacy CSS overrides */
.t-right { text-align: right !important; }
.t-center { text-align: center !important; }

/* Enhanced Professional Loading Animations */
.loading-skeleton {
    background: linear-gradient(90deg, 
        rgba(156, 163, 175, 0.1) 25%, 
        rgba(156, 163, 175, 0.2) 50%, 
        rgba(156, 163, 175, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
    height: 1.4em;
}

.loading-skeleton-metric {
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.1) 25%, 
        rgba(255, 255, 255, 0.3) 50%, 
        rgba(255, 255, 255, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
    height: 2rem;
    width: 80%;
    margin: 0 auto;
}

.loading-skeleton-small {
    background: linear-gradient(90deg, 
        rgba(156, 163, 175, 0.1) 25%, 
        rgba(156, 163, 175, 0.2) 50%, 
        rgba(156, 163, 175, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
    height: 1rem;
    width: 60%;
    margin: 5px auto;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.metric-card-loading {
    opacity: 0.7;
    transform: scale(0.98);
    transition: all 0.4s ease;
}

.metric-card-loaded {
    opacity: 1;
    transform: scale(1);
    animation: cardAppear 0.6s ease-out;
}

@keyframes cardAppear {
    0% { 
        opacity: 0;
        transform: scale(0.95) translateY(10px);
    }
    100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.dashboard-status {
    font-size: 0.9rem;
    text-align: center;
    margin: 25px 0;
    padding: 12px 25px;
    border-radius: 30px;
    transition: all 0.3s ease;
    font-weight: 600;
    border: 2px solid transparent;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
}

.status-loading { 
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
    color: #f59e0b;
    border-color: rgba(245, 158, 11, 0.3);
}
.status-loaded { 
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.3);
}
.status-error { 
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.3);
}

.table-loading {
    text-align: center;
    padding: 30px 20px;
}

.table-skeleton-rows {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 0.4; }
}

</style>
{% endblock %}

{% block content %}
<!-- Refresh Indicator -->
<div id="refreshIndicator" class="refresh-indicator">
    <i class="fas fa-sync-alt"></i> Updating data...
</div>

<div class="content-wrapper">
    <div class="container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line text-warning"></i>
                        Trading Intelligence Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">
                        Live portfolio monitoring with ML-powered signal analysis and OKX integration
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="systemStatus" class="status-indicator status-live" data-status="system" data-value>
                        <i class="fas fa-circle"></i> SYSTEM LIVE
                    </div>
                    <div class="mt-2">
                        <small id="lastUpdate" class="text-muted-xs" data-timestamp>Last updated: --</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Performance Metrics -->
        <div class="metric-grid">
            <div class="metric-card" data-metric-card="portfolio">
                <div class="metric-value text-info" id="portfolioValue" data-metric="portfolioValue" data-currency data-value>
                    <div class="loading-skeleton loading-skeleton-metric"></div>
                </div>
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-change" id="portfolioChange" data-metric="portfolioChange" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-small"></div>
                </div>
            </div>
            <div class="metric-card" data-metric-card="pnl">
                <div class="metric-value" id="totalPnL" data-metric="totalPnL" data-currency data-value>
                    <div class="loading-skeleton loading-skeleton-metric"></div>
                </div>
                <div class="metric-label">Total P&L</div>
                <div class="metric-change" id="pnlPercent" data-metric="pnlPercent" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-small"></div>
                </div>
            </div>
            <div class="metric-card" data-metric-card="positions">
                <div class="metric-value text-warning" id="activePositions" data-metric="activePositions" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-metric"></div>
                </div>
                <div class="metric-label">Active Positions</div>
                <div class="metric-change" id="winRate" data-metric="winRate" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-small"></div>
                </div>
            </div>
            <div class="metric-card" data-metric-card="ml">
                <div class="metric-value text-success" id="mlAccuracy" data-metric="mlAccuracy" data-percentage data-value>
                    <div class="loading-skeleton loading-skeleton-metric"></div>
                </div>
                <div class="metric-label">ML Accuracy</div>
                <div class="metric-change" id="signalsToday" data-metric="signalsToday" data-count data-value>
                    <div class="loading-skeleton loading-skeleton-small"></div>
                </div>
            </div>
        </div>

        <!-- Status Indicator -->
        <div class="dashboard-status status-loading" id="dashboard-status" data-status="dashboard" data-loading>
            <i class="fas fa-sync fa-spin me-2"></i>Loading trading intelligence dashboard...
        </div>

        <div class="two-column">
            <!-- Portfolio Performance Chart -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-area text-info"></i>
                        Portfolio Performance
                    </h3>
                    <span class="text-muted-sm">30-day trend</span>
                </div>
                <div class="chart-container" data-chart="portfolio">
                    <canvas id="portfolioChart" data-chart-canvas="portfolio"></canvas>
                </div>
            </div>

            <!-- ML Signal Intelligence -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-brain text-warning"></i>
                        ML Signal Intelligence
                    </h3>
                    <span class="text-muted-sm">Recent predictions</span>
                </div>
                <div class="table-responsive">
                    <table class="table-v02 table-v02--compact" style="--v02-head-bg: #6c7ae0;">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>ML Score</th>
                                <th>Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="mlSignalsBody" data-table="mlSignals" data-content>
                            <tr>
                                <td colspan="4" class="t-center">
                                    <div class="loading-spinner"></div>
                                <div class="table-loading">
                                    <div class="table-skeleton-rows">
                                        <div class="loading-skeleton mb-2"></div>
                                        <div class="loading-skeleton mb-2"></div>
                                        <div class="loading-skeleton mb-2"></div>
                                    </div>
                                </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Current Holdings Overview -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-wallet text-success"></i>
                    Current Holdings Performance
                </h3>
                <div>
                    <span class="text-muted-sm">Live OKX data</span>
                    <i class="fas fa-circle text-success ms-1" style="font-size: 8px;"></i>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table-v02" style="--v02-head-bg: #6c7ae0;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th class="t-right">Quantity</th>
                            <th class="t-right">Entry Price</th>
                            <th class="t-right">Current Price</th>
                            <th class="t-right">Market Value</th>
                            <th class="t-right">P&L</th>
                            <th class="t-right">P&L %</th>
                            <th class="t-center">Trend</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody" data-table="holdings" data-content>
                        <tr>
                            <td colspan="8" class="t-center">
                                <div class="loading-spinner"></div>
                                <div class="table-loading">
                                    <div class="table-skeleton-rows">
                                        <div class="loading-skeleton mb-2"></div>
                                        <div class="loading-skeleton mb-2"></div>
                                        <div class="loading-skeleton mb-2"></div>
                                        <div class="loading-skeleton mb-2"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="two-column">
            <!-- Risk Metrics -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-shield-alt text-danger"></i>
                        Risk Analysis
                    </h3>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="maxDrawdown" data-metric="maxDrawdown" data-percentage data-value>
                                <div class="loading-skeleton loading-skeleton-metric"></div>
                            </div>
                            <small class="text-muted-xs">Max Drawdown</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="sharpeRatio" data-metric="sharpeRatio" data-ratio data-value>
                                <div class="loading-skeleton loading-skeleton-metric"></div>
                            </div>
                            <small class="text-muted-xs">Sharpe Ratio</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="volatility" data-metric="volatility" data-percentage data-value>
                                <div class="loading-skeleton loading-skeleton-metric"></div>
                            </div>
                            <small class="text-muted-xs">Volatility</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3">
                            <div class="h4 mb-1" id="exposureRisk" data-metric="exposureRisk" data-percentage data-value>
                                <div class="loading-skeleton loading-skeleton-metric"></div>
                            </div>
                            <small class="text-muted-xs">Risk Exposure</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-trophy text-warning"></i>
                        Performance Leaders
                    </h3>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <div id="bestPerformer" class="text-center p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 8px;" data-performer="best" data-content>
                            <div class="loading-spinner"></div>
                            <div class="table-skeleton-rows">
                                <div class="loading-skeleton mb-2"></div>
                                <div class="loading-skeleton loading-skeleton-small"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div id="worstPerformer" class="text-center p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;" data-performer="worst" data-content>
                            <div class="loading-spinner"></div>
                            <div class="table-skeleton-rows">
                                <div class="loading-skeleton mb-2"></div>
                                <div class="loading-skeleton loading-skeleton-small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health & Activity -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-heartbeat text-info"></i>
                    System Health & Activity
                </h3>
            </div>
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="apiStatus" data-health="api" data-status data-value>
                        <i class="fas fa-circle text-success"></i> OKX API
                    </div>
                    <small class="text-muted-xs">Exchange Connection</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="mlStatus" data-health="ml" data-status data-value>
                        <i class="fas fa-circle text-success"></i> ML Engine
                    </div>
                    <small class="text-muted-xs">Prediction System</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="dataSync" data-health="sync" data-status data-value>
                        <i class="fas fa-sync text-warning"></i> Data Sync
                    </div>
                    <small class="text-muted-xs">Real-time Updates</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="h5 mb-1" id="riskEngine" data-health="risk" data-status data-value>
                        <i class="fas fa-shield text-info"></i> Risk Engine
                    </div>
                    <small class="text-muted-xs">Safety Controls</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Bootstrap Module - Clean modular initialization -->
<script type="module" defer src="/static/js/bootstrap.js"></script>

{% endblock %}
