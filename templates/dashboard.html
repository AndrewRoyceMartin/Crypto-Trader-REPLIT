<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trading Intelligence • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Prefer /api/summary & /api/holdings; fall back to /api/portfolio/* -->
  <!-- If your view function names exist, these will resolve at build time. -->
  <meta name="api-summary" content="{{
    url_for('api.summary') if 'api.summary' in current_app.view_functions
    else (url_for('api_portfolio.summary') if 'api_portfolio.summary' in current_app.view_functions
    else '/api/summary')
  }}">
  <meta name="api-holdings" content="{{
    url_for('api.holdings') if 'api.holdings' in current_app.view_functions
    else (url_for('api_portfolio.holdings') if 'api_portfolio.holdings' in current_app.view_functions
    else '/api/holdings')
  }}">

  <style>
    :root { --gap:12px; --bg:#0b1020; --card:#0f172a; --line:#1f2937; --fg:#e5e7eb; --muted:#94a3b8; --red:#ef4444; --green:#16a34a; --amber:#f59e0b; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg) }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px }
    h1{ margin:0 0 6px; font-size:24px; font-weight:700 }
    .sub{ color:var(--muted); margin-bottom:18px; font-size:14px }
    .err{ background:#2a0f12; border:1px solid #7f1d1d; color:#fecaca; padding:10px 12px; border-radius:10px; margin-bottom:16px; display:none }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:var(--gap) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 0 0 1px rgba(255,255,255,.03) inset }
    .k{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em; margin-bottom:6px }
    .v{ font-size:22px; font-weight:700 }
    .asof{ font-size:12px; color:var(--muted); margin-top:6px }
    table{ width:100%; border-collapse:collapse; margin-top:18px; overflow:hidden; border-radius:12px }
    thead th{ text-align:left; font-size:12px; color:#cbd5e1; background:#111827; padding:10px; border-bottom:1px solid var(--line) }
    tbody td{ font-size:14px; padding:10px; border-bottom:1px solid var(--line) }
    tbody tr:hover{ background:rgba(255,255,255,.03) }
    .mono{ font-variant-numeric:tabular-nums }
    .green{ color:var(--green) } .amber{ color:var(--amber) } .red{ color:var(--red) } .muted{ color:var(--muted) }
    .skeleton{ display:inline-block; min-width:5ch; height:1em; border-radius:6px; background:linear-gradient(90deg,#111827,#0d1326,#111827); background-size:200% 100%; animation:sh 1.3s infinite }
    @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>

  <!-- Load Bootstrap BEFORE any legacy code that references it -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
</head>
<body data-page="dashboard">
  <div class="wrap">
    <h1>Dashboard</h1>
    <div class="sub">System Online • <span id="onlineState" class="muted">Loading trading intelligence dashboard…</span></div>

    <div id="err" class="err"></div>

    <div class="grid">
      <div class="card">
        <div class="k">Total Value</div>
        <div class="v mono" data-metric="totalValue"><span class="skeleton">&nbsp;&nbsp;&nbsp;</span></div>
      </div>
      <div class="card">
        <div class="k">Daily PnL %</div>
        <div class="v mono" data-metric="dailyPnlPercent"><span class="skeleton">&nbsp;</span></div>
      </div>
      <div class="card">
        <div class="k">Total PnL %</div>
        <div class="v mono" data-metric="totalPnlPercent"><span class="skeleton">&nbsp;</span></div>
      </div>
      <div class="card">
        <div class="k">Last Updated</div>
        <div class="v mono" data-metric="lastUpdated"><span class="skeleton">&nbsp;&nbsp;</span></div>
        <div class="asof muted">as of <span id="asOfIso">—</span></div>
      </div>
    </div>

    <table id="holdingsTable" data-table="holdings" aria-label="Holdings">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Market Value</th>
          <th>PnL %</th>
        </tr>
      </thead>
      <tbody id="holdingsBody">
        <tr><td colspan="5" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <!-- If you still need legacy scripts, include them AFTER Bootstrap -->
  <!-- <script src="{{ url_for('static', filename='js/app_legacy.js') }}" defer></script> -->

  <script defer>
    (function () {
      const PLACEHOLDER = '—';
      const getMeta = n => document.querySelector(`meta[name="${n}"]`)?.content;

      // Build endpoint candidates: prefer /api/* then /api/portfolio/*
      const candidates = {
        summary:  [
          getMeta('api-summary'),
          '/api/summary', '/api/portfolio/summary'
        ].filter(Boolean),
        holdings: [
          getMeta('api-holdings'),
          '/api/holdings', '/api/portfolio/holdings'
        ].filter(Boolean)
      };

      const num = v => {
        if (typeof v === 'number') return v;
        if (typeof v === 'string') { const n = parseFloat(v.replace(/[^\d.+\-]/g,'')); return Number.isFinite(n) ? n : NaN; }
        return NaN;
      };
      const fmtCurrency = (n, c='AUD') => Number.isFinite(n)
        ? n.toLocaleString(undefined, { style:'currency', currency:c })
        : PLACEHOLDER;
      const fmtPercent = n => Number.isFinite(n) ? `${n.toFixed(2)}%` : PLACEHOLDER;

      const toUiSummary = api => ({
        totalValue:      num(api?.totalValue      ?? api?.total_value      ?? api?.portfolio_value),
        dailyPnlPercent: num(api?.dailyPnlPercent ?? api?.daily_pnl_percent ?? api?.daily_pnl_pct),
        totalPnlPercent: num(api?.totalPnlPercent ?? api?.total_pnl_percent ?? api?.total_pnl_pct),
        lastUpdatedIso:  (api?.lastUpdatedIso ?? api?.last_updated ?? api?.as_of) || null,
        currency:        api?.currency || 'AUD'
      });

      const toUiHolding = h => ({
        symbol:      String(h?.symbol ?? h?.ticker ?? h?.code ?? ''),
        quantity:    num(h?.quantity ?? h?.qty ?? h?.amount),
        price:       num(h?.price ?? h?.lastPrice ?? h?.last_price),
        marketValue: num(h?.marketValue ?? h?.value ?? h?.market_value),
        pnlPercent:  num(h?.pnlPercent ?? h?.pct ?? h?.pnl_pct)
      });

      const setText = (sel, text) => { const el = document.querySelector(sel); if (el) el.textContent = text; };

      async function fetchJSONOneOf(urls) {
        for (const u of urls) {
          try {
            const r = await fetch(u, { credentials:'same-origin' });
            if (!r.ok) continue;
            const ct = r.headers.get('content-type') || '';
            if (!ct.includes('application/json')) continue;
            return await r.json();
          } catch { /* try next */ }
        }
        throw new Error('No JSON endpoint responded');
      }

      async function load() {
        const online = document.getElementById('onlineState');
        try {
          const [sJson, hJson] = await Promise.all([
            fetchJSONOneOf(candidates.summary),
            fetchJSONOneOf(candidates.holdings)
          ]);

          const summary  = toUiSummary(sJson || {});
          const holdings = Array.isArray(hJson) ? hJson.map(toUiHolding) : [];

          setText('[data-metric="totalValue"]',      fmtCurrency(summary.totalValue, summary.currency));
          setText('[data-metric="dailyPnlPercent"]', fmtPercent(summary.dailyPnlPercent));
          setText('[data-metric="totalPnlPercent"]', fmtPercent(summary.totalPnlPercent));
          if (summary.lastUpdatedIso) {
            const d = new Date(summary.lastUpdatedIso);
            setText('[data-metric="lastUpdated"]', isNaN(d) ? summary.lastUpdatedIso : d.toLocaleString());
            setText('#asOfIso', summary.lastUpdatedIso);
          }

          const body = document.getElementById('holdingsBody');
          if (body) {
            body.innerHTML = holdings.length
              ? holdings.map(h => {
                  const cls = Number.isFinite(h.pnlPercent) ? (h.pnlPercent>0?'green':(h.pnlPercent<0?'red':'amber')) : 'muted';
                  return `
                    <tr>
                      <td data-col="symbol">${h.symbol}</td>
                      <td data-col="qty"    class="mono">${Number.isFinite(h.quantity) ? h.quantity : PLACEHOLDER}</td>
                      <td data-col="price"  class="mono">${fmtCurrency(h.price, summary.currency)}</td>
                      <td data-col="value"  class="mono">${fmtCurrency(h.marketValue, summary.currency)}</td>
                      <td data-col="pnlPct" class="mono ${cls}">${fmtPercent(h.pnlPercent)}</td>
                    </tr>`;
                }).join('')
              : `<tr><td colspan="5" class="muted">No holdings.</td></tr>`;
          }

          if (online) online.textContent = 'Dashboard loaded';
          console.info('Dashboard bound');
        } catch (e) {
          const err = document.getElementById('err');
          if (err) { err.style.display='block'; err.textContent = `Failed to load dashboard data: ${e?.message || e}`; }
          if (online) online.textContent = 'Error loading dashboard';
          console.error('Dashboard load failed:', e);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', load, { once:true });
      } else {
        load();
      }
    })();
  </script>
</body>
</html>
