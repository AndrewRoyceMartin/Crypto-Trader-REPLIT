<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; --card-bg: #0f172a; --card-fg: #e5e7eb; --muted:#94a3b8; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b1020; color:#e5e7eb; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 16px; font-size: 24px; font-weight: 700; letter-spacing: .3px; }
    .sub { color: var(--muted); margin-bottom: 20px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: var(--gap); }
    .card { background: var(--card-bg); border: 1px solid #1f2937; border-radius: 12px; padding: 14px; box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset; }
    .k { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 6px; }
    .v { font-size: 22px; font-weight: 700; }
    .asof { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .err { background:#2a0f12; border:1px solid #7f1d1d; color:#fecaca; padding:10px 12px; border-radius:10px; margin-bottom:16px; display:none; }
    table { width: 100%; border-collapse: collapse; margin-top: 18px; overflow: hidden; border-radius: 12px; }
    thead th { text-align:left; font-size:12px; color:#cbd5e1; background:#111827; padding:10px; border-bottom:1px solid #1f2937; }
    tbody td { font-size:14px; padding:10px; border-bottom:1px solid #1f2937; }
    tbody tr:hover { background:rgba(255,255,255,0.03); }
    .mono { font-variant-numeric: tabular-nums; }
    .green { color: var(--ok); }
    .amber { color: var(--warn); }
    .red { color: var(--err); }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>
    <div id="err" class="err"></div>

    <div class="grid">
      <div class="card">
        <div class="k">Total Value</div>
        <div class="v mono" id="totalValue" data-metric="totalValue">—</div>
      </div>
      <div class="card">
        <div class="k">Daily PnL %</div>
        <div class="v mono" id="dailyPnlPercent" data-metric="dailyPnlPercent">—</div>
      </div>
      <div class="card">
        <div class="k">Total PnL %</div>
        <div class="v mono" id="totalPnlPercent" data-metric="totalPnlPercent">—</div>
      </div>
      <div class="card">
        <div class="k">Last Updated</div>
        <div class="v mono" id="lastUpdated" data-metric="lastUpdated">—</div>
        <div class="asof muted">as of <span id="asOfIso">—</span></div>
      </div>
    </div>

    <table id="holdingsTable" data-table="holdings" aria-label="Holdings">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Market Value</th>
          <th>PnL %</th>
        </tr>
      </thead>
      <tbody id="holdingsBody">
        <!-- rows injected -->
      </tbody>
    </table>
  </div>

  <script>
    // ---------- helpers ----------
    const PLACEHOLDER = '—';
    const num = (v) => {
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const n = parseFloat(v.replace(/[^\d.+\-]/g,''));
        return Number.isFinite(n) ? n : NaN;
      }
      return NaN;
    };
    const fmtCurrency = (n, c='AUD') => Number.isFinite(n)
      ? n.toLocaleString(undefined, { style: 'currency', currency: c })
      : PLACEHOLDER;
    const fmtPercent = (n) => Number.isFinite(n) ? `${n.toFixed(2)}%` : PLACEHOLDER;
    const toUiSummary = (api) => ({
      totalValue:      num(api.totalValue      ?? api.total_value      ?? api.portfolio_value),
      dailyPnlPercent: num(api.dailyPnlPercent ?? api.daily_pnl_percent ?? api.daily_pnl_pct),
      totalPnlPercent: num(api.totalPnlPercent ?? api.total_pnl_percent ?? api.total_pnl_pct),
      lastUpdatedIso:  (api.lastUpdatedIso ?? api.last_updated ?? api.as_of) || null,
      currency:        api.currency || 'AUD',
    });
    const toUiHolding = (h) => ({
      symbol:      String(h.symbol ?? h.ticker ?? h.code ?? ''),
      quantity:    num(h.quantity ?? h.qty ?? h.amount),
      price:       num(h.price ?? h.lastPrice ?? h.last_price),
      marketValue: num(h.marketValue ?? h.value ?? h.market_value),
      pnlPercent:  num(h.pnlPercent ?? h.pct ?? h.pnl_pct)
    });
    const setText = (sel, text) => { const el = document.querySelector(sel); if (el) el.textContent = text; };
    const setHTML = (el, html) => { el.innerHTML = html; };
    const showErr = (msg) => { const e = document.getElementById('err'); e.style.display='block'; e.textContent = msg; console.error(msg); };

    // ---------- renderers ----------
    function renderSummary(s) {
      const cur = s.currency || 'AUD';
      setText('#totalValue', fmtCurrency(s.totalValue, cur));
      setText('#dailyPnlPercent', fmtPercent(s.dailyPnlPercent));
      setText('#totalPnlPercent', fmtPercent(s.totalPnlPercent));
      if (s.lastUpdatedIso) {
        const d = new Date(s.lastUpdatedIso);
        const nice = isNaN(d) ? s.lastUpdatedIso : d.toLocaleString();
        setText('#lastUpdated', nice);
        setText('#asOfIso', s.lastUpdatedIso);
      }
    }

    function renderHoldings(rows, currency='AUD') {
      const body = document.getElementById('holdingsBody');
      if (!body) return;
      if (!Array.isArray(rows) || rows.length === 0) {
        setHTML(body, `<tr><td colspan="5" class="muted">No holdings.</td></tr>`);
        return;
      }
      const html = rows.map(h => {
        const cls = Number.isFinite(h.pnlPercent) ? (h.pnlPercent>0?'green':(h.pnlPercent<0?'red':'amber')) : 'muted';
        return `
          <tr>
            <td data-col="symbol">${h.symbol}</td>
            <td data-col="qty" class="mono">${Number.isFinite(h.quantity) ? h.quantity : PLACEHOLDER}</td>
            <td data-col="price" class="mono">${fmtCurrency(h.price, currency)}</td>
            <td data-col="value" class="mono">${fmtCurrency(h.marketValue, currency)}</td>
            <td data-col="pnlPct" class="mono ${cls}">${fmtPercent(h.pnlPercent)}</td>
          </tr>
        `;
      }).join('');
      setHTML(body, html);
    }

    // ---------- load & init ----------
    (async () => {
      try {
        // Attempt relative API first (works behind Flask/Reverse proxy)
        const [sRes, hRes] = await Promise.all([
          fetch('/api/portfolio/summary', { credentials: 'same-origin' }),
          fetch('/api/portfolio/holdings', { credentials: 'same-origin' })
        ]);

        if (!sRes.ok) throw new Error(`Summary API ${sRes.status}`);
        if (!hRes.ok) throw new Error(`Holdings API ${hRes.status}`);

        const sJson = await sRes.json();
        const hJson = await hRes.json();

        const summary = toUiSummary(sJson);
        const holdings = Array.isArray(hJson) ? hJson.map(toUiHolding) : [];

        renderSummary(summary);
        renderHoldings(holdings, summary.currency || 'AUD');
      } catch (e) {
        showErr(`Failed to load dashboard data: ${e && e.message ? e.message : e}`);
      }
    })();
  </script>
</body>
</html>
