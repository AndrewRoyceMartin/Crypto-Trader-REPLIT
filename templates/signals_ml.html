{% extends "base_layout.html" %}

{% block title %}Signals & ML - Hybrid Trading Intelligence{% endblock %}
{% block page_title %}Signals & ML Analysis{% endblock %}
{% block page_subtitle %}Hybrid scoring system combining ML predictions with technical analysis{% endblock %}

{% block extra_css %}
<style>
.signal-analysis-card {
    background: var(--primary-dark);
    border: 2px solid var(--border-color);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
}

.signal-score {
    font-size: 3rem;
    font-weight: 800;
    text-align: center;
    margin: 20px 0;
}

.score-breakdown {
    background: var(--secondary-dark);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
}

.confidence-meter {
    height: 30px;
    background: var(--secondary-dark);
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    margin: 10px 0;
}

.confidence-fill {
    height: 100%;
    transition: width 0.8s ease;
    border-radius: 15px;
}

.signal-badge {
    font-size: 1.2rem;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    text-transform: uppercase;
}

.indicator-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.indicator-item {
    background: var(--secondary-dark);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.ml-prediction-box {
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-dark));
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid var(--success-green);
}
</style>
{% endblock %}

{% block content %}
<!-- Symbol Selection -->
<div class="data-card mb-4">
    <div class="row align-items-center">
        <div class="col-md-6">
            <label for="symbolSelect" class="form-label">Select Asset for Analysis</label>
            <select class="form-select form-select-lg" id="symbolSelect" onchange="loadSignalAnalysis()">
                <option value="BTC">Bitcoin (BTC)</option>
                <option value="ETH">Ethereum (ETH)</option>
                <option value="SOL">Solana (SOL)</option>
                <option value="ALGO">Algorand (ALGO)</option>
                <option value="ATOM">Cosmos (ATOM)</option>
            </select>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-primary btn-lg" onclick="refreshSignalData()">
                <i class="icon-sync-alt me-2"></i>Refresh Analysis
            </button>
        </div>
    </div>
</div>

<!-- Hybrid Signal Score -->
<div class="signal-analysis-card">
    <div class="row">
        <div class="col-lg-4 text-center">
            <h5>Hybrid Signal Score</h5>
            <div class="signal-score text-primary" id="hybridScore">--</div>
            <div class="signal-badge bg-secondary" id="signalBadge">LOADING</div>
        </div>
        <div class="col-lg-8">
            <h6>Score Breakdown</h6>
            <div class="score-breakdown">
                <div class="row">
                    <div class="col-6">
                        <h6 class="text-info">Traditional Analysis (60%)</h6>
                        <div class="confidence-meter">
                            <div class="confidence-fill bg-info" id="traditionalFill" style="width: 0%"></div>
                        </div>
                        <div id="traditionalScore">0%</div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-warning">ML Prediction (40%)</h6>
                        <div class="confidence-meter">
                            <div class="confidence-fill bg-warning" id="mlFill" style="width: 0%"></div>
                        </div>
                        <div id="mlScore">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Technical Indicators -->
<div class="row">
    <div class="col-lg-8">
        <div class="data-card">
            <h5 class="card-title">
                <i class="icon-chart-line"></i>
                Technical Indicators
            </h5>
            <div class="indicator-grid" id="indicatorGrid">
                <div class="indicator-item">
                    <div class="h4" id="rsiValue">--</div>
                    <div style="color: #9ca3af;">RSI (14)</div>
                </div>
                <div class="indicator-item">
                    <div class="h4" id="volatilityValue">--</div>
                    <div style="color: #9ca3af;">Volatility</div>
                </div>
                <div class="indicator-item">
                    <div class="h4" id="volumeValue">--</div>
                    <div style="color: #9ca3af;">Volume Ratio</div>
                </div>
                <div class="indicator-item">
                    <div class="h4" id="momentumValue">--</div>
                    <div style="color: #9ca3af;">Momentum</div>
                </div>
                <div class="indicator-item">
                    <div class="h4" id="supportValue">--</div>
                    <div style="color: #9ca3af;">Support</div>
                </div>
                <div class="indicator-item">
                    <div class="h4" id="bollingerValue">--</div>
                    <div style="color: #9ca3af;">Bollinger</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="ml-prediction-box">
            <h5 class="text-center text-white">
                <i class="icon-robot me-2"></i>
                ML Prediction
            </h5>
            <div class="text-center">
                <div class="h2 text-success" id="mlProbability">--</div>
                <div class="text-light">Probability</div>
                <div class="mt-3">
                    <small class="text-light" id="mlDetails">Loading ML analysis...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Signal History Table -->
<div class="data-card">
    <h5 class="card-title">
        <i class="icon-history"></i>
        Recent Signal History
        <button class="btn btn-sm btn-outline-primary ms-3" onclick="exportSignalHistory()">
            <i class="icon-download me-1"></i>Export CSV
        </button>
    </h5>
    
    <div class="table-responsive">
        <table class="table-v02" style="--v02-head-bg: #6c7ae0;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Symbol</th>
                    <th class="text-center">Signal</th>
                    <th class="text-end">Hybrid Score</th>
                    <th class="text-end">ML Prob</th>
                    <th class="text-end">Traditional</th>
                    <th class="text-end">Price</th>
                </tr>
            </thead>
            <tbody id="signalHistoryTable">
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="loading-spinner text-primary" role="status">
                            <span class="visually-hidden">Loading signal history...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Threshold Configuration -->
<div class="data-card">
    <h5 class="card-title">
        <i class="icon-sliders-h"></i>
        Signal Thresholds
    </h5>
    <div class="row">
        <div class="col-md-3">
            <div class="text-center p-3 border rounded bg-success">
                <div class="h5">≥75</div>
                <div>BUY Signal</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded bg-warning">
                <div class="h5">≥60</div>
                <div>CONSIDER Signal</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded bg-secondary">
                <div class="h5">≥45</div>
                <div>WAIT Signal</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded bg-danger">
                <div class="h5">&lt;45</div>
                <div>AVOID Signal</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSymbol = 'BTC';
let signalData = null;

async function loadSignalAnalysis() {
    const symbol = document.getElementById('symbolSelect').value;
    currentSymbol = symbol;
    
    try {
        showToast(`Loading ${symbol} signal analysis...`, 'info');
        
        // Get current price first
        const priceResponse = await fetch(`/api/current-holdings`);
        let currentPrice = 50000; // Default fallback
        
        if (priceResponse.ok) {
            const holdings = await priceResponse.json();
            const holding = holdings.holdings?.find(h => h.symbol === symbol);
            if (holding && holding.current_price) {
                currentPrice = holding.current_price;
            }
        }
        
        // Get hybrid signal data
        const signalResponse = await fetch(`/api/hybrid-signal?symbol=${symbol}&price=${currentPrice}`);
        if (signalResponse.ok) {
            signalData = await signalResponse.json();
            displaySignalAnalysis(signalData);
            showToast('Signal analysis updated successfully!', 'success');
        } else {
            throw new Error('Failed to load signal data');
        }
        
        // Load signal history
        loadSignalHistory();
        
    } catch (error) {
        console.error('Signal analysis loading failed:', error);
        showToast('Failed to load signal analysis: ' + error.message, 'error');
    }
}

function displaySignalAnalysis(signal) {
    // Update hybrid score
    const hybridScore = signal.hybrid_score || 0;
    document.getElementById('hybridScore').textContent = hybridScore.toFixed(1);
    
    // Update signal badge
    const finalSignal = signal.final_signal || 'WAIT';
    const badgeElement = document.getElementById('signalBadge');
    badgeElement.textContent = finalSignal;
    
    // Set badge color
    badgeElement.className = 'signal-badge ';
    if (finalSignal === 'BUY') badgeElement.className += 'bg-success';
    else if (finalSignal === 'CONSIDER') badgeElement.className += 'bg-warning';
    else if (finalSignal === 'AVOID') badgeElement.className += 'bg-danger';
    else badgeElement.className += 'bg-secondary';
    
    // Update score breakdown
    const mlIntegration = signal.ml_integration || {};
    const traditionalScore = mlIntegration.traditional_score || 0;
    const mlProbability = mlIntegration.ml_probability || 0;
    
    document.getElementById('traditionalScore').textContent = traditionalScore.toFixed(1) + '%';
    document.getElementById('mlScore').textContent = (mlProbability * 100).toFixed(1) + '%';
    
    // Animate progress bars
    setTimeout(() => {
        document.getElementById('traditionalFill').style.width = traditionalScore + '%';
        document.getElementById('mlFill').style.width = (mlProbability * 100) + '%';
    }, 200);
    
    // Update technical indicators
    const indicators = signal.indicators || {};
    document.getElementById('rsiValue').textContent = (indicators.rsi_14 || 0).toFixed(1);
    document.getElementById('volatilityValue').textContent = (indicators.volatility_7 || 0).toFixed(1) + '%';
    document.getElementById('volumeValue').textContent = (indicators.volume_ratio || 0).toFixed(2);
    
    // Update signal indicators
    const signals = signal.signals || {};
    document.getElementById('momentumValue').textContent = signals.momentum_signal ? '✓' : '✗';
    document.getElementById('supportValue').textContent = signals.support_signal ? '✓' : '✗';
    document.getElementById('bollingerValue').textContent = signals.bollinger_signal ? '✓' : '✗';
    
    // Update ML prediction
    document.getElementById('mlProbability').textContent = (mlProbability * 100).toFixed(1) + '%';
    document.getElementById('mlDetails').innerHTML = `
        Model confidence: ${mlIntegration.model_confidence || 'N/A'}<br>
        Feature count: ${mlIntegration.feature_count || 'N/A'}<br>
        Last updated: ${new Date().toLocaleTimeString()}
    `;
}

async function loadSignalHistory() {
    try {
        // This would load from the signal log CSV file
        // For now, showing sample historical data
        const historyData = [
            {
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                symbol: currentSymbol,
                signal: 'BUY',
                hybrid_score: 78.5,
                ml_prob: 0.65,
                traditional: 85.2,
                price: 65000
            },
            {
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                symbol: currentSymbol,
                signal: 'CONSIDER',
                hybrid_score: 62.1,
                ml_prob: 0.45,
                traditional: 72.8,
                price: 64800
            },
            {
                timestamp: new Date(Date.now() - 10800000).toISOString(),
                symbol: currentSymbol,
                signal: 'WAIT',
                hybrid_score: 48.3,
                ml_prob: 0.30,
                traditional: 58.9,
                price: 64200
            }
        ];
        
        displaySignalHistory(historyData);
        
    } catch (error) {
        console.error('Signal history loading failed:', error);
    }
}

function displaySignalHistory(history) {
    const tbody = document.getElementById('signalHistoryTable');
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No signal history available</td></tr>';
        return;
    }
    
    tbody.innerHTML = history.map(record => {
        const timestamp = new Date(record.timestamp).toLocaleString();
        let signalClass = 'bg-secondary';
        if (record.signal === 'BUY') signalClass = 'bg-success';
        else if (record.signal === 'CONSIDER') signalClass = 'bg-warning';
        else if (record.signal === 'AVOID') signalClass = 'bg-danger';
        
        return `
            <tr>
                <td>${timestamp}</td>
                <td><strong>${record.symbol}</strong></td>
                <td class="text-center">
                    <span class="badge ${signalClass}">${record.signal}</span>
                </td>
                <td class="text-end">${record.hybrid_score.toFixed(1)}</td>
                <td class="text-end">${(record.ml_prob * 100).toFixed(1)}%</td>
                <td class="text-end">${record.traditional.toFixed(1)}</td>
                <td class="text-end">$${record.price.toLocaleString()}</td>
            </tr>
        `;
    }).join('');
}

async function refreshSignalData() {
    await loadSignalAnalysis();
}

async function exportSignalHistory() {
    try {
        showToast('Exporting signal history...', 'info');
        
        // This would export the actual signal CSV file
        const response = await fetch('/signals_log.csv');
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'signal_history.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Signal history exported successfully!', 'success');
        } else {
            throw new Error('Export failed');
        }
    } catch (error) {
        showToast('Error exporting signal history: ' + error.message, 'error');
    }
}

// Page-specific refresh function
window.refreshPageData = async function() {
    await loadSignalAnalysis();
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSignalAnalysis();
    
    // Auto-refresh every 2 minutes
    setInterval(loadSignalAnalysis, 120000);
});
</script>
{% endblock %}