{% extends "base_layout.html" %}

{% block title %}Trading Performance Dashboard - Hybrid Trading Intelligence Platform{% endblock %}

{% block extra_css %}
<style>
/* Trading Performance Dashboard Specific Styles */
.performance-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.performance-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--accent-blue);
}

.metric-card {
    background: linear-gradient(135deg, rgba(15, 52, 96, 0.3) 0%, rgba(22, 33, 62, 0.3) 100%);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    height: 100%;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
    color: var(--text-light);
    opacity: 0.8;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.signal-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.signal-BUY { background: var(--success-green); color: white; }
.signal-CONSIDER { background: var(--warning-orange); color: white; }
.signal-WAIT { background: #6c757d; color: white; }
.signal-AVOID { background: var(--danger-red); color: white; }

.outcome-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.outcome-POSITIVE { background: rgba(40, 167, 69, 0.2); color: var(--success-green); }
.outcome-NEGATIVE { background: rgba(220, 53, 69, 0.2); color: var(--danger-red); }
.outcome-CORRECT_AVOID { background: rgba(40, 167, 69, 0.2); color: var(--success-green); }
.outcome-PENDING { background: rgba(108, 117, 125, 0.2); color: #adb5bd; }

.trade-row:hover {
    background: rgba(255, 255, 255, 0.05);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent-blue);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--accent-blue);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.refresh-indicator.show {
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<!-- Refresh Indicator -->
<div id="refreshIndicator" class="refresh-indicator">
    <i class="fas fa-sync-alt"></i> Updating...
</div>

<div class="content-wrapper">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                Trading Performance Dashboard
            </h1>
            <p class="page-subtitle">Real-time monitoring and analysis of your hybrid trading intelligence system</p>
        </div>

        <!-- Performance Overview Cards -->
        <div class="row mb-4" id="overviewCards">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-info" id="totalValue">$0.00</div>
                    <div class="metric-label">Portfolio Value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalPnl">$0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="winRate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-success" id="mlAccuracy">0%</div>
                    <div class="metric-label">ML Accuracy</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- P&L Curve Chart -->
            <div class="col-lg-8">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-area text-info"></i>
                        Portfolio P&L Curve (30 Days)
                    </h5>
                    <div class="chart-container">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Asset Allocation Chart -->
            <div class="col-lg-4">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-pie text-warning"></i>
                        Asset Allocation
                    </h5>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Performance and Recent Signals -->
        <div class="row mb-4">
            <!-- Signal Accuracy Chart -->
            <div class="col-lg-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-bullseye text-success"></i>
                        Signal Accuracy by Type
                    </h5>
                    <div class="chart-container">
                        <canvas id="signalAccuracyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Signals -->
            <div class="col-lg-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-signal text-primary"></i>
                        Recent Signal Activity
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="signalsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Signal</th>
                                    <th>Hybrid Score</th>
                                    <th>Outcome</th>
                                    <th>P&L%</th>
                                </tr>
                            </thead>
                            <tbody id="signalsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner"></div>
                                        Loading signals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Performance Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-bar text-info"></i>
                        Current Positions Performance
                    </h5>
                    
                    <!-- Trade Summary Cards -->
                    <div class="row mb-3" id="tradeSummaryCards">
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-info" id="totalTrades">0</div>
                                <div class="metric-label">Total Positions</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-success" id="winningTrades">0</div>
                                <div class="metric-label">Winning</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-danger" id="losingTrades">0</div>
                                <div class="metric-label">Losing</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-warning" id="avgPnl">0%</div>
                                <div class="metric-label">Avg P&L</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-primary" id="sharpeRatio">0.00</div>
                                <div class="metric-label">Sharpe Ratio</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-danger" id="maxDrawdown">0%</div>
                                <div class="metric-label">Max Drawdown</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Table -->
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                    <th>P&L</th>
                                    <th>P&L%</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="loading-spinner"></div>
                                        Loading trades...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="row">
            <div class="col-md-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-trophy text-warning"></i>
                        Best Performer
                    </h5>
                    <div id="bestPerformer" class="text-center">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-line-down text-danger"></i>
                        Worst Performer
                    </h5>
                    <div id="worstPerformer" class="text-center">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Trading Performance Dashboard JavaScript
class TradingPerformanceDashboard {
    constructor() {
        this.charts = {};
        this.refreshInterval = 30000; // 30 seconds
        this.init();
    }

    async init() {
        console.log('🎯 Initializing Trading Performance Dashboard');
        await this.loadAllData();
        this.startAutoRefresh();
    }

    async loadAllData() {
        this.showRefreshIndicator();
        try {
            await Promise.all([
                this.loadOverviewData(),
                this.loadChartData(),
                this.loadSignalData(),
                this.loadTradeData()
            ]);
        } catch (error) {
            console.error('❌ Error loading dashboard data:', error);
        } finally {
            this.hideRefreshIndicator();
        }
    }

    async loadOverviewData() {
        try {
            const response = await fetch('/api/performance-overview');
            const data = await response.json();
            
            if (data.success) {
                this.updateOverviewCards(data);
                this.updateTopPerformers(data.top_performers);
            }
        } catch (error) {
            console.error('❌ Error loading overview data:', error);
        }
    }

    async loadChartData() {
        try {
            const response = await fetch('/api/performance-charts');
            const data = await response.json();
            
            if (data.success) {
                this.updatePnLChart(data.pnl_curve);
                this.updateAllocationChart(data.asset_allocation);
                this.updateSignalAccuracyChart(data.signal_accuracy);
            }
        } catch (error) {
            console.error('❌ Error loading chart data:', error);
        }
    }

    async loadSignalData() {
        try {
            const response = await fetch('/api/signal-tracking');
            const data = await response.json();
            
            if (data.success) {
                this.updateSignalsTable(data.recent_signals);
            }
        } catch (error) {
            console.error('❌ Error loading signal data:', error);
        }
    }

    async loadTradeData() {
        try {
            const response = await fetch('/api/trade-performance');
            const data = await response.json();
            
            if (data.success) {
                this.updateTradeSummary(data.trade_summary);
                this.updateTradesTable(data.trades);
            }
        } catch (error) {
            console.error('❌ Error loading trade data:', error);
        }
    }

    updateOverviewCards(data) {
        const metrics = data.portfolio_metrics;
        const signals = data.signal_metrics;

        document.getElementById('totalValue').textContent = `$${metrics.total_value.toLocaleString()}`;
        document.getElementById('totalPnl').textContent = `$${metrics.total_pnl.toLocaleString()}`;
        document.getElementById('totalPnl').className = `metric-value ${metrics.total_pnl >= 0 ? 'text-success' : 'text-danger'}`;
        document.getElementById('winRate').textContent = `${metrics.win_rate}%`;
        document.getElementById('mlAccuracy').textContent = `${signals.ml_accuracy}%`;
    }

    updateTopPerformers(performers) {
        const bestEl = document.getElementById('bestPerformer');
        const worstEl = document.getElementById('worstPerformer');

        if (performers.best) {
            bestEl.innerHTML = `
                <h4 class="text-success">${performers.best.symbol}</h4>
                <p class="text-success mb-1">+${performers.best.pnl_percent.toFixed(2)}%</p>
                <p class="text-muted">$${performers.best.pnl_usd.toFixed(2)}</p>
            `;
        } else {
            bestEl.innerHTML = '<p class="text-muted">No data</p>';
        }

        if (performers.worst) {
            worstEl.innerHTML = `
                <h4 class="text-danger">${performers.worst.symbol}</h4>
                <p class="text-danger mb-1">${performers.worst.pnl_percent.toFixed(2)}%</p>
                <p class="text-muted">$${performers.worst.pnl_usd.toFixed(2)}</p>
            `;
        } else {
            worstEl.innerHTML = '<p class="text-muted">No data</p>';
        }
    }

    updatePnLChart(data) {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        
        if (this.charts.pnl) {
            this.charts.pnl.destroy();
        }

        this.charts.pnl = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: data.values,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#e9ecef' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#adb5bd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { 
                            color: '#adb5bd',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    updateAllocationChart(data) {
        const ctx = document.getElementById('allocationChart').getContext('2d');
        
        if (this.charts.allocation) {
            this.charts.allocation.destroy();
        }

        this.charts.allocation = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: data.colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            color: '#e9ecef',
                            padding: 10,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }

    updateSignalAccuracyChart(data) {
        const ctx = document.getElementById('signalAccuracyChart').getContext('2d');
        
        if (this.charts.signals) {
            this.charts.signals.destroy();
        }

        this.charts.signals = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Accuracy %',
                    data: data.accuracy,
                    backgroundColor: ['#28a745', '#fd7e14', '#6c757d', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#e9ecef' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#adb5bd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { 
                            color: '#adb5bd',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        min: 0,
                        max: 100
                    }
                }
            }
        });
    }

    updateSignalsTable(signals) {
        const tbody = document.getElementById('signalsTableBody');
        
        if (!signals || signals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No recent signals</td></tr>';
            return;
        }

        tbody.innerHTML = signals.map(signal => `
            <tr class="trade-row">
                <td><strong>${signal.symbol}</strong></td>
                <td><span class="signal-badge signal-${signal.signal}">${signal.signal}</span></td>
                <td>${signal.hybrid_score.toFixed(1)}%</td>
                <td><span class="outcome-badge outcome-${signal.outcome}">${signal.outcome.replace('_', ' ')}</span></td>
                <td class="${signal.pnl_percent !== null ? (signal.pnl_percent >= 0 ? 'text-success' : 'text-danger') : 'text-muted'}">
                    ${signal.pnl_percent !== null ? signal.pnl_percent.toFixed(2) + '%' : 'N/A'}
                </td>
            </tr>
        `).join('');
    }

    updateTradeSummary(summary) {
        document.getElementById('totalTrades').textContent = summary.total_trades;
        document.getElementById('winningTrades').textContent = summary.winning_trades;
        document.getElementById('losingTrades').textContent = summary.losing_trades;
        document.getElementById('avgPnl').textContent = `${summary.avg_pnl_percent.toFixed(2)}%`;
        document.getElementById('avgPnl').className = `metric-value ${summary.avg_pnl_percent >= 0 ? 'text-success' : 'text-danger'}`;
    }

    updateTradesTable(trades) {
        const tbody = document.getElementById('tradesTableBody');
        
        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No active trades</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => `
            <tr class="trade-row">
                <td><strong>${trade.symbol}</strong></td>
                <td>$${trade.entry_price.toFixed(4)}</td>
                <td>$${trade.current_price.toFixed(4)}</td>
                <td>${trade.quantity.toFixed(4)}</td>
                <td>$${trade.current_value.toFixed(2)}</td>
                <td class="${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">$${trade.pnl.toFixed(2)}</td>
                <td class="${trade.pnl_percent >= 0 ? 'text-success' : 'text-danger'}">${trade.pnl_percent.toFixed(2)}%</td>
                <td><span class="badge ${trade.status === 'WINNING' ? 'bg-success' : 'bg-danger'}">${trade.status}</span></td>
            </tr>
        `).join('');
    }

    showRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.add('show');
    }

    hideRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.remove('show');
    }

    startAutoRefresh() {
        setInterval(() => {
            this.loadAllData();
        }, this.refreshInterval);
        
        console.log(`🔄 Auto-refresh started (${this.refreshInterval/1000}s interval)`);
    }
}

// Initialize dashboard immediately - force execution
console.log('🔥 FORCE INIT: Starting dashboard initialization');

// Fallback Chart.js definition if not loaded
if (typeof Chart === 'undefined') {
    console.log('⚠️ Chart.js not loaded, creating stub');
    window.Chart = function() { return { destroy: () => {} }; };
}

// Force immediate initialization
try {
    console.log('🎯 Force initializing Trading Performance Dashboard');
    window.performanceDashboard = new TradingPerformanceDashboard();
    console.log('✅ Dashboard created successfully');
} catch (error) {
    console.error('❌ Dashboard initialization failed:', error);
}

// Also try DOMContentLoaded as backup
document.addEventListener('DOMContentLoaded', () => {
    console.log('🔄 DOM loaded - backup initialization');
    if (!window.performanceDashboard) {
        try {
            window.performanceDashboard = new TradingPerformanceDashboard();
        } catch (error) {
            console.error('❌ Backup initialization failed:', error);
        }
    }
});
</script>
{% endblock %}