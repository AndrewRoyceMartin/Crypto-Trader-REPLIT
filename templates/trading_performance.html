{% extends "base_layout.html" %}

{% block title %}Trading Performance Dashboard - Grim Trader v2.0{% endblock %}

{% block extra_css %}
<style>
/* Trading Performance Dashboard Specific Styles */
.performance-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.performance-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--accent-blue);
}

.metric-card {
    background: linear-gradient(135deg, rgba(15, 52, 96, 0.3) 0%, rgba(22, 33, 62, 0.3) 100%);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    height: 100%;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
    color: var(--text-light);
    opacity: 0.8;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.signal-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.signal-BUY { background: var(--success-green); color: white; }
.signal-CONSIDER { background: var(--warning-orange); color: white; }
.signal-WAIT { background: #6c757d; color: white; }
.signal-AVOID { background: var(--danger-red); color: white; }

.outcome-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.outcome-POSITIVE { background: rgba(40, 167, 69, 0.2); color: var(--success-green); }
.outcome-NEGATIVE { background: rgba(220, 53, 69, 0.2); color: var(--danger-red); }
.outcome-CORRECT_AVOID { background: rgba(40, 167, 69, 0.2); color: var(--success-green); }
.outcome-PENDING { background: rgba(108, 117, 125, 0.2); color: #adb5bd; }

.trade-row:hover {
    background: rgba(255, 255, 255, 0.05);
}


.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--accent-blue);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.refresh-indicator.show {
    opacity: 1;
}

/* Enhanced Professional Loading Animations */
.loading-skeleton {
    background: linear-gradient(90deg, 
        rgba(156, 163, 175, 0.1) 25%, 
        rgba(156, 163, 175, 0.2) 50%, 
        rgba(156, 163, 175, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
    height: 1.5em;
}

.loading-skeleton-metric {
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.1) 25%, 
        rgba(255, 255, 255, 0.3) 50%, 
        rgba(255, 255, 255, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
    height: 2rem;
    width: 80%;
    margin: 0 auto;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.metric-loading {
    opacity: 0.7;
    transform: scale(0.98);
    transition: all 0.4s ease;
}

.metric-loaded {
    opacity: 1;
    transform: scale(1);
    animation: metricAppear 0.6s ease-out;
}

@keyframes metricAppear {
    0% { 
        opacity: 0;
        transform: scale(0.95) translateY(10px);
    }
    100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.performance-status {
    font-size: 0.85rem;
    text-align: center;
    margin-top: 15px;
    padding: 8px;
    border-radius: 20px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.status-loading { 
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.3);
}
.status-loaded { 
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
}
.status-error { 
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px dashed var(--border-color);
}

.loading-text {
    color: #9ca3af;
    font-size: 0.9rem;
    margin-left: 10px;
}

</style>
{% endblock %}

{% block content %}
<!-- Refresh Indicator -->
<div id="refreshIndicator" class="refresh-indicator">
    <i class="fas fa-sync-alt"></i> Updating...
</div>

<div class="content-wrapper">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                Trading Performance Dashboard
            </h1>
            <p class="page-subtitle">Real-time monitoring and analysis of your Grim Trader v2.0 system</p>
        </div>

        <!-- Performance Overview Cards -->
        <div class="row mb-4" id="overviewCards">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-info" id="totalValue">
                        <div class="loading-skeleton loading-skeleton-metric"></div>
                    </div>
                    <div class="metric-label">Portfolio Value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalPnl">
                        <div class="loading-skeleton loading-skeleton-metric"></div>
                    </div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="winRate">
                        <div class="loading-skeleton loading-skeleton-metric"></div>
                    </div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-success" id="mlAccuracy">
                        <div class="loading-skeleton loading-skeleton-metric"></div>
                    </div>
                    <div class="metric-label">ML Accuracy</div>
                </div>
            </div>
        </div>

        <!-- Status Indicator -->
        <div class=\"performance-status status-loading\" id=\"performance-status\">
            <i class=\"fas fa-spinner fa-spin me-2\"></i>Loading performance data...
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- P&L Curve Chart -->
            <div class="col-lg-8">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-area text-info"></i>
                        Portfolio P&L Curve (30 Days)
                    </h5>
                    <div class="chart-container">
                        <div id="pnlChart"></div>
                    </div>
                </div>
            </div>

            <!-- Asset Allocation Chart -->
            <div class="col-lg-4">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-pie text-warning"></i>
                        Asset Allocation
                    </h5>
                    <div class="chart-container">
                        <div id="allocationChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Performance and Recent Signals -->
        <div class="row mb-4">
            <!-- Signal Accuracy Chart -->
            <div class="col-lg-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-bullseye text-success"></i>
                        Signal Accuracy by Type
                    </h5>
                    <div class="chart-container">
                        <div id="signalAccuracyChart"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Signals -->
            <div class="col-lg-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-signal text-primary"></i>
                        Recent Signal Activity
                    </h5>
                    <div class="table-responsive">
                        <table class="table-v02 table-v02--compact" style="--v02-head-bg: #6c7ae0;" id="signalsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Signal</th>
                                    <th>Hybrid Score</th>
                                    <th>Outcome</th>
                                    <th>P&L%</th>
                                </tr>
                            </thead>
                            <tbody id="signalsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner"></div>
                                        Loading signals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Performance Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-bar text-info"></i>
                        Current Positions Performance
                    </h5>
                    
                    <!-- Trade Summary Cards -->
                    <div class="row mb-3" id="tradeSummaryCards">
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-info" id="totalTrades">0</div>
                                <div class="metric-label">Total Positions</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-success" id="winningTrades">0</div>
                                <div class="metric-label">Winning</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-danger" id="losingTrades">0</div>
                                <div class="metric-label">Losing</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-warning" id="avgPnl">0%</div>
                                <div class="metric-label">Avg P&L</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-primary" id="sharpeRatio">
                                    <div class="loading-skeleton loading-skeleton-metric"></div>
                                </div>
                                <div class="metric-label">Sharpe Ratio</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-value text-danger" id="maxDrawdown">0%</div>
                                <div class="metric-label">Max Drawdown</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Table -->
                    <div class="table-responsive">
                        <table class="table-v02" style="--v02-head-bg: #6c7ae0;" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                    <th>P&L</th>
                                    <th>P&L%</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="loading-spinner"></div>
                                        Loading trades...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="row">
            <div class="col-md-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-trophy text-warning"></i>
                        Best Performer
                    </h5>
                    <div id="bestPerformer" class="text-center">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="performance-card">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-line-down text-danger"></i>
                        Worst Performer
                    </h5>
                    <div id="worstPerformer" class="text-center">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Trading Performance Dashboard JavaScript
class TradingPerformanceDashboard {
    constructor() {
        this.refreshInterval = 30000; // 30 seconds
        this.init(); // This will now work properly
    }

    init() {
        console.log('üéØ Initializing Trading Performance Dashboard');
        this.loadAllData(); // Remove await - let it run async
        this.startAutoRefresh();
        console.log('‚úÖ Trading Performance Dashboard initialization complete');
    }

    async loadAllData() {
        this.showRefreshIndicator();
        try {
            await Promise.all([
                this.loadOverviewData(),
                this.loadChartData(),
                this.loadSignalData(),
                this.loadTradeData()
            ]);
        } catch (error) {
            console.error('‚ùå Error loading dashboard data:', error);
        } finally {
            this.hideRefreshIndicator();
        }
    }

    getAdminToken() {
        const serverToken = {{ admin_token_env | default('') | tojson }};
        if (serverToken) {
            if (localStorage.getItem('ADMIN_TOKEN') !== serverToken) {
                localStorage.setItem('ADMIN_TOKEN', serverToken);
            }
            return serverToken;
        }
        return localStorage.getItem('ADMIN_TOKEN') || '';
    }

    getAuthHeaders() {
        const adminToken = this.getAdminToken();
        return adminToken ? {'X-Admin-Token': adminToken} : {};
    }

    async authenticatedFetch(url, options = {}) {
        const headers = { ...this.getAuthHeaders(), ...options.headers };
        const response = await fetch(url, { ...options, headers });
        
        // Handle 401 by clearing stale localStorage and retrying once
        if (response.status === 401) {
            localStorage.removeItem('ADMIN_TOKEN');
            const retryHeaders = { ...this.getAuthHeaders(), ...options.headers };
            return fetch(url, { ...options, headers: retryHeaders });
        }
        
        return response;
    }

    async loadOverviewData() {
        try {
            console.log('üî• Loading performance overview with enhanced animations...');
            
            // Set all metrics to loading state
            const metricElements = ['totalValue', 'totalPnl', 'winRate', 'mlAccuracy'];
            metricElements.forEach(id => {
                const element = document.getElementById(id);
                const parent = element?.closest('.metric-card');
                if (parent) {
                    parent.classList.add('metric-loading');
                    parent.classList.remove('metric-loaded');
                }
            });
            
            // Update status indicator
            const statusElement = document.getElementById('performance-status');
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading performance data...';
                statusElement.className = 'performance-status status-loading';
            }
            
            const response = await this.authenticatedFetch('/api/performance-overview');
            const data = await response.json();
            console.log('üìä API Response:', data);
            
            if (data.success && data.portfolio_metrics) {
                // Add delay to showcase loading animation
                setTimeout(() => {
                    console.log('‚úÖ Updating overview cards with animations');
                    this.updateOverviewCardsWithAnimation(data);
                    this.updateTopPerformers(data.top_performers);
                    
                    // Update status to loaded
                    if (statusElement) {
                        setTimeout(() => {
                            const now = new Date();
                            statusElement.innerHTML = '<i class="fas fa-check me-2"></i>Last updated: ' + now.toLocaleTimeString();
                            statusElement.className = 'performance-status status-loaded';
                        }, 600);
                    }
                    
                    console.log('‚úÖ Performance overview loaded with animations');
                }, 400);
            } else {
                console.error('‚ùå Invalid API response structure:', data);
                
                // Update status to error
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error loading data';
                    statusElement.className = 'performance-status status-error';
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading overview data:', error);
            
            // Update status to error
            const statusElement = document.getElementById('performance-status');
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error loading data';
                statusElement.className = 'performance-status status-error';
            }
        }
    }

    async loadChartData() {
        try {
            const res = await this.authenticatedFetch('/api/performance-charts', { cache: 'no-store' });
            const data = await res.json();

            if (!data?.success) {
                console.warn('Chart API did not return success:', data);
                return;
            }
            // Pass entire response to the normalizer; it will find pnl_curve
            this.updatePortfolioChart(data);
            this.updateAllocationChart(data.asset_allocation);
            this.updateSignalAccuracyChart(data.signal_accuracy);
        } catch (err) {
            console.error('‚ùå Error loading chart data:', err);
        }
    }

    updatePortfolioChart(apiData) {
        console.log('üìä Creating simple HTML/CSS chart from:', apiData);
        
        // Extract data from API
        let chartData = [];
        if (apiData?.pnl_curve && Array.isArray(apiData.pnl_curve)) {
            chartData = apiData.pnl_curve.map(item => ({
                date: item.date || 'Day',
                value: Number(item.value) || 0
            }));
        }
        
        if (chartData.length === 0) {
            console.log('üìä No real chart data available - waiting for OKX data');
            // Display message instead of sample data
            document.getElementById('pnlChart').innerHTML = `
                <div style="width: 100%; height: 300px; background: #1a1a1a; border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid #333;">
                    <div style="text-align: center; color: #adb5bd;">
                        <div style="font-size: 16px; margin-bottom: 10px;">‚è≥ Loading Real Portfolio Data</div>
                        <div style="font-size: 14px; opacity: 0.7;">Fetching live OKX performance data...</div>
                    </div>
                </div>
            `;
            return;
        }

        console.log(`üìä Rendering ${chartData.length} data points:`, chartData);

        // Find min/max for scaling
        const values = chartData.map(d => d.value);
        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const range = Math.max(Math.abs(minVal), Math.abs(maxVal), 1);
        
        // Get chart container
        const chartContainer = document.getElementById('pnlChart');
        if (!chartContainer) {
            console.error('‚ùå Chart container pnlChart not found');
            return;
        }
        
        // Clear existing content
        chartContainer.innerHTML = '';
        
        // Create simple HTML chart
        chartContainer.innerHTML = `
            <div style="width: 100%; height: 300px; background: #1a1a1a; border-radius: 8px; padding: 20px; position: relative; border: 1px solid #333;">
                <div style="color: #adb5bd; font-size: 14px; margin-bottom: 15px; font-weight: 500;">
                    Portfolio P&L Performance
                </div>
                <div id="chartArea" style="width: 100%; height: 240px; position: relative; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 6px;">
                    <!-- Chart will be drawn here -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; color: #666;">
                    <span>${chartData[0]?.date || 'Start'}</span>
                    <span style="color: ${chartData[chartData.length - 1]?.value >= 0 ? '#4caf50' : '#f44336'};">
                        Current: ${chartData[chartData.length - 1]?.value.toFixed(2)}%
                    </span>
                    <span>${chartData[chartData.length - 1]?.date || 'Now'}</span>
                </div>
            </div>
        `;
        
        // Draw the line chart using CSS and divs
        const chartArea = document.getElementById('chartArea');
        const chartWidth = chartArea.offsetWidth - 40;
        const chartHeight = chartArea.offsetHeight - 40;
        
        // Add center line (0% line)
        const centerY = chartHeight / 2;
        chartArea.innerHTML += `
            <div style="position: absolute; left: 20px; right: 20px; top: ${centerY + 20}px; height: 1px; background: rgba(255,255,255,0.2); z-index: 1;"></div>
            <div style="position: absolute; left: 10px; top: ${centerY + 15}px; color: #666; font-size: 10px; z-index: 2;">0%</div>
        `;
        
        // Create path points
        const points = chartData.map((point, index) => {
            const x = 20 + (index / (chartData.length - 1)) * chartWidth;
            const normalizedValue = point.value / (range * 2); // Scale to -0.5 to 0.5
            const y = 20 + chartHeight / 2 - (normalizedValue * chartHeight * 0.8); // Invert Y and scale
            return { x, y, value: point.value, date: point.date };
        });
        
        // Draw line segments
        for (let i = 0; i < points.length - 1; i++) {
            const start = points[i];
            const end = points[i + 1];
            
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            chartArea.innerHTML += `
                <div style="
                    position: absolute;
                    left: ${start.x}px;
                    top: ${start.y}px;
                    width: ${length}px;
                    height: 2px;
                    background: linear-gradient(90deg, 
                        ${start.value >= 0 ? '#4caf50' : '#f44336'}, 
                        ${end.value >= 0 ? '#4caf50' : '#f44336'});
                    transform-origin: 0 0;
                    transform: rotate(${angle}deg);
                    z-index: 3;
                "></div>
            `;
        }
        
        // Add data points
        points.forEach(point => {
            chartArea.innerHTML += `
                <div style="
                    position: absolute;
                    left: ${point.x - 3}px;
                    top: ${point.y - 3}px;
                    width: 6px;
                    height: 6px;
                    background: ${point.value >= 0 ? '#4caf50' : '#f44336'};
                    border: 2px solid #1a1a1a;
                    border-radius: 50%;
                    z-index: 4;
                    cursor: pointer;
                " title="${point.date}: ${point.value.toFixed(2)}%"></div>
            `;
        });
        
        console.log('‚úÖ Simple HTML/CSS chart created successfully!');
    }

    async loadSignalData() {
        try {
            const response = await this.authenticatedFetch('/api/signal-tracking');
            const data = await response.json();
            
            if (data.success) {
                this.updateSignalsTable(data.recent_signals);
            }
        } catch (error) {
            console.error('‚ùå Error loading signal data:', error);
        }
    }

    async loadTradeData() {
        try {
            const response = await this.authenticatedFetch('/api/trade-performance');
            const data = await response.json();
            
            if (data.success && data.trade_summary) {
                this.updateTradeSummary(data.trade_summary);
                this.updateTradesTable(data.trades || []);
            } else {
                console.warn('‚ö†Ô∏è Trade performance data not available:', data.error || 'No trade summary');
                // Set fallback data
                this.updateTradeSummary({
                    total_trades: 0,
                    winning_trades: 0,
                    losing_trades: 0,
                    avg_pnl_percent: 0
                });
                this.updateTradesTable([]);
            }
        } catch (error) {
            console.error('‚ùå Error loading trade data:', error);
            // Set fallback data on error
            this.updateTradeSummary({
                total_trades: 0,
                winning_trades: 0,
                losing_trades: 0,
                avg_pnl_percent: 0
            });
            this.updateTradesTable([]);
        }
    }

    updateOverviewCards(data) {
        const metrics = data.portfolio_metrics;
        const signals = data.signal_metrics;

        document.getElementById('totalValue').textContent = `$${metrics.total_value.toLocaleString()}`;
        document.getElementById('totalPnl').textContent = `$${metrics.total_pnl.toLocaleString()}`;
        document.getElementById('totalPnl').className = `metric-value ${metrics.total_pnl >= 0 ? 'text-success' : 'text-danger'}`;
        const wr = Number(metrics.win_rate);
        document.getElementById('winRate').textContent = isFinite(wr) ? `${wr.toFixed(2)}%` : 'N/A';
        document.getElementById('mlAccuracy').textContent = `${signals.ml_accuracy}%`;
    }
    
    updateOverviewCardsWithAnimation(data) {
        const metrics = data.portfolio_metrics;
        const signals = data.signal_metrics;
        
        // Define the metrics data with animations
        const metricUpdates = [
            { 
                id: 'totalValue', 
                value: `$${metrics.total_value.toLocaleString()}`, 
                className: 'metric-value text-info' 
            },
            { 
                id: 'totalPnl', 
                value: `$${metrics.total_pnl.toLocaleString()}`, 
                className: `metric-value ${metrics.total_pnl >= 0 ? 'text-success' : 'text-danger'}` 
            },
            { 
                id: 'winRate', 
                value: (() => { const wr = Number(metrics.win_rate); return isFinite(wr) ? `${wr.toFixed(2)}%` : 'N/A'; })(), 
                className: 'metric-value text-warning' 
            },
            { 
                id: 'mlAccuracy', 
                value: `${signals.ml_accuracy}%`, 
                className: 'metric-value text-success' 
            }
        ];
        
        // Update each metric with staggered animations
        metricUpdates.forEach((metric, index) => {
            setTimeout(() => {
                this.updateMetricWithAnimation(metric.id, metric.value, metric.className);
            }, index * 150); // 150ms stagger
        });
    }
    
    updateMetricWithAnimation(elementId, value, className) {
        const element = document.getElementById(elementId);
        const parent = element?.closest('.metric-card');
        
        if (element && parent) {
            // Replace skeleton with actual value
            element.innerHTML = `<span style="opacity: 0; transform: translateY(10px); transition: all 0.5s ease;">${value}</span>`;
            element.className = className;
            
            // Trigger smooth animation
            requestAnimationFrame(() => {
                const span = element.querySelector('span');
                if (span) {
                    span.style.opacity = '1';
                    span.style.transform = 'translateY(0)';
                }
                
                parent.classList.remove('metric-loading');
                parent.classList.add('metric-loaded');
            });
        }
    }

    updateTopPerformers(performers) {
        const bestEl = document.getElementById('bestPerformer');
        const worstEl = document.getElementById('worstPerformer');

        // Handle both {best, worst} and {best_performer, worst_performer} structures
        const best = performers?.best || performers?.best_performer;
        const worst = performers?.worst || performers?.worst_performer;

        if (best && best.symbol) {
            // Guard against missing fields and ensure safe number conversion
            const pnlPercent = Number(best.pnl_percent) || 0;
            const pnlUsd = Number(best.pnl_usd || best.current_value) || 0;
            
            bestEl.innerHTML = `
                <h4 class="text-success">${best.symbol}</h4>
                <p class="text-success mb-1">+${pnlPercent.toFixed(2)}%</p>
                <p class="text-muted">$${pnlUsd.toFixed(2)}</p>
            `;
        } else {
            bestEl.innerHTML = '<p class="text-muted">No data</p>';
        }

        if (worst && worst.symbol) {
            // Guard against missing fields and ensure safe number conversion
            const pnlPercent = Number(worst.pnl_percent) || 0;
            const pnlUsd = Number(worst.pnl_usd || worst.current_value) || 0;
            
            worstEl.innerHTML = `
                <h4 class="text-danger">${worst.symbol}</h4>
                <p class="text-danger mb-1">${pnlPercent.toFixed(2)}%</p>
                <p class="text-muted">$${pnlUsd.toFixed(2)}</p>
            `;
        } else {
            worstEl.innerHTML = '<p class="text-muted">No data</p>';
        }
    }


    updateAllocationChart(data) {
        console.log('üìä Creating allocation chart from:', data);
        
        const container = document.getElementById('allocationChart');
        if (!container) {
            console.error('‚ùå Allocation chart container not found');
            return;
        }
        
        // Validate input and provide safe fallbacks
        if (!data || (!data.labels && !Array.isArray(data))) {
            console.warn('‚ö†Ô∏è No valid allocation data provided');
            container.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #adb5bd;">
                        <div style="font-size: 16px; margin-bottom: 10px;">üìä No Allocation Data</div>
                        <div style="font-size: 14px; opacity: 0.7;">Waiting for portfolio data...</div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Handle both {labels, values} and array formats
        let labels, values, colors;
        if (data.labels && Array.isArray(data.labels)) {
            labels = data.labels;
            values = data.values || [];
            colors = data.colors || [];
        } else if (Array.isArray(data)) {
            // Legacy array format - convert to new format
            labels = data.map(item => item.symbol || '');
            values = data.map(item => Number(item.percentage) || 0);
            colors = [];
        } else {
            // Invalid format
            container.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #dc3545;">
                        <div style="font-size: 16px;">‚ö†Ô∏è Invalid Data Format</div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Validate we have matching arrays
        if (!labels.length || labels.length !== values.length) {
            console.warn('‚ö†Ô∏è Mismatched allocation data arrays');
            container.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #adb5bd;">No allocation data available</div>
                </div>
            `;
            return;
        }
        
        // Default colors if not provided
        const defaultColors = ['#36A2EB', '#FF6384', '#4BC0C0', '#FF9F40', '#9966FF', '#FFCD56', '#FF6384', '#36A2EB', '#4BC0C0', '#FF9F40'];
        
        // Create simple HTML allocation display
        container.innerHTML = `
            <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; overflow-y: auto;">
                <div style="color: #adb5bd; font-size: 14px; margin-bottom: 15px; font-weight: 500;">Portfolio Allocation</div>
                ${labels.map((label, index) => {
                    const value = Number(values[index]) || 0;
                    const color = colors[index] || defaultColors[index % defaultColors.length];
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333;">
                            <span style="color: #fff; font-weight: 500;">${label || 'Unknown'}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 100px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${Math.min(100, Math.max(0, value))}%; height: 100%; background: ${color}; border-radius: 3px;"></div>
                                </div>
                                <span style="color: #adb5bd; font-size: 12px; min-width: 40px;">${value.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        console.log('‚úÖ Allocation chart created successfully!');
    }

    updateSignalAccuracyChart(data) {
        console.log('üìä Creating signal accuracy chart from:', data);
        
        const container = document.getElementById('signalAccuracyChart');
        if (!container) {
            console.error('‚ùå Signal accuracy chart container not found');
            return;
        }
        
        // Validate input and provide safe fallbacks
        if (!data) {
            console.warn('‚ö†Ô∏è No signal accuracy data provided');
            container.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #adb5bd;">
                        <div style="font-size: 16px; margin-bottom: 10px;">üéØ No Accuracy Data</div>
                        <div style="font-size: 14px; opacity: 0.7;">Waiting for signal data...</div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Handle both {labels, accuracy} and array formats
        let labels, accuracy;
        if (data.labels && data.accuracy && Array.isArray(data.labels) && Array.isArray(data.accuracy)) {
            labels = data.labels;
            accuracy = data.accuracy;
        } else if (Array.isArray(data)) {
            // Legacy array format - convert to new format
            labels = data.map(item => item.signal || item.signal_type || '');
            accuracy = data.map(item => Number(item.accuracy) || 0);
        } else {
            // Invalid format - show fallback
            container.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #dc3545;">
                        <div style="font-size: 16px;">‚ö†Ô∏è Invalid Accuracy Format</div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Calculate overall accuracy
        let overall_accuracy = 0;
        if (accuracy.length > 0) {
            overall_accuracy = accuracy.reduce((sum, acc) => sum + (Number(acc) || 0), 0) / accuracy.length;
        }
        
        // Create simple HTML signal accuracy display
        container.innerHTML = `
            <div style="padding: 20px; background: #1a1a1a; border-radius: 8px; height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div style="color: #adb5bd; font-size: 14px; margin-bottom: 20px; font-weight: 500;">Signal Accuracy</div>
                <div style="font-size: 3rem; font-weight: bold; color: ${overall_accuracy >= 70 ? '#28a745' : overall_accuracy >= 50 ? '#ffc107' : '#dc3545'}; margin-bottom: 15px;">
                    ${overall_accuracy.toFixed(1)}%
                </div>
                ${labels.length > 0 ? `
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px;">
                        ${labels.map((label, idx) => {
                            const acc = Number(accuracy[idx]) || 0;
                            const colors = ['#28a745', '#fd7e14', '#6c757d', '#dc3545'];
                            return `
                                <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: ${colors[idx % colors.length] || '#36A2EB'};">${acc.toFixed(1)}%</div>
                                    <div style="color: #adb5bd; font-size: 10px; text-transform: uppercase;">${label || 'Unknown'}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<div style="color: #666; font-size: 14px;">No accuracy data available</div>'}
            </div>
        `;
        console.log('‚úÖ Signal accuracy chart created successfully!');
    }

    updateSignalsTable(signals) {
        const tbody = document.getElementById('signalsTableBody');
        
        if (!tbody) {
            console.error('‚ùå Signals table body not found');
            return;
        }
        
        if (!signals || !Array.isArray(signals) || signals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No recent signals</td></tr>';
            return;
        }

        tbody.innerHTML = signals.map(signal => {
            // Guard against missing fields and provide safe defaults
            const symbol = signal.symbol || 'Unknown';
            const signalType = signal.signal || signal.signal_type || 'N/A';
            const hybridScore = Number(signal.hybrid_score || signal.confidence_score) || 0;
            const outcome = signal.outcome || 'PENDING';
            const pnlPercent = signal.pnl_percent !== null && signal.pnl_percent !== undefined 
                ? Number(signal.pnl_percent) 
                : null;
            
            return `
                <tr class="trade-row">
                    <td><strong>${symbol}</strong></td>
                    <td><span class="signal-badge signal-${signalType.toLowerCase()}">${signalType}</span></td>
                    <td>${hybridScore.toFixed(1)}%</td>
                    <td><span class="outcome-badge outcome-${outcome.toLowerCase()}">${outcome.replace('_', ' ')}</span></td>
                    <td class="${pnlPercent !== null ? (pnlPercent >= 0 ? 'text-success' : 'text-danger') : 'text-muted'}">
                        ${pnlPercent !== null ? pnlPercent.toFixed(2) + '%' : 'N/A'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    updateTradeSummary(summary) {
        if (!summary) {
            console.warn('‚ö†Ô∏è No trade summary data provided');
            return;
        }
        
        // Guard against missing elements and provide safe number conversion
        const totalTradesEl = document.getElementById('totalTrades');
        const winningTradesEl = document.getElementById('winningTrades');
        const losingTradesEl = document.getElementById('losingTrades');
        const avgPnlEl = document.getElementById('avgPnl');
        
        if (totalTradesEl) totalTradesEl.textContent = Number(summary.total_trades) || 0;
        if (winningTradesEl) winningTradesEl.textContent = Number(summary.winning_trades) || 0;
        if (losingTradesEl) losingTradesEl.textContent = Number(summary.losing_trades) || 0;
        
        if (avgPnlEl) {
            const avgPnl = Number(summary.avg_pnl_percent) || 0;
            avgPnlEl.textContent = `${avgPnl.toFixed(2)}%`;
            avgPnlEl.className = `metric-value ${avgPnl >= 0 ? 'text-success' : 'text-danger'}`;
        }
    }

    updateTradesTable(trades) {
        const tbody = document.getElementById('tradesTableBody');
        
        if (!tbody) {
            console.error('‚ùå Trades table body not found');
            return;
        }
        
        if (!trades || !Array.isArray(trades) || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No active trades</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => {
            // Guard against missing fields and ensure safe number conversions
            const symbol = trade.symbol || 'N/A';
            const entryPrice = Number(trade.entry_price) || 0;
            const currentPrice = Number(trade.current_price) || 0;
            const quantity = Number(trade.quantity) || 0;
            const currentValue = Number(trade.current_value) || 0;
            const pnl = Number(trade.pnl) || 0;
            const pnlPercent = Number(trade.pnl_percent) || 0;
            const status = trade.status || 'UNKNOWN';
            
            return `
                <tr class="trade-row">
                    <td><strong>${symbol}</strong></td>
                    <td>$${entryPrice.toFixed(4)}</td>
                    <td>$${currentPrice.toFixed(4)}</td>
                    <td>${quantity.toFixed(4)}</td>
                    <td>$${currentValue.toFixed(2)}</td>
                    <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">$${pnl.toFixed(2)}</td>
                    <td class="${pnlPercent >= 0 ? 'text-success' : 'text-danger'}">${pnlPercent.toFixed(2)}%</td>
                    <td><span class="badge ${status === 'WINNING' ? 'bg-success' : 'bg-danger'}">${status}</span></td>
                </tr>
            `;
        }).join('');
    }

    showRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.add('show');
    }

    hideRefreshIndicator() {
        document.getElementById('refreshIndicator').classList.remove('show');
    }

    startAutoRefresh() {
        setInterval(() => {
            this.loadAllData();
        }, this.refreshInterval);
        
        console.log(`üîÑ Auto-refresh started (${this.refreshInterval/1000}s interval)`);
    }
}

// Initialize dashboard immediately - force execution
console.log('üî• FORCE INIT: Starting dashboard initialization');


// Force immediate initialization with manual API call
try {
    console.log('üéØ Force initializing Trading Performance Dashboard');
    window.performanceDashboard = new TradingPerformanceDashboard();
    console.log('‚úÖ Dashboard created successfully');
    
    // IMMEDIATE API CALL FOR TESTING
    console.log('üöÄ FORCING IMMEDIATE API CALL');
    window.performanceDashboard.authenticatedFetch('/api/performance-overview')
        .then(response => response.json())
        .then(data => {
            console.log('üéØ FORCED API RESPONSE:', data);
            if (data.success && data.portfolio_metrics) {
                console.log('üî• FORCE UPDATING DOM');
                document.getElementById('totalValue').textContent = `$${data.portfolio_metrics.total_value.toLocaleString()}`;
                document.getElementById('totalPnl').textContent = `$${data.portfolio_metrics.total_pnl.toLocaleString()}`;
                document.getElementById('winRate').textContent = `${data.portfolio_metrics.win_rate}%`;
                document.getElementById('mlAccuracy').textContent = `${data.signal_metrics.ml_accuracy}%`;
                console.log('‚úÖ DOM FORCE UPDATE COMPLETE');
            }
        })
        .catch(error => console.error('‚ùå FORCE API FAILED:', error));
} catch (error) {
    console.error('‚ùå Dashboard initialization failed:', error);
}

// Also try DOMContentLoaded as backup
// üîß TRADING PERFORMANCE DEBUG FUNCTIONS
const TradingPerformanceDebug = {
    // Inspect performance state
    inspectState() {
        TradingDebug.log('üìà Trading Performance State Inspection');
        TradingDebug.inspectState('performance dashboard', window.performanceDashboard);
        TradingDebug.inspectState('charts', window.performanceDashboard?.charts);
        TradingDebug.inspectState('performance data', window.performanceDashboard?.performanceData);
    },
    
    // Debug performance loading
    async debugPerformance() {
        TradingDebug.log('üìà Testing performance loading...');
        try {
            if (window.performanceDashboard) {
                await window.performanceDashboard.loadAllData();
                TradingDebug.log('üìà Performance data loaded successfully');
                this.inspectState();
            } else {
                TradingDebug.log('Performance dashboard not initialized');
            }
        } catch (error) {
            TradingDebug.trackError(error, 'Performance Loading');
        }
    },
    
    // Test performance APIs
    async testAPIs() {
        TradingDebug.log('üìà Testing Performance APIs...');
        const endpoints = [
            '/api/trades',
            '/api/current-holdings',
            '/api/equity-curve',
            '/api/performance-charts'
        ];
        
        for (const endpoint of endpoints) {
            await TradingDebug.helpers.testAPI(endpoint);
        }
    },
    
    // Force refresh
    refreshPerformance() {
        TradingDebug.log('üìà Forcing performance refresh...');
        if (window.performanceDashboard) {
            window.performanceDashboard.loadAllData();
        }
    },
    
    // Analyze performance metrics
    analyzeMetrics() {
        if (!window.performanceDashboard?.performanceData) {
            TradingDebug.log('No performance data to analyze');
            return;
        }
        
        TradingDebug.log('üìà Performance Metrics Analysis:');
        console.group('üìà Performance Breakdown');
        console.log('Portfolio Value:', window.performanceDashboard.performanceData.totalValue);
        console.log('Total P&L:', window.performanceDashboard.performanceData.totalPnL);
        console.log('Win Rate:', window.performanceDashboard.performanceData.winRate);
        console.log('Active Positions:', window.performanceDashboard.performanceData.positions);
        console.groupEnd();
    }
};

// Add performance debug to global scope
window.tradingPerformanceDebug = TradingPerformanceDebug;

document.addEventListener('DOMContentLoaded', () => {
    console.log('üîÑ DOM loaded - backup initialization');
    if (!window.performanceDashboard) {
        try {
            window.performanceDashboard = new TradingPerformanceDashboard();
        } catch (error) {
            console.error('‚ùå Backup initialization failed:', error);
        }
    }
});
</script>
{% endblock %}
