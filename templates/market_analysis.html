{% extends "base_layout.html" %}

{% block title %}Market Analysis - Hybrid Trading Intelligence{% endblock %}
{% block page_title %}Market Analysis{% endblock %}
{% block page_subtitle %}Comprehensive analysis across 298+ OKX trading pairs with opportunity detection{% endblock %}

{% block extra_css %}
<style>
.market-overview {
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-dark));
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    border: 2px solid var(--border-color);
}

.market-stat {
    text-align: center;
    padding: 15px;
}

.stat-large {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 8px 0;
}

.opportunity-card {
    background: var(--primary-dark);
    border: 2px solid var(--success-green);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.opportunity-card:hover {
    border-color: var(--warning-orange);
    box-shadow: 0 6px 25px rgba(40, 167, 69, 0.2);
}

.signal-strength {
    width: 100%;
    height: 8px;
    background: var(--secondary-dark);
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}

.signal-fill {
    height: 100%;
    transition: width 0.8s ease;
    border-radius: 4px;
}

.market-filters {
    background: var(--primary-dark);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.pair-row {
    cursor: pointer;
    transition: all 0.3s ease;
}

.pair-row:hover {
    background-color: var(--accent-blue) !important;
}

.category-badge {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 12px;
}

.sortable {
    user-select: none;
    transition: background-color 0.2s ease;
}

.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

.sortable i {
    margin-left: 5px;
    transition: color 0.2s ease;
}

.sortable:hover i {
    color: #ffc107 !important;
}

/* Enhanced Professional Loading Animations */
.loading-skeleton {
    background: linear-gradient(90deg, 
        rgba(156, 163, 175, 0.1) 25%, 
        rgba(156, 163, 175, 0.2) 50%, 
        rgba(156, 163, 175, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
    height: 1.4em;
}

.loading-skeleton-stat {
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.1) 25%, 
        rgba(255, 255, 255, 0.3) 50%, 
        rgba(255, 255, 255, 0.1) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
    height: 2.2rem;
    width: 85%;
    margin: 8px auto;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.market-stat-loading {
    opacity: 0.7;
    transform: scale(0.98);
    transition: all 0.4s ease;
}

.market-stat-loaded {
    opacity: 1;
    transform: scale(1);
    animation: statPulse 0.6s ease-out;
}

@keyframes statPulse {
    0% { 
        opacity: 0;
        transform: scale(0.95) translateY(8px);
    }
    100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.market-status {
    font-size: 0.85rem;
    text-align: center;
    margin: 20px 0;
    padding: 10px 20px;
    border-radius: 25px;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 2px solid transparent;
}

.status-loading { 
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
    color: #f59e0b;
    border-color: rgba(245, 158, 11, 0.3);
}
.status-loaded { 
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.3);
}
.status-error { 
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.3);
}

.opportunities-loading {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 20px;
}

.opportunity-skeleton {
    background: rgba(255, 255, 255, 0.02);
    border: 1px dashed var(--border-color);
    border-radius: 12px;
    padding: 20px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 0.4; }
}

</style>
{% endblock %}

{% block content %}
<!-- Market Overview -->
<div class="market-overview">
    <div class="row">
        <div class="col-md-3">
            <div class="market-stat">
                <div class="stat-large text-white" id="totalPairs">
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="text-light">Trading Pairs</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="market-stat">
                <div class="stat-large text-success" id="buySignals">
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="text-light">BUY Signals</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="market-stat">
                <div class="stat-large text-warning" id="considerSignals">
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="text-light">CONSIDER Signals</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="market-stat">
                <div class="stat-large text-info" id="marketVolume">
                    <div class="loading-skeleton loading-skeleton-stat"></div>
                </div>
                <div class="text-light">24h Volume</div>
            </div>
        </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="market-status status-loading" id="market-status">
        <i class="fas fa-search fa-spin me-2"></i>Scanning 298+ trading pairs...
    </div>
</div>

<!-- Market Filters -->
<div class="market-filters">
    <div class="row align-items-center">
        <div class="col-md-3">
            <label for="categoryFilter" class="form-label">Filter by Category</label>
            <select class="form-select" id="categoryFilter" onchange="filterMarketData()">
                <option value="all">All Categories</option>
                <option value="large-cap">Large Cap (BTC, ETH)</option>
                <option value="mid-cap">Mid Cap</option>
                <option value="defi">DeFi Tokens</option>
                <option value="gaming">Gaming & Metaverse</option>
                <option value="meme">Meme Coins</option>
                <option value="layer1">Layer 1</option>
                <option value="layer2">Layer 2</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="signalFilter" class="form-label">Filter by Signal</label>
            <select class="form-select" id="signalFilter" onchange="filterMarketData()">
                <option value="all">All Signals</option>
                <option value="BUY">BUY Only</option>
                <option value="CONSIDER">CONSIDER Only</option>
                <option value="WAIT">WAIT Only</option>
                <option value="AVOID">AVOID Only</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="sortBy" class="form-label">Sort By</label>
            <select class="form-select" id="sortBy" onchange="sortMarketData()">
                <option value="signal_strength">Signal Strength</option>
                <option value="volume">24h Volume</option>
                <option value="price_change">Price Change</option>
                <option value="market_cap">Market Cap</option>
                <option value="alphabetical">Alphabetical</option>
            </select>
        </div>
        <div class="col-md-3">
            <div class="d-flex gap-2 mt-4">
                <button class="btn btn-primary" onclick="scanAllMarkets()">
                    <i class="fas fa-search me-1"></i>Scan All
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshMarketData()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Top Opportunities -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="data-card">
            <h5 class="card-title">
                <i class="fas fa-star text-warning"></i>
                Top Market Opportunities
                <span class="badge bg-success ms-2" id="opportunitiesCount">0</span>
            </h5>
            <div id="topOpportunities">
                <div class="text-center py-4">
                    <div class="loading-spinner text-warning" role="status">
                        <span class="visually-hidden">Scanning markets...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="data-card">
            <h5 class="card-title">
                <i class="fas fa-chart-bar text-info"></i>
                Market Sentiment
            </h5>
            <div class="text-center py-3">
                <div class="h2 text-success" id="marketSentiment">Bullish</div>
                <div class="text-muted-sm mb-3">Overall Market</div>
                <div class="row">
                    <div class="col-6">
                        <div class="h5 text-success" id="bullishCount">0</div>
                        <small>Bullish</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 text-danger" id="bearishCount">0</div>
                        <small>Bearish</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Trading Pairs Table -->
<div class="data-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="card-title mb-1">
                <i class="fas fa-globe"></i>
                All OKX Trading Pairs
                <span class="badge bg-primary ms-2" id="pairsCount">298</span>
            </h5>
            <small class="text-muted-xs">Real-time analysis across the complete OKX ecosystem</small>
        </div>
        <div>
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchPairs" placeholder="Search pairs..." onkeyup="searchPairs()">
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table-v02" style="--v02-head-bg: #6c7ae0;">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable(0, 'string')" style="cursor: pointer;">
                        Coin <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-0"></i>
                    </th>
                    <th class="sortable" onclick="sortTable(1, 'string')" style="cursor: pointer;">
                        Category <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-1"></i>
                    </th>
                    <th class="text-end sortable" onclick="sortTable(2, 'number')" style="cursor: pointer;">
                        Price <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-2"></i>
                    </th>
                    <th class="text-end sortable" onclick="sortTable(3, 'number')" style="cursor: pointer;">
                        24h Change <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-3"></i>
                    </th>
                    <th class="text-end sortable" onclick="sortTable(4, 'number')" style="cursor: pointer;">
                        24h Volume <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-4"></i>
                    </th>
                    <th class="text-center sortable" onclick="sortTable(5, 'string')" style="cursor: pointer;">
                        Hybrid Signal <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-5"></i>
                    </th>
                    <th class="text-center sortable" onclick="sortTable(6, 'number')" style="cursor: pointer;">
                        Signal Strength <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-6"></i>
                    </th>
                    <th class="text-center sortable" onclick="sortTable(7, 'number')" style="cursor: pointer;">
                        ML Confidence <i class="fas fa-sort" style="color: #9ca3af;" id="sort-fas fa-7"></i>
                    </th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="allPairsTable">
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="loading-spinner text-primary" role="status">
                            <span class="visually-hidden">Loading market data...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let marketData = [];
let filteredData = [];
let currentSort = { column: -1, direction: 'asc' };

async function loadMarketData() {
    try {
        console.log('üîÑ Loading market analysis with enhanced animations...');
        
        // Set all market stats to loading state
        const statElements = ['totalPairs', 'buySignals', 'considerSignals', 'marketVolume'];
        statElements.forEach(id => {
            const element = document.getElementById(id);
            const parent = element?.closest('.market-stat');
            if (parent) {
                parent.classList.add('market-stat-loading');
                parent.classList.remove('market-stat-loaded');
            }
        });
        
        // Update status indicator
        const statusElement = document.getElementById('market-status');
        if (statusElement) {
            statusElement.innerHTML = '<i class="fas fa-search fa-spin me-2"></i>Scanning 298+ trading pairs...';
            statusElement.className = 'market-status status-loading';
        }
        
        // Show professional loading for opportunities table
        const opportunitiesElement = document.getElementById('topOpportunities');
        if (opportunitiesElement) {
            opportunitiesElement.innerHTML = `
                <div class="opportunities-loading">
                    <div class="opportunity-skeleton">
                        <div class="loading-skeleton" style="width: 60%; height: 20px; margin-bottom: 10px;"></div>
                        <div class="loading-skeleton" style="width: 40%; height: 16px; margin-bottom: 8px;"></div>
                        <div class="loading-skeleton" style="width: 80%; height: 12px;"></div>
                    </div>
                    <div class="opportunity-skeleton">
                        <div class="loading-skeleton" style="width: 55%; height: 20px; margin-bottom: 10px;"></div>
                        <div class="loading-skeleton" style="width: 45%; height: 16px; margin-bottom: 8px;"></div>
                        <div class="loading-skeleton" style="width: 75%; height: 12px;"></div>
                    </div>
                    <div class="opportunity-skeleton">
                        <div class="loading-skeleton" style="width: 65%; height: 20px; margin-bottom: 10px;"></div>
                        <div class="loading-skeleton" style="width: 35%; height: 16px; margin-bottom: 8px;"></div>
                        <div class="loading-skeleton" style="width: 85%; height: 12px;"></div>
                    </div>
                </div>
            `;
        }
        
        showToast('Loading market analysis for 298+ trading pairs...', 'info');
        
        // Load available positions (contains market data)
        const response = await fetch('/api/available-positions');
        if (response.ok) {
            const data = await response.json();
            if (data.data && Array.isArray(data.data)) {
                marketData = data.data;
                filteredData = [...marketData];
                
                // Load authentic data with animations
                setTimeout(async () => {
                    updateMarketOverviewWithAnimation();
                    await updateTopOpportunities(); // Wait for ML signals
                    updateMarketTable();
                    
                    // Load ML signals for table rows (async background loading)
                    setTimeout(() => {
                        loadMLSignalsForTable();
                    }, 1000);
                    
                    // Update status to loaded
                    if (statusElement) {
                        setTimeout(() => {
                            const now = new Date();
                            statusElement.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Authentic market scan complete - Last updated: ' + now.toLocaleTimeString();
                            statusElement.className = 'market-status status-loaded';
                        }, 600);
                    }
                    
                    showToast('Authentic market data loaded successfully!', 'success');
                    console.log('‚úÖ Authentic market analysis loaded with animations');
                }, 500);
            } else {
                throw new Error('Invalid market data format');
            }
        } else {
            throw new Error('Failed to fetch market data');
        }
        
    } catch (error) {
        console.error('‚ùå Market data loading failed:', error);
        
        // Update status to error
        const statusElement = document.getElementById('market-status');
        if (statusElement) {
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error loading market data';
            statusElement.className = 'market-status status-error';
        }
        
        // AUTHENTIC DATA ONLY: No fallback to sample data
        document.getElementById('topOpportunities').innerHTML = 
            '<div class="text-center py-4"><div class="text-muted">AUTHENTIC DATA ONLY: Unable to load real OKX market data</div></div>';
        showToast('AUTHENTIC DATA ONLY: Real OKX market data required', 'error');
    }
}

// ‚ùå REMOVED: Sample data generation eliminated for authentic data integrity
// All market data must come from authentic OKX sources exclusively

function updateMarketOverview() {
    const buySignals = filteredData.filter(d => d.signal === 'BUY').length;
    const considerSignals = filteredData.filter(d => d.signal === 'CONSIDER').length;
    const totalVolume = filteredData.reduce((sum, d) => sum + parseFloat(d.volume_24h || 0), 0);
    
    document.getElementById('totalPairs').textContent = filteredData.length;
    document.getElementById('buySignals').textContent = buySignals;
    document.getElementById('considerSignals').textContent = considerSignals;
    document.getElementById('marketVolume').textContent = '$' + (totalVolume / 1000000).toFixed(1) + 'M';
    
    // Update market sentiment
    const bullish = filteredData.filter(d => ['BUY', 'CONSIDER'].includes(d.signal)).length;
    const bearish = filteredData.filter(d => d.signal === 'AVOID').length;
    
    document.getElementById('bullishCount').textContent = bullish;
    document.getElementById('bearishCount').textContent = bearish;
}

function updateMarketOverviewWithAnimation() {
    const buySignals = filteredData.filter(d => d.signal === 'BUY').length;
    const considerSignals = filteredData.filter(d => d.signal === 'CONSIDER').length;
    const totalVolume = filteredData.reduce((sum, d) => sum + parseFloat(d.volume_24h || 0), 0);
    
    // Define the stats data with animations
    const statUpdates = [
        { 
            id: 'totalPairs', 
            value: filteredData.length.toString(), 
            className: 'stat-large text-white' 
        },
        { 
            id: 'buySignals', 
            value: buySignals.toString(), 
            className: 'stat-large text-success' 
        },
        { 
            id: 'considerSignals', 
            value: considerSignals.toString(), 
            className: 'stat-large text-warning' 
        },
        { 
            id: 'marketVolume', 
            value: '$' + (totalVolume / 1000000).toFixed(1) + 'M', 
            className: 'stat-large text-info' 
        }
    ];
    
    // Update each stat with staggered animations
    statUpdates.forEach((stat, index) => {
        setTimeout(() => {
            updateStatWithAnimation(stat.id, stat.value, stat.className);
        }, index * 150); // 150ms stagger
    });
    
    // Update market sentiment (non-animated for now)
    const bullish = filteredData.filter(d => ['BUY', 'CONSIDER'].includes(d.signal)).length;
    const bearish = filteredData.filter(d => d.signal === 'AVOID').length;
    
    const bullishEl = document.getElementById('bullishCount');
    const bearishEl = document.getElementById('bearishCount');
    if (bullishEl) bullishEl.textContent = bullish;
    if (bearishEl) bearishEl.textContent = bearish;
}

function updateStatWithAnimation(elementId, value, className) {
    const element = document.getElementById(elementId);
    const parent = element?.closest('.market-stat');
    
    if (element && parent) {
        // Replace skeleton with actual value
        element.innerHTML = `<span style="opacity: 0; transform: translateY(10px); transition: all 0.5s ease;">${value}</span>`;
        element.className = className;
        
        // Trigger smooth animation
        requestAnimationFrame(() => {
            const span = element.querySelector('span');
            if (span) {
                span.style.opacity = '1';
                span.style.transform = 'translateY(0)';
            }
            
            parent.classList.remove('market-stat-loading');
            parent.classList.add('market-stat-loaded');
        });
    }
}
}

async function updateTopOpportunities() {
    // AUTHENTIC DATA ONLY: Load real ML signals for top opportunities
    if (!filteredData || filteredData.length === 0) {
        document.getElementById('topOpportunities').innerHTML = 
            '<div class="text-center py-4"><div class="text-muted">AUTHENTIC DATA ONLY: No real OKX market data available</div></div>';
        return;
    }
    
    // Get opportunities with authentic ML signals
    const opportunities = [];
    const topPairs = filteredData.slice(0, 20); // Process top 20 pairs for ML signals
    
    for (const pair of topPairs) {
        try {
            const signalResponse = await fetch(`/api/hybrid-signal?symbol=${pair.symbol}&price=${pair.current_price || pair.price}`);
            if (signalResponse.ok) {
                const signal = await signalResponse.json();
                if (signal.final_signal === 'BUY' || (signal.final_signal === 'CONSIDER' && signal.hybrid_score > 70)) {
                    opportunities.push({
                        symbol: pair.symbol,
                        pair: pair.pair || `${pair.symbol}-USDT`,
                        category: pair.category || 'crypto',
                        price: pair.current_price || pair.price,
                        change_24h: pair.change_24h || '0.00',
                        signal: signal.final_signal,
                        confidence: signal.hybrid_score || 0,
                        ml_probability: signal.ml_prediction ? signal.ml_prediction.confidence : 0
                    });
                }
            }
        } catch (error) {
            console.error(`Failed to get ML signal for ${pair.symbol}:`, error);
        }
        
        if (opportunities.length >= 10) break; // Limit to top 10 opportunities
    }
    
    document.getElementById('opportunitiesCount').textContent = opportunities.length;
    
    if (opportunities.length === 0) {
        document.getElementById('topOpportunities').innerHTML = 
            '<div style="color: #9ca3af;" class="text-center py-4">AUTHENTIC DATA ONLY: No high-confidence ML opportunities found</div>';
        return;
    }
    
    const html = opportunities.map(opp => `
        <div class="opportunity-card" onclick="analyzeOpportunity('${opp.symbol}')">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h6 class="mb-1"><strong>${opp.pair}</strong></h6>
                    <span class="category-badge bg-secondary">${opp.category}</span>
                </div>
                <div class="col-md-2">
                    <div class="text-end">
                        <div class="h6 mb-0">$${opp.price}</div>
                        <small class="${parseFloat(opp.change_24h) >= 0 ? 'text-success' : 'text-danger'}">
                            ${parseFloat(opp.change_24h) >= 0 ? '+' : ''}${opp.change_24h}%
                        </small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <span class="badge ${opp.signal === 'BUY' ? 'bg-success' : 'bg-warning'}">${opp.signal}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="signal-strength">
                        <div class="signal-fill ${opp.confidence > 75 ? 'bg-success' : 'bg-warning'}" 
                             style="width: ${opp.confidence}%"></div>
                    </div>
                    <small style="color: #9ca3af;">${opp.confidence.toFixed(1)}% confidence</small>
                </div>
                <div class="col-md-2">
                    <div class="text-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); analyzeOpportunity('${opp.symbol}')">
                            <i class="fas fa-chart-line me-1"></i>Analyze
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('topOpportunities').innerHTML = html;
}

function updateMarketTable() {
    const tbody = document.getElementById('allPairsTable');
    
    if (!filteredData || filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">AUTHENTIC DATA ONLY: No real OKX market data available</td></tr>';
        document.getElementById('pairsCount').textContent = '0';
        return;
    }
    
    document.getElementById('pairsCount').textContent = filteredData.length;
    
    // Show first 50 pairs for performance with authentic data validation
    const displayData = filteredData.slice(0, 50).filter(pair => {
        // Ensure we have valid OKX data
        return pair && (pair.current_price || pair.price) && pair.symbol;
    });
    
    tbody.innerHTML = displayData.map(pair => {
        // Use authentic OKX data only
        const price = pair.current_price || pair.price || '0.0000';
        const change = parseFloat(pair.change_24h || '0.00');
        const volume = pair.volume_24h || '0';
        const symbol = pair.symbol || 'UNKNOWN';
        const category = pair.category || 'crypto';
        
        // Signal and confidence will be loaded via ML system - show pending state
        const signalClass = 'bg-secondary';
        const signalText = 'PENDING';
        const confidence = 0;
        
        let categoryClass = 'bg-secondary';
        if (category === 'large-cap') categoryClass = 'bg-primary';
        else if (category === 'defi') categoryClass = 'bg-info';
        else if (category === 'gaming') categoryClass = 'bg-warning';
        else if (category === 'meme') categoryClass = 'bg-danger';
        
        return `
            <tr class="pair-row" onclick="analyzeOpportunity('${symbol}')">
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-coins me-2 text-warning"></i>
                        <strong>${symbol}</strong>
                    </div>
                </td>
                <td>
                    <span class="category-badge ${categoryClass}">${category}</span>
                </td>
                <td class="text-end">$${parseFloat(price).toFixed(4)}</td>
                <td class="text-end ${change >= 0 ? 'text-success' : 'text-danger'}">
                    ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                </td>
                <td class="text-end">$${parseInt(volume).toLocaleString()}</td>
                <td class="text-center">
                    <span class="badge ${signalClass}" id="signal-${symbol}">${signalText}</span>
                </td>
                <td class="text-center">
                    <div class="signal-strength mx-2">
                        <div class="signal-fill bg-secondary" style="width: 0%" id="confidence-${symbol}"></div>
                    </div>
                    <small id="confidence-text-${symbol}">ML Loading...</small>
                </td>
                <td class="text-center">
                    <small id="ml-prob-${symbol}">ML Loading...</small>
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); analyzeOpportunity('${symbol}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    if (filteredData.length > 50) {
        tbody.innerHTML += `
            <tr>
                <td colspan="9" class="text-center py-3" style="color: #9ca3af;">
                    Showing first 50 authentic OKX pairs of ${filteredData.length} total. Use filters to narrow results.
                </td>
            </tr>
        `;
    }
}

async function loadMLSignalsForTable() {
    // Load ML signals for visible table rows (background loading)
    const displayData = filteredData.slice(0, 20); // Load ML for first 20 rows
    
    for (const pair of displayData) {
        try {
            const signalResponse = await fetch(`/api/hybrid-signal?symbol=${pair.symbol}&price=${pair.current_price || pair.price}`);
            if (signalResponse.ok) {
                const signal = await signalResponse.json();
                updateTableRowSignal(pair.symbol, signal);
            }
        } catch (error) {
            console.error(`Failed to load ML signal for ${pair.symbol}:`, error);
            // Update row to show ML unavailable
            const signalEl = document.getElementById(`signal-${pair.symbol}`);
            const confidenceTextEl = document.getElementById(`confidence-text-${pair.symbol}`);
            const mlProbEl = document.getElementById(`ml-prob-${pair.symbol}`);
            
            if (signalEl) signalEl.textContent = 'WAIT';
            if (confidenceTextEl) confidenceTextEl.textContent = 'ML N/A';
            if (mlProbEl) mlProbEl.textContent = 'N/A';
        }
    }
}

function updateTableRowSignal(symbol, signal) {
    const signalEl = document.getElementById(`signal-${symbol}`);
    const confidenceEl = document.getElementById(`confidence-${symbol}`);
    const confidenceTextEl = document.getElementById(`confidence-text-${symbol}`);
    const mlProbEl = document.getElementById(`ml-prob-${symbol}`);
    
    if (signalEl && signal.final_signal) {
        signalEl.textContent = signal.final_signal;
        let signalClass = 'bg-secondary';
        if (signal.final_signal === 'BUY') signalClass = 'bg-success';
        else if (signal.final_signal === 'CONSIDER') signalClass = 'bg-warning';
        else if (signal.final_signal === 'AVOID') signalClass = 'bg-danger';
        signalEl.className = `badge ${signalClass}`;
    }
    
    const confidence = signal.hybrid_score || 0;
    if (confidenceEl) {
        confidenceEl.style.width = `${confidence}%`;
        confidenceEl.className = `signal-fill ${confidence > 75 ? 'bg-success' : confidence > 60 ? 'bg-warning' : 'bg-secondary'}`;
    }
    
    if (confidenceTextEl) {
        confidenceTextEl.textContent = `${confidence.toFixed(0)}%`;
    }
    
    if (mlProbEl && signal.ml_prediction) {
        mlProbEl.textContent = `${(signal.ml_prediction.confidence * 100).toFixed(0)}%`;
    }
}

function filterMarketData() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const signalFilter = document.getElementById('signalFilter').value;
    
    filteredData = marketData.filter(pair => {
        const categoryMatch = categoryFilter === 'all' || pair.category === categoryFilter;
        const signalMatch = signalFilter === 'all' || pair.signal === signalFilter;
        return categoryMatch && signalMatch;
    });
    
    updateMarketOverview();
    updateTopOpportunities();
    updateMarketTable();
}

function sortMarketData() {
    const sortBy = document.getElementById('sortBy').value;
    
    filteredData.sort((a, b) => {
        switch (sortBy) {
            case 'signal_strength':
                return b.confidence - a.confidence;
            case 'volume':
                return parseFloat(b.volume_24h) - parseFloat(a.volume_24h);
            case 'price_change':
                return parseFloat(b.change_24h) - parseFloat(a.change_24h);
            case 'alphabetical':
                return a.pair.localeCompare(b.pair);
            default:
                return 0;
        }
    });
    
    updateMarketTable();
}

function searchPairs() {
    const searchTerm = document.getElementById('searchPairs').value.toLowerCase();
    
    if (searchTerm === '') {
        filteredData = [...marketData];
    } else {
        filteredData = marketData.filter(pair => 
            pair.pair.toLowerCase().includes(searchTerm) ||
            pair.symbol.toLowerCase().includes(searchTerm)
        );
    }
    
    updateMarketOverview();
    updateMarketTable();
}

function clearSearch() {
    document.getElementById('searchPairs').value = '';
    filteredData = [...marketData];
    updateMarketOverview();
    updateMarketTable();
}

function analyzeOpportunity(symbol) {
    window.location.href = `/signals-ml?symbol=${symbol}`;
}

async function scanAllMarkets() {
    showToast('Scanning all 298+ markets for opportunities...', 'info');
    
    // Add scanning animation
    document.getElementById('topOpportunities').innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner text-warning" role="status">
                <span class="visually-hidden">Scanning markets...</span>
            </div>
            <div class="mt-2">Analyzing hybrid signals across all trading pairs...</div>
        </div>
    `;
    
    // Authentic market scan with real OKX data
    try {
        await loadMarketData();
        showToast('Authentic market scan completed with real OKX data!', 'success');
    } catch (error) {
        console.error('Authentic market scan failed:', error);
        showToast('AUTHENTIC DATA ONLY: Market scan requires real OKX data', 'error');
        document.getElementById('topOpportunities').innerHTML = 
            '<div class="text-center py-4"><div class="text-muted">AUTHENTIC DATA ONLY: Real OKX market scan failed</div></div>';
    }
}

async function refreshMarketData() {
    await loadMarketData();
}

// Table sorting functionality
function sortTable(columnIndex, dataType) {
    // Toggle sort direction if clicking the same column
    if (currentSort.column === columnIndex) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnIndex;
        currentSort.direction = 'asc';
    }
    
    // Update sort icons
    updateSortIcons(columnIndex, currentSort.direction);
    
    // Sort the filtered data
    filteredData.sort((a, b) => {
        let aVal, bVal;
        
        switch (columnIndex) {
            case 0: // Coin
                aVal = a.symbol || '';
                bVal = b.symbol || '';
                break;
            case 1: // Category
                aVal = a.category || '';
                bVal = b.category || '';
                break;
            case 2: // Price
                aVal = parseFloat(a.price) || 0;
                bVal = parseFloat(b.price) || 0;
                break;
            case 3: // 24h Change
                aVal = parseFloat(a.change_24h) || 0;
                bVal = parseFloat(b.change_24h) || 0;
                break;
            case 4: // 24h Volume
                aVal = parseFloat(a.volume_24h) || 0;
                bVal = parseFloat(b.volume_24h) || 0;
                break;
            case 5: // Hybrid Signal
                const signalOrder = { 'BUY': 4, 'CONSIDER': 3, 'WAIT': 2, 'AVOID': 1 };
                aVal = signalOrder[a.signal] || 0;
                bVal = signalOrder[b.signal] || 0;
                break;
            case 6: // Signal Strength
                aVal = parseFloat(a.confidence) || 0;
                bVal = parseFloat(b.confidence) || 0;
                break;
            case 7: // ML Confidence
                aVal = parseFloat(a.ml_probability) || 0;
                bVal = parseFloat(b.ml_probability) || 0;
                break;
            default:
                return 0;
        }
        
        if (dataType === 'number') {
            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        } else {
            if (currentSort.direction === 'asc') {
                return aVal.toString().localeCompare(bVal.toString());
            } else {
                return bVal.toString().localeCompare(aVal.toString());
            }
        }
    });
    
    // Re-render the table
    updateMarketTable();
}

function updateSortIcons(activeColumn, direction) {
    // Reset all icons
    for (let i = 0; i < 8; i++) {
        const icon = document.getElementById(`sort-fas fa-${i}`);
        if (icon) {
            icon.className = 'fas fa-sort';
            icon.style.color = '#9ca3af';
        }
    }
    
    // Set active icon
    const activeIcon = document.getElementById(`sort-fas fa-${activeColumn}`);
    if (activeIcon) {
        if (direction === 'asc') {
            activeIcon.className = 'fas fa-sort-up text-white';
        } else {
            activeIcon.className = 'fas fa-sort-down text-white';
        }
    }
}

// Page-specific refresh function
window.refreshPageData = async function() {
    await loadMarketData();
};

// Initialize page
// üîß MARKET ANALYSIS DEBUG FUNCTIONS
const MarketAnalysisDebug = {
    // Inspect market state
    inspectState() {
        TradingDebug.log('üìà Market Analysis State Inspection');
        TradingDebug.inspectState('market data', window.marketData);
        TradingDebug.inspectState('filtered data', window.filteredMarketData);
        TradingDebug.inspectState('opportunities', window.topOpportunities);
    },
    
    // Debug market loading
    async debugMarket() {
        TradingDebug.log('üìà Testing market loading...');
        try {
            await loadMarketData();
            TradingDebug.log('üìà Market data loaded successfully');
            this.inspectState();
        } catch (error) {
            TradingDebug.trackError(error, 'Market Loading');
        }
    },
    
    // Test market APIs
    async testAPIs() {
        TradingDebug.log('üìà Testing Market APIs...');
        const endpoints = [
            '/api/available-positions',
            '/api/current-holdings',
            '/api/hybrid-signal?symbol=BTC&price=114200'
        ];
        
        for (const endpoint of endpoints) {
            await TradingDebug.helpers.testAPI(endpoint);
        }
    },
    
    // Force scan all markets
    forceScan() {
        TradingDebug.log('üìà Forcing market scan...');
        scanAllMarkets();
    },
    
    // Debug filters
    debugFilters() {
        TradingDebug.log('üìà Filter Debug:');
        const categoryFilter = document.getElementById('categoryFilter');
        const sortBy = document.getElementById('sortBy');
        
        console.log('Category Filter:', categoryFilter?.value);
        console.log('Sort By:', sortBy?.value);
    }
};

// Add market debug to global scope
window.marketAnalysisDebug = MarketAnalysisDebug;

document.addEventListener('DOMContentLoaded', function() {
    loadMarketData();
    
    // Auto-refresh every 5 minutes
    setInterval(loadMarketData, 300000);
});
</script>
{% endblock %}